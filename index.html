<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nurvle</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/json.min.js"></script>
<script>
window.MathJax = {
  tex: {
    inlineMath: [['$', '$']],
    displayMath: [['$$', '$$']]
  },
  svg: {
    fontCache: 'global'
  }
};
</script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>
<script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
<script>
    let CONFIG = {
    APPWRITE_ENDPOINT: "",
    APPWRITE_PROJECT_ID: "",
    APPWRITE_BUCKET_ID: "",
    APPWRITE_DATABASE_ID: "",
    APPWRITE_COLLECTION_ID: "",
    SERPAPI_KEY: "",
    GEMINI_MODEL: ""
};
    
async function loadConfig() {
    try {
        const response = await fetch('https://gist.githubusercontent.com/abubakar-shamsu/4f8aa8e91dbb40488bc05dc2c5696d53/raw/configs.json?_=${Date.now()}');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const responseText = await response.text();
        console.log("Raw config response:", responseText);
        
        const configData = JSON.parse(responseText);
        
        CONFIG = { ...CONFIG, ...configData };
        
        console.log("Configuration loaded successfully from external URL");
        return true;
    } catch (error) {
        console.error("Error loading configuration:", error);
        console.error("Error details:", error.message);
        appendMessage("Error loading configuration from external source.", 'bot-msg error-message');
        return false;
    }
}
</script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
@import url('https://fonts.googleapis.com/css2?family=Audiowide&display=swap');
:root{
    --body-color: #FFFFFF;
    --basic-color: white;
    --basic-reverse-color: #1a1a1a;
    --user-msg: #F1F1F1;
    --chatinputareabg: #E8E8E8;
    --chatinputareabg_recording: #E8E8E8;
    --chatinputareabrd: #ccc;
    --codeinputareabrd: #E2E8F0;
    --codecontainer: #f8fafc;
    --codecontainercolor: #1E293B;
    --codeheaderbg: rgba(0, 0, 0, 0.05);
    --codeheadercolor: #64748B;
    --plus-btn-bg: #FFFFFF0D;
    --svgcolor: black;
    --svgborder: #FFFFFF33;
    --sidebarbg: #f1f1f1;
    --conversation-item-bg: #fff;
    --border-right-color: #FFFFFF24;
    --conversation-itemactive-background-color: #7777773B;
    --sidebarborderright: #FFFFFF00;
    --chatareabtn: #FFFFFF;
    --chatinputareabtnbg: white;
    --conversation-item-border: #ddd;
    --inputPlaceHolder: #666;
    --homeGreetingBorder: #51525726;
    --response-color: #000000;
    --custom_modal_content: white;
    --custom_modal_color: gray;
    --auth-primary: #4f46e5;
    --auth-primary-hover: #4338ca;
    --auth-secondary: #6b7280;
    --auth-secondary-hover: #4b5563;
    --auth-background: #ffffff;
    --auth-text: #1f2937;
    --auth-border: #d1d5db;
    --auth-success: #10b981;
    --auth-error: #ef4444;
    --auth-padding: 0.75rem;
    --auth-radius: 0.5rem;
    --auth-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --cancel_btn_border: #00000036;
    --code_block_back_ground: #F8FAFC;
    --codes_color_basic: #0D0D0D;
}
body.dark-theme {
    --body-color: black;
    --basic-color: black;
    --cancel_btn_border: #FFFFFF4D;
    --basic-reverse-color: white;
    --user-msg: #FFFFFF2B;
    --chatinputareabg: #111111;
    --chatinputareabg_recording: #000000;
    --chatinputareabrd: #FFFFFF24;
    --codeinputareabrd: #FFFFFF24;
    --codecontainercolor: #F6F6F6;
    --codeheaderbg: rgba(177, 177, 177, 0.13);
    --codeheadercolor: #aaa;
    --plus-btn-bg: #FFFFFF0D;
    --svgcolor: #ccc;
    --conversation-itemactive-background-color: #E0E0E04A;
    --sidebarborderright: #FFFFFF24;
    --chatareabtn: #FFFFFF33;
    --chatinputareabtnbg: #FFFFFF0D;
    --sidebarbg: black;
    --conversation-item-bg: #FFFFFF17;
    --conversation-item-border: #FFFFFF24;
    --inputPlaceHolder: #ddd;
    --homeGreetingBorder: #FFFFFF1A;
    --response-color: #FFFFFFCF;
    --custom_modal_content: #333333;
    --custom_modal_color: whitesmoke;
    --auth-text: white;
    --code_block_back_ground: #00000085;
    --codes_color_basic: #EDEDEDED;
}
.title, .home-greeting h2, .home-greeting img, .home-greeting p, #userInput::placeholder {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
::selection {
    background: #C0B531;
    color: white;
}
::-moz-selection {
    background: #C0B531;
    color: white;
}
.code-container ::selection {
    background: #C0B531;
    color: white;
}
.code-container ::-moz-selection {
    background: #C0B531;
    color: white;
}
    body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            background: var(--body-color);
            font-family: ui-sans-serif, -apple-system, system-ui, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol";
            transition: all 0.5s ease;
        } .app-header {
      display:flex; align-items:center; justify-content:space-between;
      height:38px;
      padding:0 16px;
      background: var(--basic-color);
      z-index: 99;
      font-family: "Audiowide", sans-serif;
      transition: all 0.5s ease;
    } .app-header .material-symbols-rounded {
      font-size: 28px;
      color: #444;
      cursor:pointer;
      transition: all 0.5s ease;
    }  .app-header .title {
      font-weight:550;
      font-size:18px;
      color: var(--basic-reverse-color);font-family: "Audiowide", sans-serif;
      transition: all 0.5s ease;
    }   #response {
    flex: 2;
    overflow-y: auto;
    padding: 12px;
    background: var(--body-color);
    color: var(--response-color);
    transition: all 0.5s ease;
    margin: 0 auto;
    width: 100%;
    max-width: 750px;
} .chat-bubble {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 80%;
            white-space: wrap;
        } .user-msg {
    background-color: var(--user-msg);
    align-self: flex-end;
    margin-left: auto;
    transition: all 0.5s ease;
    max-width: 80%;
    white-space: pre-wrap;
    word-break: break-word;
    display: flex;
    flex-direction: column;
    gap: 8px;
    color: var(--response-color);
}
.user-msg::-webkit-scrollbar {
    height: 5px;
} .user-msg::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 5px;
} .bot-msg {
    background-color: transparent;
    align-self: flex-start;
    margin-right: auto;
    max-width: 95%;
    padding: 10px 0;
    border-radius: 0;
    margin-left: 2.5%;
    transition: all 0.5s ease;
    color: var(--response-color);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
.user-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 12px;
    object-fit: contain;
    margin-bottom: 8px;
}
#chatInputArea {
    position: relative;
    align-self: center;
    justify-self: center;
    width: 700px;
    max-width: 90%;
    min-height: 95px;
    padding: 10px;
    backdrop-filter: blur(150px);
    background-color: var(--chatinputareabg);
    border: 1px solid var(--chatinputareabrd);
    border-radius: 26px;
    bottom: 14px;
    transition: all 0.5s ease;
    display: flex;
    flex-direction: column;
}
#chatInputArea.recording-mode {
  background: linear-gradient(var(--chatinputareabg_recording), var(--chatinputareabg_recording)) padding-box,
        conic-gradient(
            from var(--angle, 0),
            transparent 0%,
            silver 5%, 
            transparent 10% 
          ) border-box;
}

@keyframes spinButton {
  to {
    --angle: 360;
  }
}
.input-container {
    display: flex;
    flex-direction: column;
    flex: 1;
    position: relative;
}
#userInput {
    width: 100%;
    min-height: 40px;
    max-height: 200px;
    padding: 10px 15px;
    padding-right: 50px;
    border: none;
    outline: none;
    background: transparent;
    color: var(--basic-reverse-color);
    resize: none;
    overflow-y: auto;
    font-family: inherit;
    font-size: inherit;
    line-height: 1.5;
    box-sizing: border-box;
    margin-bottom: 10px;
}
#userInput::placeholder {
    color: var(--inputPlaceHolder);
}
.buttons-container {
    display: flex;
    align-items: center;
    gap: 10px;
    position: relative;
    height: 33px;
}
#sendBtn, #mic-btn {
    position: absolute;
    right: 0;
}

#mic-btn svg {
    width: 23px;
    height: 23px;
}
#userInput::placeholder {
    color: var(--inputPlaceHolder);
}
#sendBtn, #mic-btn {
    transition: all 0.1s ease;
}
#camera-btn{
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 2px 5px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    color: var(--basic-reverse-color);
}
#camera-btns {
border: none;
fill: var(--basic-reverse-color);
background-color: #71717124;
padding: 8px;
border: none;
border-radius: 15px;
}
#camera-btn svg{
    width: 26px;
    height: 26px;
}

#camera-btns:focus {
    outline: none;
}

#sendBtn.hidden {
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
}

#mic-btn.hidden {
    opacity: 0;
    visibility: hidden;
    transform: scale(0.8);
}

#sendBtn:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
}

#mic-btn:not(.hidden) {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
}
#sendBtn {
    position: absolute;
    right: 2px;
    bottom: -2px;
    margin-left: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background:var(--basic-reverse-color);
    padding: 7px 7px;
    border-radius: 20px;
    border: none;
    fill: var(--basic-color);
    outline: none;
}
        #sendBtn svg{
            width: 24px;
            height: 24px;
            fill: var(--basic-color);
        }
.code-container code {
 background-color: var(--code_block_back_ground) !important;
    color: var(--codes_color_basic) !important;
}
.hljs {
    display: block;
    overflow-x: auto;
    background: transparent !important;
    padding: 0 !important;

}
        .code-container {
    position: relative;
    margin-top: 10px;
    border-radius: 8px;
    background-color: var(--code_block_back_ground) !important;
    border: 1px solid var(--codeinputareabrd);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background-color: var(--codeheaderbg);
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
    color: var(--codeheadercolor);
    font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
    font-size: 13px;
    font-weight: 500;
}
.copy-btn i {
    font-size: 12px;
    width: 12px;
    height: 12px;
}
.fa-times {
    color: #F44336;
}	.copy-btn {
    background: none;
    border: none;
    color: var(--codeheadercolor);
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 1px;
    padding: 3px 8px;
    border-radius: 4px;
    transition: all 0.3s ease;
}
    .copy-btn:focus{
    outline: none;
    }
    .copy-btn:active {
    color: var(--basic-reverse-color);
        }

.code-container pre {
    margin: 0;
    padding: 16px;
    overflow-x: auto;
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    background-color: transparent !important;
}
        #menu-btn{
           transition: all 0.5s ease;
        }
#camera-btn:focus{
    outline: none;
}
#mic-btn {
    position: absolute;
    right: 2px;
    bottom: -2px;
    margin-left: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    background:var(--basic-reverse-color);
    padding: 7px 7px;
    border-radius: 20px;
    border: none;
    fill: var(--basic-color);
    outline: none;
}
#mic-btn:active{
    background: var(--basic-reverse-color);
    fill: var(--basic-color);
}
#mic-btn:focus{
    outline: none;
}
#mic-btn svg{
    width: 23px;
    height: 23px;
}
#mic-btn.recording {
  background: var(--basic-color);
  fill: var(--basic-reverse-color);
  animation: pulse 1.5s infinite;
  transition all 0.5s ease;
}
@keyframes pulse {
  0% {
      border: 2px solid var(--basic-reverse-color);
  }
  100% { 
      border: 2px solid var(--svgcolor);
      fill: var(--basic-reverse-color)
      transition all 0.5s ease;
  }
}
#userInput {
  flex: 1;
  padding: 5px;
  padding-left: 5px;
  border: none;
  outline: none;
  box-shadow: none;
}
#userInput:focus {
  box-shadow: none;
}
.home-greeting { display:flex; flex-direction:column; align-items:center; justify-content:center; height:calc(100vh - 2rem); text-align:center; color:var(--basic-reverse-color); padding:20px;transition: all 0.5s; ease;background: var(--body-color); }
.home-greeting img {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    margin-bottom: 20px;
    border: 2px solid var(--homeGreetingBorder);
    transition: all 0.5s ease;
}
.home-greeting h2 { margin-bottom:10px; font-size: 27px; font-family: Arial, Helvetica, sans-serif; }
.dark-theme .home-greeting img {
    content: url('https://i.ibb.co/23FTF2dZ/image-6.png');
}
.overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .sidebar {
            position: fixed;
            left: -80vw;
            height: 100vh;
            width: 80vw;
            max-width: 400px;
            background: var(--sidebarbg);
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 1000;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            
            border: 1px solid;
            border-color: transparent;
            border-right-color: var(--sidebarborderright);
            scroll-behavior: smooth;
            transition: all 0.5s ease;
        }
        .sidebar.open {
            transform: translateX(80vw);
        }
        #conversation-list {
            padding: 10px;
            margin-top: 0px;
            overflow-y: auto;
            height: calc(100vh - 200px);
            transition: all 0.5s ease;
        }
        .conversation-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: var(--conversation-item-bg);
            border: none;
            transition: all 0.5s ease;
        }
        .conversation-item:hover {
            position: relative;
        }
        .conversation-item.active {
            background-color: var(--conversation-itemactive-background-color);
            border-color: #aaa;
        } .conversation-item.active .conversation-preview{
            color: var(--basic-reverse-color);
        }
        .conversation-item.active {
            color: var(--basic-reverse-color);
        }
        #new-chat-btn {
            width: 38px;
            height: 38px;
            border: none;
            border-radius: 5px;
            position: absolute;
            font-weight: bold;
            transition: all 0.5s;
            position: relative;
display: flex;
padding: 0;
background-color: transparent;
fill: var(--basic-reverse-color);
right: -10px;
top: 2px;
color: var(--basic-reverse-color);
align-items: center;
justify-content: center;
cursor: grab;
cursor: -moz-grab;
cursor: -webkit-grab;
        }
        #new-chat-btn:active {
            scale: 0.95;
        }
        #new-chat-btn:focus{
            outline: none;
        }
        .conversation-title {
            font-size: 13px;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--basic-reverse-color);
        }
        .conversation-preview {
            font-size: 0.8em;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .conversation-date {
            font-size: 0.7em;
            color: #999;
            text-align: right;
        }
        .delete-conversation {
            position: absolute;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px 6px;
            border-radius: 50%;
            display: none;
            top: -5px;
            right: -5px;
            transition: all 0.5s;
        }
        .delete-conversation:hover {
            position: absolute;
            background: #BFC1D263;
            border: none;
            cursor: pointer;
            padding: 5px 6px;
            border-radius: 50%;
            top: -5px;
            right: -5px;
        }
        .delete-conversation svg{
            width: 24px;
            height: 24px;
            fill: var(--basic-reverse-color);
            transition: 0.3s;
        }
        .delete-conversation svg:active{
            fill: red;
        }
        .delete-conversation:focus{
            outline: none;
        }
        .conversation-item:hover .delete-conversation {
            position: absolute;
            top: 10px;
            right: 10px;
            display: block;
        }
        .thinking-animation {
            display: flex;
            gap: 5px;
            padding: 10px 15px;
        }
        .thinking-dot {
            width: 8px;
            height: 8px;
            background-color: var(--basic-reverse-color);
            border-radius: 50%;
            animation: thinking 1.4s infinite ease-in-out;
        }
        .thinking-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        .thinking-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        #sendBtn:disabled {
    background-color: #cccccc !important;
    cursor: not-allowed;
}
        #sendBtn:disabled svg {
    color: #888888 !important;
    fill: #888888 !important;
}
        #theme-button{
            width: 40px;
height: 40px;
padding: 5px 5px;
background-color: transparent;
border: none;
border-radius: 50%;
cursor: pointer;
left: 100%;
top: 7px;
position: sticky;
font-weight: bold;
transition: all 0.5s;
fill: var(--basic-reverse-color);
color: var(--basic-reverse-color);
align-items: center;
justify-content: center;
cursor: grab;
cursor: -moz-grab;
cursor: -webkit-grab;
}
#theme-button:focus{
    outline: none;
}
#theme-button svg{
    width: 26px;
    height: 26px;
    transition: 0.5s;
}
#theme-button svg:last-child{
    display: none;
}
.dark-theme #theme-button svg:first-child{
    display: none;
}
.dark-theme #theme-button svg:last-child{
    display: block;
}
.calendar {
    font-family: monospace;
    border-collapse: collapse;
    margin: 10px 0;
    width: 100%;
}
.calendar th {
    background-color: #f1f1f1;
    padding: 5px;
    text-align: center;
}
.calendar td {
    border: 1px solid #ddd;
    padding: 5px;
    text-align: center;
}
.calendar .today {
    background-color: #938C3A;
    color: white;
    font-weight: bold;
}
.dark-theme .calendar th {
    background-color: #333;
}
.dark-theme .calendar td {
    border-color: #555;
}
.dark-theme .calendar .today {
    background-color: #938C3A;
}
#imageInput, #fileInput, #audioInput {
    display: none;
}

.preview-container {
    display: none;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 10px;
    max-height: 150px;
    overflow-y: auto;
    padding: 5px;
    border-radius: 8px;
    background: transparent;
}
.preview-item {
    position: relative;
    width: 45px;
    height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--chatinputareabg);
    border-radius: 5px;
    padding: 8px;
    transition: all 0.3s ease;
    border: 1px solid var(--chatinputareabrd);
}
.preview-item:hover {
    transform: translateY(0px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.file-icon {
    font-size: 35px;
    margin-bottom: 0px;
}
.file-name {
    font-size: 5px;
    text-align: center;
    word-break: break-all;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    color: var(--basic-reverse-color);
    width: 100%;
}
.remove-file {
    position: absolute;
    top: -5px;
    right: -8px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 15px;
    height: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    z-index: 1;
}
.file-type-zip { color: #F44336; }
.file-type-pdf { color: #E91E63; }
.file-type-doc { color: #2196F3; }
.file-type-xls { color: #4CAF50; }
.file-type-ppt { color: #FF9800; }
.file-type-txt { color: #9E9E9E; }
.file-type-audio { color: #673AB7; }
.file-type-video { color: #3F51B5; }
.file-type-img { color: #1CB5C8; }
.file-type-default { color: #607D8B; }
#attachButton{
     position: absolute;
     bottom: -2px;
     left: -1px;
  background: var(--chatinputareabtnbg);
  fill: var(--svgcolor);
  border: 1px solid var(--chatareabtn);
  font-size: 20px;
  border-radius: 50px;
  cursor: pointer;
  padding: 2.5px 8.5px;
  transition: all 0.2s ease;
  align-items: center;
  justify-content: center;
}
#attachButton:focus{
    outline: none;
}
#attachButton:active{
    scale: 0.99;
}
.file-limit-popup {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background-color: #ff4444;
    color: white;
    padding: 10px 30px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    animation: fadeInOut 3s forwards;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 10px;
}
.file-limit-popup svg {
    width: 50px;
    height: 50px;
    fill: white;
}
@keyframes fadeInOut {
    0% { opacity: 0; top: 10px; }
    10% { opacity: 1; top: 20px; }
    90% { opacity: 1; top: 20px; }
    100% { opacity: 0; top: 10px; }
}
.message-files-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}
.message-images-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
    width: 100%;
}
.message-images-container img {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    object-fit: contain;
    cursor: pointer;
    transition: transform 0.2s;
    right: 0;
}

.user-media-container {
    display: flex;
    justify-content: flex-end;
    margin: 10px 0;
}

.message-file {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    font-size: 14px;
    max-width: 200px;
}
.dark-theme .message-file {
    background-color: rgba(255, 255, 255, 0.1);
}
.message-file i {
    font-size: 16px;
}
.message-files-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}
.file-error {
    color: #ff4444;
    font-size: 14px;
    padding: 8px;
    background: rgba(255, 0, 0, 0.1);
    border-radius: 8px;
    margin: 4px 0;
}
.user-media {
    max-width: 100%;
    max-height: 200px;
    border-radius: 8px;
    object-fit: contain;
    margin-bottom: 8px;
}
.message-files-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 8px;
}
.message-file {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background-color: rgba(0, 0, 0, 0.05);
    border-radius: 12px;
    font-size: 14px;
}
.dark-theme .message-file {
    background-color: rgba(255, 255, 255, 0.1);
}
.progress-bar-container {
    width: 100%;
    height: 10px;
    background-color: #e0e0e0;
    border-radius: 5px;
    margin-top: 5px;
    overflow: hidden;
}
.progress-bar {
    height: 100%;
    background-color: #4CAF50;
    width: 0%;
    transition: width 0.2s ease;
}
.error-message {
    color: #ff4444;
    font-size: 14px;
    padding: 8px;
    background: rgba(255, 0, 0, 0.1);
    border-radius: 8px;
    margin: 4px 0;
}
.camera-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.95);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 0;
    box-sizing: border-box;
}

.camera-viewfinder {
    width: 100%;
    height: 85vh; 
    background-color: #000;
    border: none;
    border-radius: 0;
    overflow: hidden;
    position: relative;
    margin-bottom: 20px;
}

.camera-viewfinder video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.camera-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 600px;
    padding: 20px;
    box-sizing: border-box;
}



.camera-capture-btn {
    background-color: #fff;
    color: #000;
    padding: 25px;
    border-radius: 50%;
    width: 80px; 
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    left: 50%;
    bottom: 3%;
    transform: translateX(-50%);
      border: 1px solid #fff;
      outline: none;
      transition: transform 0.1s ease, box-shadow 0.2s;
}
 .camera-capture-btn::before {
      content: "";
      position: absolute;
      inset: 3px;
      border: 5px solid #000000;
      border-radius: 50%;
      background: #fff;
    }
.camera-capture-btn:active {
    transform: translateX(-50%) scale(0.95);
}
.camera-cancel-btn {
    background-color: transparent;
    color: #fff;
    border: none;
}
.camera-toggle-btn {
    background-color: transparent;
    border: none;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    backdrop-filter: blur(60px);
    transition: all 0.3s ease;
    margin-left: auto; 
    transform: translateX(-20px);
}

.camera-toggle-btn:hover{
    border: none;
    outline: none;
}
.camera-toggle-btn:focus {
    border: none;
    outline: none;
}
.camera-modal {
    display: none;
}
.confirmation-preview {
    max-width: 100%;
    max-height: 84vh;
    border-radius: 10px;
    object-fit: contain;
}
.capture-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 48px;
    display: none;
}
.controls-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 600px;
    padding: 20px;
    box-sizing: border-box;
    position: relative;
    height: 80px;
}
.camera-select-container {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    gap: 15px;
}

.camera-select-btn {
    padding: 10px 15px;
    border: 2px solid #fff;
    border-radius: 30px;
    background-color: transparent;
    color: white;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    transition: background-color 0.3s ease, color 0.3s ease;
}

.camera-select-btn:hover {
    background-color: rgba(255, 255, 255, 0.2);
}

.camera-select-btn:focus {
    outline: 2px solid #4CAF50; 
}
.custom-modal {
  display: none; 
  position: fixed;
  z-index: 2000;
  left: 0; top: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  transition: all .2s ease;
}
.custom-modal-content {
  background: var(--custom_modal_content);
  padding: 17px;
  border-radius: 25px;
  text-align: left;
  border: 1px solid #A9A9A900;
  color: var(--custom_modal_color);
  width: 91%;
  max-width: 400px;
  transition: all .2s ease;
}
.modal-buttons {
  display: flex;
  justify-content: space-around;
  transition: all .2s ease;
}
.delete-btn {
  background: #FF0000BA;
  color: white;
  padding: 13px 40px;
  border: none;
  border: 1px solid #FF000000;
  border-radius: 30px;
  cursor: pointer;
  transition: all .2s ease;
}
.cancel-btn {
  background: transparent;
  color: var(--basic-reverse-color);
  padding: 13px 40px;
  border: none;
  border: 1px solid var(--cancel_btn_border);
  border-radius: 30px;
  cursor: pointer;
  transition: all .2s ease;
}
.delete-btn:active { scale: 0.99; }
.cancel-btn:focus { outline: none; }
.delete-btn:focus { outline: none; }

        .composer-secondary-button-color {
            background-color: var(--chatinputareabtnbg);
            border: 1px solid var(--chatareabtn);
            color: var(--basic-reverse-color);
            border-radius: 9999px;
            padding: 0.5rem 0.75rem;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            white-space: nowrap;
        }
        .icon {
            fill: currentColor;
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }

        #search-btn span {
            font-size: 0.875rem;
            line-height: 1.25rem;
            font-weight: 500;
        }
        #search-btn {
            padding: 0.38rem 0.65rem;
            position: absolute;
            bottom: -2px;
            left: 153px;
        }

#search-btn:focus {
    outline: none;
}

#search-btn svg {
    width: 23px;
    height: 23px;
    fill: var(--basic-reverse-color);
}
#search-btn.active {
    background: #0085FF47 !important;
    color: #48AAFF !important;
    border: 1px solid transparent;
}
#search-btn.active svg{
    fill: #48AAFF;
}
    .company-name {
      font-size: 1.2rem; 
      font-weight: 700;
      margin-left: -14px;
      color: transparent;
      background: linear-gradient(
        90deg,
        rgba(113, 113, 113, 0.3) 0%,         
        rgba(113, 113, 113, 0.3) 40%,          
        rgba(255, 255, 255, 0.97) 50%,         
        rgba(113, 113, 113, 0.3) 60%,          
        rgba(113, 113, 113, 0.3) 100%          
      );
      background-size: 200% 100%;              
      -webkit-background-clip: text;
      background-clip: text;
      animation: slide 3s linear infinite;     
    }
    
    .welcomename {
      font-size: 1.5rem; 
      margin-bottom: 10px;
      font-weight: 700;
      letter-spacing: 1px;
      color: transparent;
      font-family: Audiowide;
      background: linear-gradient(
        90deg,
        rgba(113, 113, 113, 0.71) 0%,           
        rgba(113, 113, 113, 0.71) 40%,          
        rgba(255, 255, 255, 0.90) 50%,         
        rgba(113, 113, 113, 0.71) 60%,          
        rgba(113, 113, 113, 0.71) 100%          
      );
      background-size: 200% 100%;              
      -webkit-background-clip: text;
      background-clip: text;
      animation: slide 3s linear infinite;     
    }
    @keyframes slide {
      0% {
        background-position: 150% 0%;          
      }
      100% {
        background-position: -50% 0%;         
      }
    }

.sidebar-header {
  padding: 12px 10px;
  background-color: var(--sidebarbg);
  border: none;
  position: sticky;
  top: 40px;
  z-index: 10;
  flex-shrink: 0;
}

#conversation-search-input {
    width: 100%;
    padding: 10px 15px;
    padding-left: 42px;
    font-size: 0.95rem;
    border-radius: 20px;
    border: none;
    background-color: var(--conversation-item-bg);
    color: var(--basic-reverse-color);
    box-sizing: border-box;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3e%3cpath opacity='0.1' d='M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z' fill='grey' /%3e%3cpath d='M15 15L21 21' stroke='grey' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' /%3e%3cpath d='M17 10C17 13.866 13.866 17 10 17C6.13401 17 3 13.866 3 10C3 6.13401 6.13401 3 10 3C13.866 3 17 6.13401 17 10Z' stroke='grey' stroke-width='2' /%3e%3c/svg%3e");
    background-position: 13px center;
    background-repeat: no-repeat;
    background-size: 20px;
    transition: all 0.2s ease;
}

#conversation-search-input::placeholder {
  color: var(--inputPlaceHolder);
  opacity: 1;
}

#conversation-search-input:focus {
  outline: none;
  border: none;
}
.conversation-section {
    margin: 15px 0 10px 0;
    padding: 5px 10px;
    font-weight: bold;
    font-size: 14px;
    color: var(--basic-reverse-color);
    background-color: transparent;
    border-bottom: none;
    position: relative;
}

.conversation-section:first-child {
    margin-top: 5px;
}

.conversation-section-count {
    font-size: 12px;
    font-weight: normal;
    color: #888;
    margin-left: 8px;
    display: none;
    opacity: 0;
}

.auth-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: black;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2001;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.auth-popup.visible {
    opacity: 1;
    visibility: visible;
}

.auth-container {
background: black;
    width: 90%;
    height: 85vh;
    max-width: 800px;
    color: #FFFFFF59;
    margin-top: -7rem;
    transition: transform 0.3s ease;
    padding: 2rem;
    border-radius: 0;
    font-family: sans-serif;
}

.auth-popup.visible .auth-container {
    transform: translateY(0);
}

        .grid-shadow {
            position: fixed;
            top: 50px;
            transform: translateX(-14.1%);
            width: 100vw;
            height: 70px;
            background-image:
                linear-gradient(to top, var(--bg-color) 0%, transparent 100%),
                repeating-linear-gradient(to right, transparent, transparent 19.5px, var(--border-color) 20px),
                repeating-linear-gradient(to bottom, transparent, transparent 9.5px, var(--border-color) 10px);
            background-size: 100% 100%, 100% 100%, 100% 100%;
            background-position: center;
            position: relative;
            border-radius: 130% / 250% 250% 0 0;
            box-shadow: 0px -15px 25px -7px #FFFFFFBA;
        }
        
.auth-header {
    width: 100%;
    height: 130px;
    text-align: center;
    margin: 0;
}
.auth-header p{
    font-size: 13px;
    color: #FFFFFF4F;
}
.auth-tabs {
    display: flex;
margin-bottom: 15px;
}

.auth-tab {
    flex: 1;
    padding: 10px;
    text-align: center;
    cursor: pointer;
    border-bottom: 2px solid transparent;
font-weight: 500;
color: white;
transition: all 0.3s ease;
}

.auth-tab.active {
    border-bottom: 2px solid var(--auth-primary);
    color: var(--auth-primary);
}

.auth-tab:hover {
    background: rgba(79, 70, 229, 0.05);
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.auth-input {
    width: 100%;
    padding: var(--auth-padding);
    border: 1px solid #FFFFFF3D;
    background: transparent;
    color: white;
    border-radius: var(--auth-radius);
    font-size: 1rem;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.auth-input:focus {
    outline: none;
    border-color: var(--auth-primary);
    box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
}

.auth-button {
    width: 100%;
padding: var(--auth-padding);
background-color: var(--auth-primary);
color: white;
border: none;
border-radius: var(--auth-radius);
font-size: 1rem;
font-weight: 600;
cursor: pointer;
transition: background-color 0.2s ease;
margin-top: 0.2rem;
}

.auth-button.anonymous {
    background-color: #6b7280; 
     width: 100%;
            padding: 0.75rem;
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
            margin-top: 0.05rem; 
}

.auth-button:focus{
    outline: none;
}

.auth-error {
    color: #ff4444;
    font-size: 14px;
    text-align: center;
}

.auth-success {
    color: #4CAF50;
    font-size: 14px;
    text-align: center;
}

.auth-loading {
    display: none;
    text-align: center;
    margin: 5px 0;
}

.auth-loading .thinking-dot {
    width: 8px;
    height: 8px;
    background-color: white;
    border-radius: 50%;
    display: inline-block;
    margin: 0 3px;
    animation: thinking 1.4s infinite ease-in-out;
}

.auth-loading .thinking-dot:nth-child(1) {
    animation-delay: -0.32s;
}

.auth-loading .thinking-dot:nth-child(2) {
    animation-delay: -0.16s;
}
.user-info-section {
    position: sticky;
    bottom: 0;
    left: 0;
    width: 100%;
    max-width: 400px;
    padding: 15px;
    background: var(--sidebarbg);
    border: none;
    display: flex;
    align-items: center;
    gap: 12px;
    z-index: 1001;
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
    flex-shrink: 0;
}

.user-details {
    flex: 1;
    min-width: 0;
}

.user-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--basic-reverse-color);
    margin-bottom: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.user-email {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.dark-theme .user-email {
    color: #aaa;
}

.logout-btn {
    background: transparent;
    border: none;
    color: #ff4444;
    cursor: pointer;
    padding: 8px;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.2s;
}
.logout-btn:focus{
    outline: none;
}
.logout-btn:hover {
    background-color: rgba(255, 68, 68, 0.1);
}

.logout-btn svg {
    width: 20px;
    height: 20px;
    fill: #ff4444;
}

#notReco{
    justify-content: center;
    display: flex;
    font-size: 14px;
}


#donate-btn {
    position: absolute;
    background: var(--chatinputareabtnbg);
    top: 4px;
    left: 10px;
    border: 1px solid var(--chatinputareabrd);
    padding: 6px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    fill: var(--basic-reverse-color);
    color: var(--basic-reverse-color);
    transition: all 0.3s ease;
}

#donate-btn:hover {
    background: rgba(0, 0, 0, 0.1);
}

#donate-btn:active {
    transform: scale(0.95);
}

#donate-btn:focus {
    outline: none;
}

.crypto-addresses {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
}

.crypto-address {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.crypto-info {
    display: flex;
    align-items: center;
    gap: 10px;
}

.crypto-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}

.crypto-icon.btc {
    background: #f7931a;
    color: white;
}

.crypto-icon.eth {
    background: #627eea;
    color: white;
}

.crypto-icon.usdt {
    background: #26a17b;
    color: white;
}

.crypto-name {
    font-size: 14px;
    font-weight: 500;
    color: var(--basic-reverse-color);
}

.address-container {
    display: flex;
    align-items: center;
    background: transparent;
    border-radius: 8px;
    padding: 10px;
    border: 1px solid var(--chatinputareabrd);
}

.crypto-address-code {
    flex: 1;
    font-size: 12px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    color: var(--basic-reverse-color);
    background: transparent;
}

.copy-address-btn {
    background: transparent;
    border: none;
    padding: 5px;
    border-radius: 4px;
    cursor: pointer;
    color: var(--basic-reverse-color);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
}

.copy-address-btn:hover {
    background: rgba(0, 0, 0, 0.05);
}
.copy-address-btn:focus{
    outline: none;
}
.copy-address-btn:active {
    transform: scale(0.95);
}

.copy-address-btn.copied {
    color: #4CAF50;
}

.payment-divider {
    display: flex;
    align-items: center;
    text-align: center;
    margin: 20px 0;
    color: var(--inputPlaceHolder);
    font-size: 14px;
}

.payment-divider::before,
.payment-divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--chatinputareabrd);
}

.payment-divider::before {
    margin-right: 10px;
}

.payment-divider::after {
    margin-left: 10px;
}

.seprtr {
    display: flex;
    align-items: center;
    text-align: center;
    color: var(--inputPlaceHolder);
    font-size: 14px;
    border-radius: 50%;
}

.seprtr span {
    content: '';
    flex: 1;
    border-bottom: 1px solid var(--chatinputareabrd);
    border-radius: 40%;
}


.nowpayments-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 20px;
    background: linear-gradient(135deg, #0066ff 0%, #0051cc 100%);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    border: none;
    width: 100%;
    box-sizing: border-box;
}

.attachment-popup {
    position: absolute;
    bottom: 320%;
    left: 0;
    background: var(--custom_modal_content);
    border: 1px solid var(--chatinputareabrd);
    border-radius: 20px;
    padding: 7px;
    z-index: 1000;
    display: none;
    flex-direction: column;
    gap: 8px;
    min-width: 170px;
}

.attachment-popup.active {
    display: flex;
    animation: fadeIn 0.2s ease;
}

.attachment-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 4px 5px;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.2s;
    color: var(--basic-reverse-color);
}

.attachment_single_bg{
    background-color: #71717124;
    padding: 8px;
    border: none;
    border-radius: 15px;
}

.attachment-option:active {
    background-color: rgba(0, 0, 0, 0.17);
}

.attachment-option-text {
    font-size: 15px;
}
.attachment-option-text svg{
    fill: var(--basic-reverse-color)
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
.copy-response-container {
    margin-top: 10px;
    text-align: right;
    opacity: 1;
    transition: opacity 0.3s ease;
}
.copy-response-btn {
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    background: transparent;
    color: var(--basic-reverse-color);
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: auto;
    transition: all 0.2s ease;
}
.dark-theme .copy-response-btn {
    border-color: var(--conversation-item-border);
}
.conversation-item {
    position: relative;
    padding: 10px;
    margin: 5px 0;
    border-radius: 5px;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    background: var(--conversation-item-bg);
    border: none;
    transition: all 0.5s ease;
}

.conversation-menu {
    position: absolute;
    top: 10px;
    right: 10px;
    display: block;
    z-index: 2;
}

.conversation-menu-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    color: var(--basic-reverse-color);
    opacity: 0.7;
}
.conversation-menu-btn:focus{
    outline: none;
}
.conversation-menu-btn:hover {
    background: rgba(0, 0, 0, 0.1);
    opacity: 1;
}

.conversation-menu-btn svg {
    width: 18px;
    height: 18px;
    fill: var(--basic-reverse-color);
}


.conversation-menu-popup {
    position: fixed;
    transform: translateY(-35px);
    background: var(--custom_modal_content);
    border: 1px solid var(--chatinputareabrd);
    border-radius: 15px;
    padding: 8px 5px;
    min-width: 160px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    z-index: 2000;
    display: none;
}

.conversation-menu-popup.active {
    display: block;
    animation: fadeInScale 0.3s ease;
}

@keyframes fadeInScale {
    from {
        opacity: 0;
        transform: scale(0.55) translateY(-35px);
    }
    to {
        opacity: 1;
        transform: scale(1) translateY(-35px);
    }
}

.conversation-menu-option {
    display: flex;
    align-items: center;
    gap: 13px;
    padding: 10px 10px;
    cursor: pointer;
    transition: background-color 0.2s;
    color: var(--basic-reverse-color);
    font-size: 14px;
    border: none;
    background: transparent;
    width: 100%;
    text-align: center;
    font-family: inherit;
}
.conversation-menu-option:focus{
    outline: none;
}
.conversation-menu-option:hover {
    background-color: rgba(0, 0, 0, 0.08);
}

.conversation-menu-option svg {
    width: 20px;
    height: 20px;
}
.conversation-menu-option:hover.conversation-menu-option.delete {
    background-color: rgba(255, 68, 68, 0.1);
    fill: #ff4444;
    color: #ff4444;
}
.conversation-menu-option.delete{
    fill: var(--svgcolor);
}
.notification {
  position: fixed;
  bottom: 50%;
  left: 50%;
  transform: translateX(-50%);
  background-color: var(--basic-reverse-color);
  color: var(--basic-color);
  padding: 15px 15px;
  border-radius: 10px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  min-width: 230px;
  text-align: center;
  font-size: 15px;
  opacity: 1;
  transition: opacity 0.5s ease, bottom 0.5s ease;
  z-index: 100;
}
.notification.hide {
  opacity: 0;
  transition: all 1s ease ;
}
#image-gen-btn {
        position: absolute;
    bottom: -2px;
    left: 42px;
background-color: var(--chatinputareabtnbg);
            border: 1px solid var(--chatareabtn);
            color: var(--basic-reverse-color);
            border-radius: 9999px;
            padding: 0.38rem 0.63rem;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: opacity 0.2s ease-in-out, background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            white-space: nowrap;
            transition: all 0.3s ease;
}
#image-gen-btn:focus {
    outline: none;
}

#image-gen-btn svg {
    width: 23px;
    height: 23px;
}

#image-gen-btn.active {
        background: #0085FF47 !important;
    color: #48AAFF !important;
    border: 1px solid transparent;
}

#image-gen-btn.active svg {
    fill: #48AAFF;
}
.generated-image-container {
    margin: -20px 0;
    text-align: center;
    padding: 15px;
    background: transparent;
    border-radius: 12px;
}
.generated-image {
    max-width: 95%;
    max-height: 400px;
    border-radius: 10px;
    margin-left: -45px;
    box-shadow: none;
    border: none;
}
.image-generation-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    padding: 30px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
.image-action-buttons {
    display: flex;
    gap: 13px;
    justify-content: flex-start;
    margin-top: 30px;
    flex-wrap: wrap;
}
.image-action-btn {
    padding: 3px;
    border: none;
    border-radius: 50%;
    background: transparent;
    color: var(--basic-color);
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
}
.image-action-btn:focus {
     outline: none;
}
/* Image Placeholder Styles */
.image-placeholder {
    width: 260.3px;
    max-width: 400px;
    height: 260.3px;
    max-height: 400px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
    margin-bottom: 15px;
    
    position: relative;
overflow: hidden;
background: linear-gradient(135deg, rgba(180,180,180,0.15), rgba(90,90,90,0.25));
}
/* The moving silver shine band */
.image-placeholder::before {
    content: "";
    position: absolute;
    top: -60%;
    left: -40%;
    width: 160%;
    height: 220%;
    background: linear-gradient(
        90deg,
        rgba(255,255,255,0.00) 0%,
        rgba(255,255,255,0.25) 35%,
        rgba(255, 255, 255, 0.28) 50%,
        rgba(255,255,255,0.25) 65%,
        rgba(255,255,255,0.00) 100%
    );
    filter: blur(80px);
    transform: rotate(-20deg) translateX(-120%);
    animation: silverShine 2.8s linear infinite;
    mix-blend-mode: screen;
    pointer-events: none;
}

/* The shining sweep animation */
@keyframes silverShine {
    0%   { transform: rotate(-20deg) translateX(-120%); }
    50%  { transform: rotate(45deg) translateX(20%); }
    100% { transform: rotate(45deg) translateX(160%); }
}

.dark-theme .image-placeholder {
    background-color: #2a2a2a;
    border-color: #555;
}

.placeholder-content {
    text-align: center;
    color: #666;
}

.dark-theme .placeholder-content {
    color: #aaa;
}


/* MathJax Styles */
.MathJax {
    color: var(--response-color) !important;
}

.mjx-chtml {
    color: var(--response-color) !important;
    font-size: 1.1em !important;
}

.MathJax_Display {
    margin: 1em 0 !important;
    overflow-x: auto;
}

/* Dark theme support */
.dark-theme .MathJax {
    color: var(--response-color) !important;
}

.dark-theme .mjx-chtml {
    color: var(--response-color) !important;
}

/* MathJax responsive styling */
.MathJax {
    font-size: 1.1em !important;
    color: var(--response-color);
    outline: none;
}

/* Display math */
.MathJax_Display {
    margin: 1rem 0 !important;
    overflow-x: auto;
    overflow-y: hidden;
    padding: 0.8rem 0;
    max-width: 100%;
}

.MathJax_Display>.MathJax {
    text-align: center !important;
    display: block !important;
}

/* Inline math */
.MathJax .math {
    white-space: nowrap;
}

/* Prevent overflow and ensure responsiveness */
.mjx-chtml {
    max-width: 100% !important;
    overflow-x: auto !important;
    overflow-y: hidden !important;
}

/* Fix for small screens */
@media (max-width: 768px) {
    .MathJax {
        font-size: 1em !important;
    }
    
    .MathJax_Display {
        margin: 0.8rem 0 !important;
        padding: 0.6rem 0;
    }
    
    .mjx-chtml {
        font-size: 90% !important;
    }
}

/* Very small screens */
@media (max-width: 480px) {
    .MathJax {
        font-size: 0.95em !important;
    }
    
    .MathJax_Display {
        margin: 0.6rem 0 !important;
        padding: 0.5rem 0;
    }
    
    .mjx-chtml {
        font-size: 85% !important;
    }
}

/* Ensure math doesn't break chat layout */
.chat-bubble .MathJax_Display {
    margin: 0.8rem 0 !important;
}

.chat-bubble .mjx-chtml {
    line-height: 1.4 !important;
}

/* Fix for inline math spacing */
.MathJax .mjx-char {
    line-height: 1.2 !important;
}


/* Image Zoom Styles */
.zoomable-image-wrapper {
    position: relative;
    display: inline-block;
    max-width: 100%;
    cursor: zoom-in;
    transition: transform 0.3s ease;
}

.zoomable-image {
    transition: transform 0.3s ease;
}

.image-zoom-box {
    position: absolute;
    display: none;
    width: 200px;
    height: 200px;
    overflow: hidden;
    border: 2px solid #007bff;
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    pointer-events: none;
}

/* Ensure zoom works on mobile */
@media (max-width: 768px) {
    .image-zoom-box {
        width: 150px;
        height: 150px;
    }
    
    .zoomable-image-wrapper {
        cursor: pointer;
    }
}

.sidebar-loading {
    position: fixed;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    color: var(--basic-reverse-color);
    font-size: 14px;
    gap: 10px;
    height: 100%;
    visibility: hidden;
    opacity: 0;
    transition: opacity 0.3s ease, visibility 0.3s ease;
}

.sidebar-loading.visible {
    visibility: visible;
    opacity: 1;
}

.loading-spinner {
    width: 24px;
    height: 24px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: var(--basic-reverse-color);
    animation: spin 1s linear infinite;
}

.dark-theme .loading-spinner {
    border-top-color: #aaa;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
    .my-cool-donation-button {
      height: 60px;
      border-radius: 3rem;
      outline: none;
      background: #8503FF8A;
      border: 2px solid transparent;
      color: white;
      cursor: pointer;
      font-size: 1.2em;
      display: flex; 
      justify-content: center;
      align-items: center;
      transition: all 0.3s ease;
      text-decoration: none;
    padding: 12px 20px;
    width: 100%;
    box-sizing: border-box;
    }
    .rotating-button {
      background: linear-gradient(black, black) padding-box,
        conic-gradient(
            from var(--angle, 0),
            transparent 0%,
            silver 5%, 
            transparent 10% 
          ) border-box;
    }
    .my-cool-donation-button a {
      color: white;
      text-decoration: none;
      font-family: sans-serif;
    }

</style>
</head>
<body>
        <div class="overlay"></div>
    <div class="swipe-indicator"></div>
    <div class="sidebar">
       <button class='change-theme' id="theme-button">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960"><path d="M480-120q-150 0-255-105T120-480q0-150 105-255t255-105q14 0 27.5 1t26.5 3q-41 29-65.5 75.5T444-660q0 90 63 153t153 63q55 0 101-24.5t75-65.5q2 13 3 26.5t1 27.5q0 150-105 255T480-120Zm0-80q88 0 158-48.5T740-375q-20 5-40 8t-40 3q-123 0-209.5-86.5T364-660q0-20 3-40t8-40q-78 32-126.5 102T200-480q0 116 82 198t198 82Zm-10-270Z"/></svg>
 <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960" ><path d="M480-360q50 0 85-35t35-85q0-50-35-85t-85-35q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0 80q-83 0-141.5-58.5T280-480q0-83 58.5-141.5T480-680q83 0 141.5 58.5T680-480q0 83-58.5 141.5T480-280ZM200-440H40v-80h160v80Zm720 0H760v-80h160v80ZM440-760v-160h80v160h-80Zm0 720v-160h80v160h-80ZM256-650l-101-97 57-59 96 100-52 56Zm492 496-97-101 53-55 101 97-57 59Zm-98-550 97-101 59 57-100 96-56-52ZM154-212l101-97 55 53-97 101-59-57Zm326-268Z"/></svg>
</button>

<button id="donate-btn" title="Support the project">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true" class="r-4qtqp9 r-yyyyoo r-dnmrzs r-bnwqim r-lrvibr r-m6rgpd r-1nao33i r-1q142lx r-1kihuf0 r-1qtyvf0 r-u8ivw8 r-o4n3w5" data-testid="icon" width="22px" height="22px"><g ><path d="M23 3v14h-2V5H5V3h18zM10 17c1.1 0 2-1.34 2-3s-.9-3-2-3-2 1.34-2 3 .9 3 2 3zM1 7h18v14H1V7zm16 10c-1.1 0-2 .9-2 2h2v-2zm-2-8c0 1.1.9 2 2 2V9h-2zM3 11c1.1 0 2-.9 2-2H3v2zm0 4c2.21 0 4 1.79 4 4h6c0-2.21 1.79-4 4-4v-2c-2.21 0-4-1.79-4-4H7c0 2.21-1.79 4-4 4v2zm0 4h2c0-1.1-.9-2-2-2v2z"></path></g></svg>
</button>
<div id="sidebar-loading" class="sidebar-loading">
    <div class="loading-spinner"></div>
    <p>Loading chats...</p>
</div>
          <div id="conversation-list"></div>
        <div class="drag-handle"></div>
        
        <!-- User Info Section -->
<div id="userInfoSection" class="user-info-section" style="display: none;">
    <div class="user-avatar" id="userAvatar">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 12C14.7614 12 17 9.76142 17 7C17 4.23858 14.7614 2 12 2C9.23858 2 7 4.23858 7 7C7 9.76142 9.23858 12 12 12Z" fill="white" />
            <path d="M12 14.5C6.99 14.5 2.91 17.86 2.91 22C2.91 22.28 3.13 22.5 3.41 22.5H20.59C20.87 22.5 21.09 22.28 21.09 22C21.09 17.86 17.01 14.5 12 14.5Z" fill="white" />
        </svg>
    </div>
    <div class="user-details">
        <div class="user-name" id="userName">Guest User</div>
        <div class="user-email" id="userEmail">guest@example.com</div>
    </div>
    <button class="logout-btn" id="sidebarLogoutBtn" title="Logout">
        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M17 7L15.59 8.41L18.17 11H8V13H18.17L15.59 15.58L17 17L22 12L17 7ZM4 5H12V3H4C2.9 3 2 3.9 2 5V19C2 20.1 2.9 21 4 21H12V19H4V5Z" fill="currentColor" />
        </svg>
    </button>
</div>
    </div>
        <div class="app-header">
      <span class="material-symbols-rounded" id="menu-btn"><svg viewBox="0 0 24 24" width="26px" height="26px" xmlns="http://www.w3.org/2000/svg">
<path d="M4 18H10" stroke="var(--basic-reverse-color)" stroke-width="2" stroke-linecap="round"/>
<path d="M4 12L16 12" stroke="var(--basic-reverse-color)" stroke-width="2" stroke-linecap="round"/>
<path d="M4 6L20 6" stroke="var(--basic-reverse-color)" stroke-width="2" stroke-linecap="round"/>
</svg></span>
      <div class="title">NURVLE</div>
      
      
                <button id="new-chat-btn">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="25px" height="25px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="stroke-[2] "><path d="M10 4V4C8.13623 4 7.20435 4 6.46927 4.30448C5.48915 4.71046 4.71046 5.48915 4.30448 6.46927C4 7.20435 4 8.13623 4 10V13.6C4 15.8402 4 16.9603 4.43597 17.816C4.81947 18.5686 5.43139 19.1805 6.18404 19.564C7.03968 20 8.15979 20 10.4 20H14C15.8638 20 16.7956 20 17.5307 19.6955C18.5108 19.2895 19.2895 18.5108 19.6955 17.5307C20 16.7956 20 15.8638 20 14V14" stroke="var(--basic-reverse-color)" stroke-linecap="square" fill="none" stroke-width="2px"></path><path d="M12.4393 14.5607L19.5 7.5C20.3284 6.67157 20.3284 5.32843 19.5 4.5C18.6716 3.67157 17.3284 3.67157 16.5 4.5L9.43934 11.5607C9.15804 11.842 9 12.2235 9 12.6213V15H11.3787C11.7765 15 12.158 14.842 12.4393 14.5607Z" stroke="var(--basic-reverse-color)" stroke-linecap="square" fill="none" stroke-width="2px"></path></svg>
</button>

    </div>
    <div id="response" class="d-flex flex-column">
            <div class="home-greeting" id="homeGreeting">
     <img src="https://i.ibb.co/m35mFtZ/image-4.png" alt="Bot Logo">
        <h2>Hello there!</h2>
        <p>How can I help you today?</p>
    </div>
    </div>
<div id="chatInputArea">
    <div class="input-container">
<div class="preview-container" id="previewContainer"></div>
        <textarea id="userInput" placeholder="Ask anything" rows="1"></textarea>

        <div class="buttons-container">
<button id="attachButton" title="Attach files">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="20" height="20" viewBox="0 0 20 20" fill="var(--svgcolor)" xmlns="http://www.w3.org/2000/svg"><path d="M4.33496 12.5V7.5C4.33496 7.13273 4.63273 6.83496 5 6.83496C5.36727 6.83496 5.66504 7.13273 5.66504 7.5V12.5C5.66504 14.8942 7.60585 16.835 10 16.835C12.3942 16.835 14.335 14.8942 14.335 12.5V5.83301C14.3348 4.35959 13.1404 3.16522 11.667 3.16504C10.1934 3.16504 8.99822 4.35948 8.99805 5.83301V12.5C8.99805 13.0532 9.44679 13.502 10 13.502C10.5532 13.502 11.002 13.0532 11.002 12.5V7.5C11.002 7.13273 11.2997 6.83496 11.667 6.83496C12.0341 6.83514 12.332 7.13284 12.332 7.5V12.5C12.332 13.7877 11.2877 14.832 10 14.832C8.71226 14.832 7.66797 13.7877 7.66797 12.5V5.83301C7.66814 3.62494 9.45888 1.83496 11.667 1.83496C13.875 1.83514 15.6649 3.62505 15.665 5.83301V12.5C15.665 15.6287 13.1287 18.165 10 18.165C6.87131 18.165 4.33496 15.6287 4.33496 12.5Z" fill="var(--svgcolor)"></path></svg>
</button>
<div class="attachment-popup" id="attachmentPopup">
    
        <div class="attachment-option" id="camera-btn" title="Take Picture">
            <button id="camera-btns" title="Take Picture">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" focusable="false" viewBox="0 -960 960 960" xmlns="http://www.w3.org/2000/svg"><path d="M480-320q-50 0-85-35t-35-85q0-50 35-85t85-35q50 0 85 35t35 85q0 50-35 85t-85 35Zm240 160q-33 0-56.5-23.5T640-240q0-33 23.5-56.5T720-320q33 0 56.5 23.5T800-240q0 33-23.5 56.5T720-160Zm-440 40q-66 0-113-47t-47-113v-80h80v80q0 33 23.5 56.5T280-200h200v80H280Zm480-320v-160q0-33-23.5-56.5T680-680H280q-33 0-56.5 23.5T200-600v120h-80v-120q0-66 47-113t113-47h80l40-80h160l40 80h80q66 0 113 47t47 113v160h-80Z"></path></svg>
            </button>
        <span class="attachment-option-text">Camera</span>
    </div>
    <div class="seprtr">
    <span></span>
    </div>
    <div class="attachment-option" id="photoOption">
        <div class="attachment_single_bg">
<svg xmlns="http://www.w3.org/2000/svg" height="26px" viewBox="0 -960 960 960" width="26px" fill="var(--basic-reverse-color)"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm40-80h480L570-480 450-320l-90-120-120 160Zm-40 80v-560 560Zm140-360q25 0 42.5-17.5T400-620q0-25-17.5-42.5T340-680q-25 0-42.5 17.5T280-620q0 25 17.5 42.5T340-560Z"/></svg>
</div>
        <span class="attachment-option-text">Images</span>
    </div>
    <div class="attachment-option" id="videoOption">
        <div class="attachment_single_bg">
    <svg fill="none" height="28px" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="28px" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" stroke="none"/><path d="M15 10l4.553 -2.276a1 1 0 0 1 1.447 .894v6.764a1 1 0 0 1 -1.447 .894l-4.553 -2.276v-4z"/><rect height="12" rx="2" width="12" x="3" y="6"/><line x1="7" x2="11" y1="12" y2="12"/><line x1="9" x2="9" y1="10" y2="14"/></svg>
    </div>
        <span class="attachment-option-text">Videos</span>
    </div>
    <div class="attachment-option" id="fileOption">
        <div class="attachment_single_bg">
<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="26px" height="26px" viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" aria-label="" ><path d="M4.33496 12.5V7.5C4.33496 7.13273 4.63273 6.83496 5 6.83496C5.36727 6.83496 5.66504 7.13273 5.66504 7.5V12.5C5.66504 14.8942 7.60585 16.835 10 16.835C12.3942 16.835 14.335 14.8942 14.335 12.5V5.83301C14.3348 4.35959 13.1404 3.16522 11.667 3.16504C10.1934 3.16504 8.99822 4.35948 8.99805 5.83301V12.5C8.99805 13.0532 9.44679 13.502 10 13.502C10.5532 13.502 11.002 13.0532 11.002 12.5V7.5C11.002 7.13273 11.2997 6.83496 11.667 6.83496C12.0341 6.83514 12.332 7.13284 12.332 7.5V12.5C12.332 13.7877 11.2877 14.832 10 14.832C8.71226 14.832 7.66797 13.7877 7.66797 12.5V5.83301C7.66814 3.62494 9.45888 1.83496 11.667 1.83496C13.875 1.83514 15.6649 3.62505 15.665 5.83301V12.5C15.665 15.6287 13.1287 18.165 10 18.165C6.87131 18.165 4.33496 15.6287 4.33496 12.5Z" fill="var(--basic-reverse-color)"></path></svg>
</div>
        <span class="attachment-option-text">Files</span>
    </div>
</div>
            <button id="mic-btn" title="Voice Input">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" d="M21,14 L19,14 L19,10 L21,10 L21,14 Z M17,16 L15,16 L15,8 L17,8 L17,16 Z M13,19 L11,19 L11,5 L13,5 L13,19 Z M9,16 L7,16 L7,8 L9,8 L9,16 Z M5,14 L3,14 L3,10 L5,10 L5,14 Z"/>
                </svg>
            </button>
    
    <!-- Search Button -->
    <button id="search-btn" title="Web Search" class="composer-secondary-button-color">
        <svg viewBox="0 0 20 20" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="icon">
            <path d="M10 2.125C14.3492 2.125 17.875 5.65076 17.875 10C17.875 14.3492 14.3492 17.875 10 17.875C5.65076 17.875 2.125 14.3492 2.125 10C2.125 5.65076 5.65076 2.125 10 2.125ZM7.88672 10.625C7.94334 12.3161 8.22547 13.8134 8.63965 14.9053C8.87263 15.5194 9.1351 15.9733 9.39453 16.2627C9.65437 16.5524 9.86039 16.625 10 16.625C10.1396 16.625 10.3456 16.5524 10.6055 16.2627C10.8649 15.9733 11.1274 15.5194 11.3604 14.9053C11.7745 13.8134 12.0567 12.3161 12.1133 10.625H7.88672ZM3.40527 10.625C3.65313 13.2734 5.45957 15.4667 7.89844 16.2822C7.7409 15.997 7.5977 15.6834 7.4707 15.3486C6.99415 14.0923 6.69362 12.439 6.63672 10.625H3.40527ZM13.3633 10.625C13.3064 12.439 13.0059 14.0923 12.5293 15.3486C12.4022 15.6836 12.2582 15.9969 12.1006 16.2822C14.5399 15.467 16.3468 13.2737 16.5947 10.625H13.3633ZM12.1006 3.7168C12.2584 4.00235 12.4021 4.31613 12.5293 4.65137C13.0059 5.90775 13.3064 7.56102 13.3633 9.375H16.5947C16.3468 6.72615 14.54 4.53199 12.1006 3.7168ZM10 3.375C9.86039 3.375 9.65437 3.44756 9.39453 3.7373C9.1351 4.02672 8.87263 4.48057 8.63965 5.09473C8.22547 6.18664 7.94334 7.68388 7.88672 9.375H12.1133C12.0567 7.68388 11.7745 6.18664 11.3604 5.09473C11.1274 4.48057 10.8649 4.02672 10.6055 3.7373C10.3456 3.44756 10.1396 3.375 10 3.375ZM7.89844 3.7168C5.45942 4.53222 3.65314 6.72647 3.40527 9.375H6.63672C6.69362 7.56102 6.99415 5.90775 7.4707 4.65137C7.59781 4.31629 7.74073 4.00224 7.89844 3.7168Z"></path>
        </svg>
        <span>Search</span>
    </button>
 
 <!-- Add this after the search button -->
<button id="image-gen-btn" title="Generate Image">
<svg fill="var(--basic-reverse-color)" width="18px" height="18px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">

    <g>
        
        <path d="M256.0015,93.5976c-116.023,0-210,72.6244-210,162.3119C44.8479,381.6074,223.063,452.2291,346.74,402.2071a45.0282,45.0282,0,0,0,24.5-62.56c-13.2531-26.9208-36.1087-55.6723-5.0735-78.5749a35.4778,35.4778,0,0,1,41.56,1.3117L425.14,275.86c16.5857,12.9071,41.1545,1.0575,40.8618-19.95C466.0015,166.222,371.939,93.5976,256.0015,93.5976ZM142.777,261.86c-31.6119,25.16-69.686-20.1777-39.375-46.9C135.02,189.7942,173.02,235.1282,142.777,261.86Zm30.1-90.9126c1.004-40.3982,60.2524-40.39,61.25.0011C233.0691,211.3306,173.93,211.3221,172.8765,170.9473ZM302.5521,327.0481c-7.7609,47.2128-100.2063,35.2243-95.8121-12.3389C214.5479,267.5551,307.07,279.4123,302.5521,327.0481Zm5.9494-125.4758c-40.394-1.0574-40.3748-60.2566,0-61.25C348.8848,141.32,348.8869,200.5234,308.5015,201.5723Z" />
        
    </g>
    
</svg>
    <span style="font-size: 14px;">Generate</span>
</button>
            <button id="sendBtn">
<svg fill="white" width="25px" height="25px" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M5.23 10.64a1 1 0 0 0 1.41.13L11 7.14V19a1 1 0 0 0 2 0V7.14l4.36 3.63a1 1 0 1 0 1.28-1.54l-6-5-.15-.09-.13-.07a1 1 0 0 0-.72 0l-.13.07-.15.09-6 5a1 1 0 0 0-.13 1.41z"/></svg>
    </button>
        </div>
    </div>
</div>
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
    <symbol id="error-icon" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
    </symbol>
</svg>
<!-- Custom Delete Confirmation Modal -->
<div id="deleteModal" class="custom-modal">
    <div class="custom-modal-content">
        <p style="color: #FF0000BA; text-align: center;font-size: 20px;font-weight: 500;">Delete Chat</p>
        <p>This action will permanently delete all the chats you've created and cannot be undone. Please confirm to proceed.</p>
        <div class="modal-buttons">
            <button id="cancelDeleteBtn" class="cancel-btn">Cancel</button>
            <button id="confirmDeleteBtn" class="delete-btn">Delete</button>
        </div>
    </div>
</div>

<!-- Auth Popup -->
<div id="authPopup" class="auth-popup">
    <div class="auth-container">
        <div class="auth-header">
            <h2 class="welcomename">NURVLE</h2>
            <div class="grid-shadow"></div>
            <p></p>
        </div>
        
        <div class="auth-tabs">
            <div class="auth-tab active" id="registerTab">Register</div>
            <div class="auth-tab" id="loginTab">Login</div>
        </div>
        
        <div id="registerForm" class="auth-form">
            <input type="email" id="registerEmail" class="auth-input" placeholder="Email" required>
            <input type="password" id="registerPassword" class="auth-input" placeholder="Password" required>
            <input type="password" id="registerConfirm" class="auth-input" placeholder="Confirm Password" required>
            <div id="registerError" class="auth-error"></div>
            <div id="registerSuccess" class="auth-success"></div>
            <div id="registerLoading" class="auth-loading">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
            </div>
            <button id="registerBtn" class="auth-button">Sign Up</button>
        </div>
        
        <div id="loginForm" class="auth-form" style="display: none;">
            <input type="email" id="loginEmail" class="auth-input" placeholder="Email" required>
            <input type="password" id="loginPassword" class="auth-input" placeholder="Password" required>
            <div id="loginError" class="auth-error"></div>
            <div id="loginLoading" class="auth-loading">
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
                <div class="thinking-dot"></div>
            </div>
            <button id="loginBtn" class="auth-button">Sign In</button>
        </div>
    <div class="payment-divider">
    <span>Or</span>
</div>
        <button id="anonymousBtn" class="auth-button anonymous">Continue Anonymously</button>
        <span id="notReco">Not Recommended</span>
        
    </div>
</div>


<!-- Payment Modal -->
<div id="paymentModal" class="custom-modal">
    <div class="custom-modal-content">
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: var(--basic-reverse-color);font-family: Audiowide;font-size: 18px;">SUPPORT NURVLE</h3>
            <p style="margin: 10px 0 0; font-size: 14px; color: var(--inputPlaceHolder);">Your donation helps keep this service running</p>
        </div>
        
        <div class="crypto-addresses">
            <div class="crypto-address">
                <div class="crypto-info">
                    <span class="crypto-icon btc"></span>
                    <span class="crypto-name">Bitcoin (BTC)</span>
                </div>
                <div class="address-container">
                    <code class="crypto-address-code" id="btc-address">bc1q2ygr8l34phvzzv6f5fygp6er2vl8wehgc9xaky</code>
                    <button class="copy-address-btn" data-address="bc1q2ygr8l34phvzzv6f5fygp6er2vl8wehgc9xaky">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 12.9V17.1C16 20.6 14.6 22 11.1 22H6.9C3.4 22 2 20.6 2 17.1V12.9C2 9.4 3.4 8 6.9 8H11.1C14.6 8 16 9.4 16 12.9Z" stroke="currentColor" stroke-width="1.5" />
                            <path d="M22 6.9V11.1C22 14.6 20.6 16 17.1 16H16V12.9C16 9.4 14.6 8 11.1 8H8V6.9C8 3.4 9.4 2 12.9 2H17.1C20.6 2 22 3.4 22 6.9Z" stroke="currentColor" stroke-width="1.5" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="crypto-address">
                <div class="crypto-info">
                    <span class="crypto-icon eth"></span>
                    <span class="crypto-name">Ethereum (ETH)</span>
                </div>
                <div class="address-container">
                    <code class="crypto-address-code" id="eth-address">0x528F66d1DCefDC31ccBC44Bd3Ac088c8B3068843</code>
                    <button class="copy-address-btn" data-address="0x528F66d1DCefDC31ccBC44Bd3Ac088c8B3068843">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 12.9V17.1C16 20.6 14.6 22 11.1 22H6.9C3.4 22 2 20.6 2 17.1V12.9C2 9.4 3.4 8 6.9 8H11.1C14.6 8 16 9.4 16 12.9Z" stroke="currentColor" stroke-width="1.5" />
                            <path d="M22 6.9V11.1C22 14.6 20.6 16 17.1 16H16V12.9C16 9.4 14.6 8 11.1 8H8V6.9C8 3.4 9.4 2 12.9 2H17.1C20.6 2 22 3.4 22 6.9Z" stroke="currentColor" stroke-width="1.5" />
                        </svg>
                    </button>
                </div>
            </div>
            
            <div class="crypto-address">
                <div class="crypto-info">
                    <span class="crypto-icon usdt"></span>
                    <span class="crypto-name">USDT (TRC20)</span>
                </div>
                <div class="address-container">
                    <code class="crypto-address-code" id="usdt-address">TTvNpXvF3VU4ANH74Rzzd5UDt5CHTK9q6S</code>
                    <button class="copy-address-btn" data-address="TTvNpXvF3VU4ANH74Rzzd5UDt5CHTK9q6S">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M16 12.9V17.1C16 20.6 14.6 22 11.1 22H6.9C3.4 22 2 20.6 2 17.1V12.9C2 9.4 3.4 8 6.9 8H11.1C14.6 8 16 9.4 16 12.9Z" stroke="currentColor" stroke-width="1.5" />
                            <path d="M22 6.9V11.1C22 14.6 20.6 16 17.1 16H16V12.9C16 9.4 14.6 8 11.1 8H8V6.9C8 3.4 9.4 2 12.9 2H17.1C20.6 2 22 3.4 22 6.9Z" stroke="currentColor" stroke-width="1.5" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div class="payment-divider">
            <span>Or with</span>
        </div>
  <button class="my-cool-donation-button rotating-button">
      <a href="https://nowpayments.io/donation?api_key=58c2580a-96e8-4a43-beb3-20ab39620e34" target="_blank" rel="noreferrer noopener">
<svg fill="#ffffff" width="28px" height="28px" viewBox="-1.7 0 20.4 20.4" xmlns="http://www.w3.org/2000/svg" class="cf-icon-svg"><path d="M16.417 10.283A7.917 7.917 0 1 1 8.5 2.366a7.916 7.916 0 0 1 7.917 7.917zm-4.844 1.754a2.249 2.249 0 0 0-.556-1.477l-.001-.002a3.02 3.02 0 0 0-.835-.665l-.003-.002a3.498 3.498 0 0 0-.866-.313H9.31a3.78 3.78 0 0 0-.795-.083 2.849 2.849 0 0 1-.475-.037 1.8 1.8 0 0 1-.494-.158l-.002-.001a1.17 1.17 0 0 1-.371-.298L7.172 9a.733.733 0 0 1-.175-.44.749.749 0 0 1 .421-.63 2.157 2.157 0 0 1 1.11-.297 2.283 2.283 0 0 1 .391.066l.049.01a2.479 2.479 0 0 1 .473.166 1.33 1.33 0 0 1 .381.261.792.792 0 1 0 1.118-1.12 2.902 2.902 0 0 0-.85-.585 3.996 3.996 0 0 0-.785-.268h-.001l-.008-.002v-.786a.792.792 0 1 0-1.583 0v.763a3.557 3.557 0 0 0-1.14.454 2.328 2.328 0 0 0-1.159 1.967 2.296 2.296 0 0 0 .529 1.44 2.724 2.724 0 0 0 .894.717 3.342 3.342 0 0 0 .942.305 4.398 4.398 0 0 0 .736.059 2.202 2.202 0 0 1 .46.046 1.927 1.927 0 0 1 .467.168 1.431 1.431 0 0 1 .382.308.674.674 0 0 1 .165.436c0 .097 0 .324-.385.573a2.182 2.182 0 0 1-1.132.314 3.515 3.515 0 0 1-.494-.06 2.381 2.381 0 0 1-.459-.148h-.001a.953.953 0 0 1-.356-.274.792.792 0 1 0-1.197 1.037 2.516 2.516 0 0 0 .967.708 3.799 3.799 0 0 0 .774.237h.007v.783a.792.792 0 1 0 1.583 0v-.79a3.581 3.581 0 0 0 1.17-.479 2.215 2.215 0 0 0 1.107-1.9z"/></svg>
          Donate with Crypto!
      </a>
  </button>
        <button id="closePaymentModal" class="cancel-btn" style="margin-top: 15px; width: 100%;">Close</button>
    </div>
</div>



    <script>
// Configuration will be loaded from external config.json
let SERPAPI_KEY = "";
let APPWRITE_ENDPOINT = "";
let APPWRITE_PROJECT_ID = "";
let APPWRITE_BUCKET_ID = "";
let APPWRITE_DATABASE_ID = "";
let APPWRITE_COLLECTION_ID = "";
let API_KEY = "";

// Initialize Appwrite Client (will be configured after loading config)
const client = new Appwrite.Client();

// Initialize Appwrite Account, Storage, and Databases
const account = new Appwrite.Account(client); // Add Account for authentication
const storage = new Appwrite.Storage(client);
const databases = new Appwrite.Databases(client);
let conversations = []; // Start with an empty array, load from Appwrite
let currentConversationId = null;
let fileInputInitialized = false;
// Add this at the top with your other variables
let isImageGenerationMode = false;
let selectedFiles = []; // Stores {file: File, id: string, name: string, type: string, size: number, fileId: string} objects
let currentMessages = [];
let mathJaxQueue = [];
let isMathJaxProcessing = false;
let searchConversationHistory = [];
let isOpen = false;
let currentTypingInstance = null;
let copyButton = null;
let inputAreaRotationInterval = null;
let currentUserId = null; // Variable to store the current user's ID
let userIsScrolling = false;
let autoScrollEnabled = true;

// Auth functionality
let authPopup = null;

// Add these variables at the top with your other variables
let attachmentPopup = null;
let photoOption = null;
let videoOption = null;
let fileOption = null;

// Initialize attachment popup in your initialization function
// Initialize attachment popup in your initialization function
function initializeAttachmentPopup() {
    attachmentPopup = document.getElementById('attachmentPopup');
    photoOption = document.getElementById('photoOption');
    videoOption = document.getElementById('videoOption');
    fileOption = document.getElementById('fileOption');
    
    // Toggle popup when attach button is clicked
    const attachButton = document.getElementById('attachButton');
    if (attachButton) {
        attachButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            attachmentPopup.classList.toggle('active');
        });
    }
    
    // Close popup when clicking outside
    document.addEventListener('click', (e) => {
        if (attachmentPopup.classList.contains('active') &&
            !attachmentPopup.contains(e.target) &&
            e.target !== attachButton) {
            attachmentPopup.classList.remove('active');
        }
    });
    
    // Photo option handler
    photoOption.addEventListener('click', () => {
        attachmentPopup.classList.remove('active');
        triggerFileInput('image/*');
    });
    
    // Video option handler
    videoOption.addEventListener('click', () => {
        attachmentPopup.classList.remove('active');
        triggerFileInput('video/*');
    });
    
    // File option handler
    fileOption.addEventListener('click', () => {
        attachmentPopup.classList.remove('active');
        triggerFileInput('*');
    });
}

// Helper function to trigger file input with specific accept types
function triggerFileInput(acceptTypes) {
    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.multiple = true;
    fileInput.accept = acceptTypes;
    fileInput.style.display = 'none';
    
    fileInput.addEventListener('change', function(e) {
        console.log("File input change event triggered");
        console.log("Files selected:", e.target.files.length);
        handleFileSelect(e);
        document.body.removeChild(fileInput);
    });
    
    document.body.appendChild(fileInput);
    fileInput.click();
    
    // Clean up if user cancels
    setTimeout(() => {
        if (document.body.contains(fileInput)) {
            document.body.removeChild(fileInput);
        }
    }, 1000);
}

function initializeAuthPopup() {
    authPopup = document.getElementById('authPopup');
    
    // Tab switching
    document.getElementById('registerTab').addEventListener('click', () => {
        switchAuthTab('register');
    });
    
    document.getElementById('loginTab').addEventListener('click', () => {
        switchAuthTab('login');
    });
    
    // Register button
    document.getElementById('registerBtn').addEventListener('click', handleRegister);
    
    // Login button
    document.getElementById('loginBtn').addEventListener('click', handleLogin);
    
    // Anonymous button
    document.getElementById('anonymousBtn').addEventListener('click', handleAnonymous);
    
    // Enter key support
    document.getElementById('registerEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    document.getElementById('registerPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    document.getElementById('registerConfirm').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleRegister();
    });
    document.getElementById('loginEmail').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    document.getElementById('loginPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
    });
    
    // Always show the popup on load - don't check for sessions
    authPopup.style.display = 'flex';
}

function switchAuthTab(tab) {
    if (tab === 'register') {
        document.getElementById('registerTab').classList.add('active');
        document.getElementById('loginTab').classList.remove('active');
        document.getElementById('registerForm').style.display = 'flex';
        document.getElementById('loginForm').style.display = 'none';
        // Clear errors
        document.getElementById('registerError').textContent = '';
        document.getElementById('loginError').textContent = '';
    } else {
        document.getElementById('loginTab').classList.add('active');
        document.getElementById('registerTab').classList.remove('active');
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'flex';
        // Clear errors
        document.getElementById('registerError').textContent = '';
        document.getElementById('loginError').textContent = '';
    }
}

function showLoading(formType) {
    if (formType === 'register') {
        document.getElementById('registerLoading').style.display = 'block';
        document.getElementById('registerBtn').disabled = true;
    } else {
        document.getElementById('loginLoading').style.display = 'block';
        document.getElementById('loginBtn').disabled = true;
    }
}

function hideLoading(formType) {
    if (formType === 'register') {
        document.getElementById('registerLoading').style.display = 'none';
        document.getElementById('registerBtn').disabled = false;
    } else {
        document.getElementById('loginLoading').style.display = 'none';
        document.getElementById('loginBtn').disabled = false;
    }
}

async function handleRegister() {
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const confirm = document.getElementById('registerConfirm').value;
    const errorElement = document.getElementById('registerError');
    const successElement = document.getElementById('registerSuccess');
    
    // Clear previous messages
    errorElement.textContent = '';
    successElement.textContent = '';
    
    // Simple validation
    if (!email || !password || !confirm) {
        errorElement.textContent = 'All fields are required';
        return;
    }
    
    if (password !== confirm) {
        errorElement.textContent = 'Passwords do not match';
        return;
    }
    
    if (password.length < 8) {
        errorElement.textContent = 'Password must be at least 8 characters';
        return;
    }
    
    // Show loading
    showLoading('register');
    
    try {
        // Create user account with Appwrite
        await account.create('unique()', email, password);
        
        // Success message
        successElement.textContent = 'Account created successfully! Logging you in...';
        
        // Automatically login after successful registration
        try {
            // Create email session with Appwrite
            await account.createEmailSession(email, password);
            
            // Get current user to verify login was successful
            const user = await account.get();
            currentUserId = user.$id;
            
            console.log("User registered and logged in successfully:", user);
            
            // Store login method in localStorage
            localStorage.setItem('loginMethod', 'email');
            localStorage.setItem('userEmail', email);
            
            // Hide the auth popup
            hideAuthPopup();
            
            // Continue with app initialization
            completeAppSetup();
            showUserSection();
            
        } catch (loginError) {
            console.error('Auto-login after registration failed:', loginError);
            successElement.textContent = 'Account created! Please login manually.';
            // Switch to login tab and pre-fill email
            switchAuthTab('login');
            document.getElementById('loginEmail').value = email;
        }
        
    } catch (error) {
        console.error('Registration error:', error);
        errorElement.textContent = error.message || 'Failed to create account. Please try again.';
    } finally {
        hideLoading('register');
    }
}

async function handleLogin() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const errorElement = document.getElementById('loginError');
    
    // Clear previous messages
    errorElement.textContent = '';
    
    // Simple validation
    if (!email || !password) {
        errorElement.textContent = 'Email and password are required';
        return;
    }
    
    // Show loading
    showLoading('login');
    
    try {
        // First, try to delete any existing session to avoid conflicts
        try {
            await account.deleteSession('current');
            console.log("Deleted existing session");
        } catch (deleteError) {
            // It's okay if there's no session to delete
            console.log("No existing session to delete");
        }
        
        // Create email session with Appwrite
        await account.createEmailSession(email, password);
        
        // Get current user to verify login was successful
        const user = await account.get();
        currentUserId = user.$id;
        
        console.log("User logged in successfully:", user);
        
        // Store login method in localStorage for persistence
        localStorage.setItem('loginMethod', 'email');
        localStorage.setItem('userEmail', email);
        
        // Hide the auth popup
        hideAuthPopup();
        
        // Continue with app initialization
        completeAppSetup();
        showUserSection();
        
    } catch (error) {
        console.error('Login error:', error);
        
        // Handle specific error cases
        if (error.code === 401 && error.type === 'user_session_already_exists') {
            // This means we're already logged in, just proceed
            try {
                const user = await account.get();
                currentUserId = user.$id;
                console.log("Already logged in as:", user.email);
                
                // Store login method
                localStorage.setItem('loginMethod', 'email');
                localStorage.setItem('userEmail', user.email);
                
                // Hide the auth popup
                hideAuthPopup();
                
                // Continue with app initialization
                completeAppSetup();
                showUserSection();
                return; // Exit early since we handled this case
            } catch (getUserError) {
                errorElement.textContent = 'Session conflict. Please refresh the page and try again.';
            }
        } else if (error.code === 401) {
            errorElement.textContent = 'Invalid email or password. Please try again.';
        } else {
            errorElement.textContent = error.message || 'Failed to login. Please try again.';
        }
    } finally {
        hideLoading('login');
    }
}

async function handleAnonymous() {
    try {
        // First, try to delete any existing session to avoid conflicts
        try {
            await account.deleteSession('current');
            console.log("Deleted existing session");
        } catch (deleteError) {
            // It's okay if there's no session to delete
            console.log("No existing session to delete");
        }
        
        // Create anonymous session with Appwrite
        await account.createAnonymousSession();
        
        // Get current user to verify session was created
        const user = await account.get();
        currentUserId = user.$id;
        
        console.log("Anonymous session created successfully:", user);
        
        // Store login method in localStorage
        localStorage.setItem('loginMethod', 'anonymous');
        
        // Hide the auth popup
        hideAuthPopup();
        
        // Continue with app initialization
        completeAppSetup();
        showUserSection();
        
    } catch (error) {
        console.error('Anonymous login error:', error);
        
        // Handle specific error cases
        if (error.code === 401 && error.type === 'user_session_already_exists') {
            // This means we're already logged in, just proceed
            try {
                const user = await account.get();
                currentUserId = user.$id;
                console.log("Already logged in");
                
                // Store login method
                localStorage.setItem('loginMethod', 'anonymous');
                
                // Hide the auth popup
                hideAuthPopup();
                
                // Continue with app initialization
                completeAppSetup();
                showUserSection();
            } catch (getUserError) {
                document.getElementById('loginError').textContent = 'Session conflict. Please refresh the page.';
            }
        } else {
            document.getElementById('loginError').textContent = error.message || 'Failed to create anonymous session.';
        }
    }
}

function initializeAppAfterAuth() {
    // This function will continue with your existing app initialization
    console.log("Auth completed, initializing app...");
    
    // Your existing initialization code
    hljs.highlightAll();
    
    console.log(" App initialization starting...");
    
    // Continue with your existing initialization process
    continueAppInitialization();
}

// Replace your showAuthPopup and hideAuthPopup functions:
function showAuthPopup() {
    const authPopup = document.getElementById('authPopup');
    authPopup.classList.add('visible');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
    
    // Pre-fill email if available
    const storedEmail = localStorage.getItem('userEmail');
    if (storedEmail) {
        document.getElementById('loginEmail').value = storedEmail;
    }
}

function hideAuthPopup() {
    const authPopup = document.getElementById('authPopup');
    authPopup.classList.remove('visible');
    document.body.style.overflow = ''; // Re-enable scrolling
}

// Replace your checkExistingSession function:
async function checkExistingSession() {
    const loginMethod = localStorage.getItem('loginMethod');
    
    if (!loginMethod) {
        console.log("No previous session found");
        // Show auth popup only if no session exists
        setTimeout(() => showAuthPopup(), 100); // Small delay to ensure DOM is ready
        return;
    }
    
    try {
        // Try to get current user to verify session is still valid
        const user = await account.get();
        currentUserId = user.$id;
        
        console.log("Existing session found:", user.email || "Anonymous");
        
        // Continue with app initialization WITHOUT showing popup
        completeAppSetup();
        showUserSection();
        
    } catch (error) {
        console.log("Session expired or invalid:", error);
        
        // Clear invalid session data
        localStorage.removeItem('loginMethod');
        localStorage.removeItem('userEmail');
        
        // Show auth popup only if session is invalid
        setTimeout(() => showAuthPopup(), 100);
    }
}

// Replace your attemptInstantLogin function:
async function attemptInstantLogin() {
    const loginMethod = localStorage.getItem('loginMethod');
    const userEmail = localStorage.getItem('userEmail');
    
    if (loginMethod === 'email' && userEmail) {
        try {
            // Try to automatically login with stored credentials
            const user = await account.get();
            currentUserId = user.$id;
            
            console.log("Auto-login successful:", user.email);
            
            // Continue with app initialization
            completeAppSetup();
            showUserSection();
            
        } catch (error) {
            console.log("Auto-login failed, will show auth popup:", error);
            // Don't show popup immediately, let checkExistingSession handle it
        }
    } else if (loginMethod === 'anonymous') {
        try {
            // Try to restore anonymous session
            const user = await account.get();
            currentUserId = user.$id;
            
            console.log("Anonymous session restored");
            
            // Continue with app initialization
            completeAppSetup();
            showUserSection();
            
        } catch (error) {
            console.log("Anonymous session restore failed:", error);
            // Don't show popup immediately, let checkExistingSession handle it
        }
    }
    // No else needed - checkExistingSession will show popup if no session
}

// Update your continueAppInitialization function:
async function continueAppInitialization() {
    try {
        console.log("Step 0: Loading configuration...");
        const configLoaded = await loadConfig();
        if (!configLoaded) {
            throw new Error("Failed to load configuration");
        }
        
        // Set the configuration values
        SERPAPI_KEY = CONFIG.SERPAPI_KEY || "";
        APPWRITE_ENDPOINT = CONFIG.APPWRITE_ENDPOINT || "";
        APPWRITE_PROJECT_ID = CONFIG.APPWRITE_PROJECT_ID || "";
        APPWRITE_BUCKET_ID = CONFIG.APPWRITE_BUCKET_ID || "";
        APPWRITE_DATABASE_ID = CONFIG.APPWRITE_DATABASE_ID || "";
        APPWRITE_COLLECTION_ID = CONFIG.APPWRITE_COLLECTION_ID || "";
        API_KEY = CONFIG.GEMINI_API_KEY || "";
        currentModel = CONFIG.GEMINI_MODEL || ''; // Fallback to default if not configured
               console.log("GEMINI_MODEL from config:", CONFIG.GEMINI_MODEL);
       console.log("Current model set to:", currentModel);
        // Configure Appwrite client
        client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
        
        // First try instant login, then check session
        await attemptInstantLogin();
        await checkExistingSession();
        
    } catch (initError) {
        console.error(" Critical error during app initialization:", initError);
        document.getElementById('response').innerHTML =
            `<div class="error-message">
                Failed to initialize the application.<br>
                Error: ${initError.message}<br>
                <small>Check console for detailed logs.</small>
            </div>`;
        
        // Show auth popup on critical error too
        setTimeout(() => showAuthPopup(), 100);
    }
}

document.addEventListener("DOMContentLoaded", () => {
    const rotatingButton = document.querySelector(".rotating-button");
    let currentAngle = 0;
    
    const spinTheButton = () => {
        currentAngle = (currentAngle + 1.5) % 360; // A little slower, a bit more elegant
        rotatingButton.style.setProperty("--angle", `${currentAngle}deg`);
        requestAnimationFrame(spinTheButton);
    };
    
    spinTheButton();
});

// Replace your existing DOMContentLoaded with this:
document.addEventListener('DOMContentLoaded', function() {
    
     // Initialize the auth popup first (it will always show)
 initializeAuthPopup();
 initializeAttachmentPopup();
 initializeButtonVisibility();
 
     // Make sure popup is hidden initially
    const authPopup = document.getElementById('authPopup');
    authPopup.classList.remove('visible');
    
 
 // Initialize user section
 initializeUserSection();
 monitorFileInput();
 // In your DOMContentLoaded or initialization function:
initializeImageGeneration();

 // Start the app initialization process (but don't check for sessions)
    // Initialize the auth popup first (it will always show)
    
    // Start the app initialization process (but don't check for sessions)
    continueAppInitialization();
    
     // Setup file input listener
 setupFileInputListener();
 
 // Add direct click handler as backup
 const fileInput = document.getElementById('fileInput');
 if (fileInput) {
     fileInput.addEventListener('click', function(e) {
         console.log("File input clicked");
     });
     
     // This ensures the change event works even if other code interferes
     fileInput.onchange = function(e) {
         console.log("File input onchange triggered");
         console.log("Files selected:", e.target.files.length);
         handleFileSelect(e);
     };
 }
 
 setTimeout(testFileInput, 10000);
});

// Add this function to be called after authentication
async function completeAppSetup() {
    try {
        console.log("Step 2: Loading conversations...");
        await loadConversationsFromAppwrite();
        console.log(" Conversations loaded:", conversations.length);
        
        console.log("Step 3: Rendering conversation list...");
        renderConversationList();
        console.log(" Conversation list rendered.");
        
        console.log("Step 4: Setting up UI...");
        document.getElementById('new-chat-btn').addEventListener('click', startNewConversation);
        startNewConversation();
        initializeCameraUI();
        console.log(" UI setup complete.");
    } catch (error) {
        console.error("Error completing app setup:", error);
    }
}


completeAppSetup();
// User info and logout functionality
function initializeUserSection() {
    const userInfoSection = document.getElementById('userInfoSection');
    const sidebarLogoutBtn = document.getElementById('sidebarLogoutBtn');
    
    // Add logout functionality
    sidebarLogoutBtn.addEventListener('click', handleLogout);
    
    // Check if user is logged in and update UI
    updateUserInfo();
}


async function updateUserInfo() {
    const userInfoSection = document.getElementById('userInfoSection');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userAvatar = document.getElementById('userAvatar');
    
    try {
        const user = await account.get();
        
        // Show user section
        userInfoSection.style.display = 'flex';
        
        // Get stored email for display (in case user object doesn't have it)
        const storedEmail = localStorage.getItem('userEmail');
        
        if (user.email || storedEmail) {
            // Registered user
            const displayEmail = user.email || storedEmail;
            userEmail.textContent = displayEmail;
            
            // Extract name from email (everything before @)
            const nameFromEmail = displayEmail.split('@')[0];
            // Capitalize first letter
            userName.textContent = nameFromEmail.charAt(0).toUpperCase() + nameFromEmail.slice(1);
            
            // Create initials for avatar
            const initials = nameFromEmail.substring(0, 2).toUpperCase();
            userAvatar.innerHTML = initials;
            userAvatar.style.background = generateColorFromString(displayEmail);
            
        } else {
            // Anonymous user
            userEmail.textContent = 'Anonymous User';
            userName.textContent = 'Guest';
            userAvatar.innerHTML = 'G';
            userAvatar.style.background = generateColorFromString('anonymous');
        }
        
    } catch (error) {
        console.log('User not logged in, hiding user section');
        userInfoSection.style.display = 'none';
    }
}

function generateColorFromString(str) {
    // Generate a consistent color based on the string
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hue = hash % 360;
    return `hsl(${hue}, 65%, 60%)`;
}




// Update your handleLogout function to show popup on logout
async function handleLogout() {
 try {
  await account.deleteSession('current');
  console.log("Logged out successfully");
  
  // Clear stored login information
  localStorage.removeItem('loginMethod');
  localStorage.removeItem('userEmail');
  
  // Hide user section
  document.getElementById('userInfoSection').style.display = 'none';
  
  // Show auth popup again
  showAuthPopup();
  
  // Clear conversations
  conversations = [];
  renderConversationList();
  
  // Reset current conversation
  currentConversationId = null;
  currentMessages = [];
  
  // Show home greeting
  document.getElementById('response').innerHTML = `
            <div class="home-greeting" id="homeGreeting">
                <img src="https://i.ibb.co/m35mFtZ/image-4.png" alt="Bot Logo">
                <h2>Hello there!</h2>
                <p>How can I help you today?</p>
            </div>
        `;
  
  console.log("User logged out successfully");
  
 } catch (error) {
  console.error('Logout error:', error);
  alert('Failed to logout. Please try again.');
 }
}



// Call this function after successful authentication
function showUserSection() {
    updateUserInfo();
}

// Modify your authentication success handlers to show user section
// In handleLogin and handleAnonymous functions, add this after completeAppSetup():
showUserSection();

//const API_KEY = 'AIzaSyB_s-KicZoL9Z-3YT9Wr7PfsUU8inKGYSI';
let currentModel = '';
let isThinking = false;
let isSearching = false; // New flag for search state

// --- Camera Capture Logic Variables ---
let cameraStream = null;
let capturedBlob = null; // Store the captured image blob
let cameraModal = null;
let viewfinder = null;
let videoElement = null;
let captureSpinner = null;
let controls = null;
let captureBtn = null;
let cancelBtn = null;
// --- End Camera Capture Logic Variables ---


// Add this function to monitor for DOM changes
function monitorFileInput() {
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                for (let node of mutation.removedNodes) {
                    if (node.id === 'fileInput') {
                        console.log("File input was removed from DOM");
                        createFileInput();
                    }
                }
                
                for (let node of mutation.addedNodes) {
                    if (node.id === 'fileInput') {
                        console.log("File input was added to DOM");
                        setupFileInputListener();
                    }
                }
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
}

// Function to test if a file is accessible from Appwrite
async function testFileAccessibility(fileId, fileName) {
    try {
        if (!fileId) {
            console.error("No fileId provided to testFileAccessibility");
            return false;
        }
        
        const fileUrl = getAppwriteFileUrl(fileId);
        if (!fileUrl) {
            console.error("Could not generate URL for file:", fileName);
            return false;
        }
        
        console.log("Testing accessibility of:", fileUrl);
        
        // Try to fetch the file
        const response = await fetch(fileUrl, { method: 'HEAD' });
        console.log("File accessibility test result:", response.status, response.statusText);
        
        if (!response.ok) {
            console.error("File is not accessible. Status:", response.status);
            return false;
        }
        
        console.log("File is accessible:", fileName);
        return true;
    } catch (error) {
        console.error("Error testing file accessibility:", error);
        return false;
    }
}

// Add this to your existing JavaScript code
function setupWebViewDownloadHandlers() {
    // Override download functions for WebView
    if (typeof Android !== 'undefined') {
        console.log("Android WebView detected - setting up download handlers");
        
        // Override conversation download
        const originalDownloadConversation = window.downloadConversation;
        if (originalDownloadConversation) {
            window.downloadConversation = function(conversationId) {
                const conversation = conversations.find(c => c.id === conversationId);
                if (!conversation) return;
                
                let conversationText = `Nurvle Conversation\n`;
                conversationText += `Title: ${conversation.title || 'Untitled'}\n`;
                conversationText += `Date: ${new Date(conversation.timestamp).toLocaleDateString()}\n`;
                conversationText += `Time: ${new Date(conversation.timestamp).toLocaleTimeString()}\n`;
                conversationText += '='.repeat(50) + '\n\n';
                
                conversation.messages.forEach((message, index) => {
                    const isUser = message.role === 'user';
                    const sender = isUser ? 'USER' : 'ASSISTANT';
                    const content = message.content || '';
                    
                    if (index > 0) {
                        conversationText += '\n' + '-'.repeat(50) + '\n\n';
                    }
                    
                    conversationText += `${sender}:\n`;
                    conversationText += content + '\n';
                    
                    if (isUser && message.files && message.files.length > 0) {
                        conversationText += '\nAttachments:\n';
                        message.files.forEach(file => {
                            conversationText += `- ${file.name} (${file.type}, ${(file.size / 1024).toFixed(2)} KB)\n`;
                        });
                    }
                });
                
                conversationText += '\n' + '='.repeat(50) + '\n';
                conversationText += 'End of conversation\n';
                
                const fileName = `nurvle_conversation_${conversationId}_${Date.now()}.txt`;
                Android.downloadTextFile(conversationText, fileName);
            };
        }
        
        // Override image download
        const originalDownloadGeneratedImage = window.downloadGeneratedImage;
        if (originalDownloadGeneratedImage) {
            window.downloadGeneratedImage = function(imageUrl, prompt) {
                const safePrompt = prompt.toLowerCase().replace(/[^a-z0-9]/g, '_').substring(0, 30);
                const fileName = `generated_${safePrompt}_${Date.now()}.png`;
                Android.downloadImageFromUrl(imageUrl, fileName);
            };
        }
const originalDownloadResponse = window.downloadResponse;
if (originalDownloadResponse) {
    window.downloadResponse = function(messageId, content) {
        const safeContent = content || 'Response content';
        const fileName = `nurvle_response_${messageId || Date.now()}.txt`;
        if (typeof Android !== 'undefined') {
            Android.downloadTextFile(safeContent, fileName);
        }
    };
}
    }
}
document.addEventListener('DOMContentLoaded', function() {
    setupWebViewDownloadHandlers();
});


// Initialize image generation
function initializeImageGeneration() {
    const imageGenBtn = document.getElementById('image-gen-btn');
    
    if (imageGenBtn) {
        imageGenBtn.addEventListener('click', toggleImageGenerationMode);
    }
}

// Toggle image generation mode
function toggleImageGenerationMode() {
    const imageGenBtn = document.getElementById('image-gen-btn');
    const userInput = document.getElementById('userInput');
    
    isImageGenerationMode = !isImageGenerationMode;
    
    if (isImageGenerationMode) {
        imageGenBtn.classList.add('active');
        imageGenBtn.title = "Image Generation Enabled - Click to disable";
        userInput.placeholder = "Describe the image...";
    } else {
        imageGenBtn.classList.remove('active');
        imageGenBtn.title = "Generate Image";
        userInput.placeholder = "Ask anything";
    }
}
async function generateImageWithPollination(prompt) {
    try {
        // Clean the prompt
        const cleanPrompt = prompt.trim();
        
        if (!cleanPrompt) {
            throw new Error('Please enter a prompt');
        }
        
        console.log("Generating image with prompt:", cleanPrompt);
        
        // Build the Pollinations.ai URL
        const imageUrl = buildPollinationsUrl(cleanPrompt);
        console.log("Image URL:", imageUrl);
        
        // Create image element and wait for it to load
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.alt = `Generated image: ${cleanPrompt}`;
        img.className = 'generated-image';
        
        // Wait for image to load or fail
        await new Promise((resolve, reject) => {
            img.onload = () => {
                console.log("Image loaded successfully");
                resolve();
            };
            
            img.onerror = (err) => {
                console.error("Image failed to load:", err);
                reject(new Error('Failed to generate image. The service might be busy. Please try again.'));
            };
            
            // Start loading the image
            img.src = imageUrl;
        });
        
        // Display the generated image
        displayGeneratedImage(img, cleanPrompt, imageUrl);
        
        return { success: true, imageUrl: imageUrl };
        
    } catch (error) {
        console.error('Image generation error:', error);
        throw error;
    }
}

// Alternative: Add timestamp for even more uniqueness
function buildPollinationsUrl(prompt) {
    const baseUrl = 'https://image.pollinations.ai/prompt/';
    
    // Add timestamp to ensure uniqueness
    const timestamp = Date.now();
    
    const formattedPrompt = prompt
        .replace(/[^\w\s.,!?-]/g, '')
        .replace(/\s+/g, '%20');
    
    // Add unique identifier
    return baseUrl + encodeURIComponent(formattedPrompt + ` variation:${timestamp}`);
}

// Updated downloadGeneratedImage function
async function downloadGeneratedImage(imageUrl, prompt) {
    try {
        console.log("Starting download process for:", imageUrl);
        
        // Create a safe filename from the prompt
        const safePrompt = prompt
            .toLowerCase()
            .replace(/[^a-z0-9]/g, '_')
            .substring(0, 30);
        
        const filename = `Nurvle_Image_${Date.now()}.png`;
        
        // Method 1: Try to fetch as blob first (for higher quality)
        try {
            const response = await fetch(imageUrl);
            
            if (response.ok) {
                const blob = await response.blob();
                
                // Create a download link
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Clean up the URL object
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
                
                console.log("Image downloaded successfully via blob method");
                return;
            }
        } catch (fetchError) {
            console.log("Fetch method failed, trying alternative method:", fetchError);
        }
        
        // Method 2: Alternative approach for direct download
        const a = document.createElement('a');
        a.href = imageUrl;
        a.download = filename;
        a.style.display = 'none';
        
        // Add a timestamp parameter to avoid caching issues
        if (imageUrl.includes('?')) {
            a.href = imageUrl + '&download=' + Date.now();
        } else {
            a.href = imageUrl + '?download=' + Date.now();
        }
        
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        
        console.log("Image download initiated via direct method");
        
    } catch (error) {
        console.error('Download failed:', error);
        
        // Final fallback: open in new tab for manual download
        window.open(imageUrl, '_blank');
        showNotification("Download failed. Image opened in new tab - you can save it manually.");
    }
}

// Helper function to convert blob to base64
function blobToBase64(blob) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            // Remove the data URL prefix to get just the base64 data
            const base64 = reader.result.split(',')[1];
            resolve(base64);
        };
        reader.onerror = reject;
        reader.readAsDataURL(blob);
    });
}
// Function to download generated image
function downloadImage(base64Image, prompt) {
    const link = document.createElement('a');
    link.href = `data:image/png;base64,${base64Image}`;
    
    // Create a safe filename from the prompt
    const safePrompt = prompt
        .toLowerCase()
        .replace(/[^a-z0-9]/g, '_')
        .substring(0, 30);
    
    link.download = `generated_image_${safePrompt}_${Date.now()}.png`;
    link.click();
}

function createGeneratedImageContainer(imageUrl, prompt) {
    const timestamp = Date.now();
    const containerId = `img_${timestamp}`;
    
    const imageContainer = document.createElement('div');
    imageContainer.className = 'generated-image-container';
    imageContainer.id = containerId;
    imageContainer.dataset.prompt = prompt;
    imageContainer.dataset.timestamp = timestamp;
    
    // Create zoomable image wrapper
    const zoomWrapper = document.createElement('div');
    zoomWrapper.className = 'zoomable-image-wrapper';
    zoomWrapper.style.position = 'relative';
    zoomWrapper.style.display = 'inline-block';
    zoomWrapper.style.maxWidth = '90%';
    zoomWrapper.style.cursor = 'zoom-in';
    
    // Create main image
    const img = document.createElement('img');
    img.src = imageUrl;
    img.alt = `Generated image: ${prompt}`;
    img.className = 'generated-image zoomable-image';
    img.style.width = '100%';
    img.style.height = 'auto';
    img.style.borderRadius = '10px';
    img.style.transition = 'transform 0.3s ease';
    
    // Create zoom box
    const zoomBox = document.createElement('div');
    zoomBox.className = 'image-zoom-box';
    zoomBox.style.cssText = `
        position: absolute;
        display: none;
        width: 150px;
        height: 150px;
        overflow: hidden;
        border: none;
        background-color: var(--basic-color);
        border-radius: 15px;
        z-index: 1000;
        pointer-events: none;
    `;
    
    const zoomImage = document.createElement('img');
    zoomImage.src = imageUrl;
    zoomImage.alt = `Zoomed: ${prompt}`;
    zoomImage.style.cssText = `
        position: absolute;
        width: 600px;
        height: 600px;
        object-fit: cover;
        border-radius: 6px;
        border: none;
    `;
    
    zoomBox.appendChild(zoomImage);
    zoomWrapper.appendChild(img);
    zoomWrapper.appendChild(zoomBox);
    
    // Zoom functionality
    function handleZoom(e, isTouch = false) {
        const wrapperRect = zoomWrapper.getBoundingClientRect();
        let x, y;
        
        if (isTouch) {
            const touch = e.touches[0];
            x = touch.clientX - wrapperRect.left;
            y = touch.clientY - wrapperRect.top;
        } else {
            x = e.clientX - wrapperRect.left;
            y = e.clientY - wrapperRect.top;
        }
        
        // Show the zoom box
        zoomBox.style.display = 'block';
        
        // Position the zoom box (offset from cursor)
        const zoomBoxOffset = 20;
        zoomBox.style.left = `${x + zoomBoxOffset}px`;
        zoomBox.style.top = `${y + zoomBoxOffset}px`;
        
        // Ensure the zoom box stays within viewport
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        const zoomBoxRect = zoomBox.getBoundingClientRect();
        
        if (x + zoomBoxOffset + zoomBoxRect.width > viewportWidth) {
            zoomBox.style.left = `${x - zoomBoxOffset - zoomBoxRect.width}px`;
        }
        if (y + zoomBoxOffset + zoomBoxRect.height > viewportHeight) {
            zoomBox.style.top = `${y - zoomBoxOffset - zoomBoxRect.height}px`;
        }
        
        // Adjust the zoomed image position
        const zoomFactor = 3; // 3x zoom
        zoomImage.style.left = `${-x * zoomFactor + zoomBoxRect.width / 2}px`;
        zoomImage.style.top = `${-y * zoomFactor + zoomBoxRect.height / 2}px`;
    }
    
    function hideZoomBox() {
        zoomBox.style.display = 'none';
    }
    
    // Event listeners for mouse
    zoomWrapper.addEventListener('mousemove', (e) => handleZoom(e, false));
    zoomWrapper.addEventListener('mouseleave', hideZoomBox);
    zoomWrapper.addEventListener('mouseenter', () => {
    });
    zoomWrapper.addEventListener('mouseleave', () => {
        hideZoomBox();
    });
    
    // Event listeners for touch
    zoomWrapper.addEventListener('touchmove', (e) => {
        e.preventDefault();
        handleZoom(e, true);
    });
    zoomWrapper.addEventListener('touchend', hideZoomBox);
    zoomWrapper.addEventListener('touchcancel', hideZoomBox);
    
    const actionButtons = document.createElement('div');
    actionButtons.className = 'image-action-buttons';
    
    // Download button
    const downloadBtn = document.createElement('button');
    downloadBtn.className = 'image-action-btn';
    downloadBtn.innerHTML = '<svg width="19" height="19" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"> <path d="M6.3414 6.15897C7.16507 3.73597 9.38755 2 12 2C15.3137 2 18 4.79305 18 8.23846C20.2091 8.23846 22 10.1005 22 12.3974C22 13.9368 21.1956 15.2809 20 16M6.32069 6.20644C3.8806 6.55106 2 8.72597 2 11.3576C2 13.0582 2.7854 14.5682 3.99965 15.5167" stroke="var(--basic-reverse-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /> <path d="M8 18L12 22M12 22L16 18M12 22V12" stroke="var(--svgcolor)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>';
    downloadBtn.onclick = () => downloadGeneratedImage(imageUrl, prompt);
    
    // Open full button
    const openFullBtn = document.createElement('button');
    openFullBtn.className = 'image-action-btn';
    openFullBtn.innerHTML = '<svg width="22" height="22" viewBox="0 0 20 20" fill="var(--basic-reverse-color)" xmlns="http://www.w3.org/2000/svg" aria-label=""><path d="M2.66821 12.6663V12.5003C2.66821 12.1331 2.96598 11.8353 3.33325 11.8353C3.70052 11.8353 3.99829 12.1331 3.99829 12.5003V12.6663C3.99829 13.3772 3.9992 13.8707 4.03052 14.2542C4.0612 14.6298 4.11803 14.8413 4.19849 14.9993L4.2688 15.1263C4.44511 15.4137 4.69813 15.6481 5.00024 15.8021L5.13013 15.8577C5.2739 15.9092 5.46341 15.947 5.74536 15.97C6.12888 16.0014 6.62221 16.0013 7.33325 16.0013H12.6663C13.3771 16.0013 13.8707 16.0014 14.2542 15.97C14.6295 15.9394 14.8413 15.8825 14.9993 15.8021L15.1262 15.7308C15.4136 15.5545 15.6481 15.3014 15.802 14.9993L15.8577 14.8695C15.9091 14.7257 15.9469 14.536 15.97 14.2542C16.0013 13.8707 16.0012 13.3772 16.0012 12.6663V12.5003C16.0012 12.1332 16.2991 11.8355 16.6663 11.8353C17.0335 11.8353 17.3313 12.1331 17.3313 12.5003V12.6663C17.3313 13.3553 17.3319 13.9124 17.2952 14.3626C17.2624 14.7636 17.1974 15.1247 17.053 15.4613L16.9866 15.6038C16.7211 16.1248 16.3172 16.5605 15.8215 16.8646L15.6038 16.9866C15.227 17.1786 14.8206 17.2578 14.3625 17.2952C13.9123 17.332 13.3553 17.3314 12.6663 17.3314H7.33325C6.64416 17.3314 6.0872 17.332 5.63696 17.2952C5.23642 17.2625 4.87552 17.1982 4.53931 17.054L4.39673 16.9866C3.87561 16.7211 3.43911 16.3174 3.13501 15.8216L3.01294 15.6038C2.82097 15.2271 2.74177 14.8206 2.70435 14.3626C2.66758 13.9124 2.66821 13.3553 2.66821 12.6663ZM9.33521 12.5003V4.9388L7.13696 7.13704C6.87732 7.39668 6.45625 7.39657 6.19653 7.13704C5.93684 6.87734 5.93684 6.45631 6.19653 6.19661L9.52954 2.86263L9.6311 2.77962C9.73949 2.70742 9.86809 2.66829 10.0002 2.66829C10.1763 2.66838 10.3454 2.73819 10.47 2.86263L13.804 6.19661C14.0633 6.45628 14.0634 6.87744 13.804 7.13704C13.5443 7.39674 13.1222 7.39674 12.8625 7.13704L10.6653 4.93977V12.5003C10.6651 12.8673 10.3673 13.1652 10.0002 13.1654C9.63308 13.1654 9.33538 12.8674 9.33521 12.5003Z"></path></svg>';
    openFullBtn.onclick = () => {
     open(imageUrl);
    };
    
    actionButtons.appendChild(downloadBtn);
    actionButtons.appendChild(openFullBtn);
    
    // Assemble the container
    imageContainer.appendChild(zoomWrapper);
    imageContainer.appendChild(actionButtons);
    
    return imageContainer;
}

// Updated displayGeneratedImage function
function displayGeneratedImage(imgElement, prompt, imageUrl) {
    const responseDiv = document.getElementById('response');
    
    // Remove any existing loading animations first
    document.querySelectorAll('.image-generation-loading').forEach(loading => {
        loading.remove();
    });
    
    // Create a proper bot message bubble
    const botMessageBubble = document.createElement('div');
    botMessageBubble.className = 'chat-bubble bot-msg';
    
    // Create image container using our new helper function
    const imageContainer = createGeneratedImageContainer(imageUrl, prompt);
    
    // Add the image container to the bot message
    botMessageBubble.appendChild(imageContainer);
    
    // Add the bot message to the response area
    responseDiv.appendChild(botMessageBubble);
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

// Updated displaySavedGeneratedImage function
function displaySavedGeneratedImage(bubble, generatedImage) {
    const { prompt, imageUrl } = generatedImage;
    
    // Clear any existing content in the bubble
    bubble.innerHTML = '';
    // Create image container using our new helper function
    const imageContainer = createGeneratedImageContainer(imageUrl, prompt);
    
    bubble.appendChild(imageContainer);
}

async function handleImageGeneration() {
    const input = document.getElementById('userInput');
    const prompt = input.value.trim();
    const sendBtn = document.getElementById('sendBtn');
    
    if (!prompt) {
        showNotification("Please describe the image you want to generate");
        return;
    }
    
    if (prompt.length < 3) {
        showNotification("Please provide a more detailed description");
        return;
    }
    
    sendBtn.disabled = true;
    
    // Create conversation if it doesn't exist
    if (!currentConversationId) {
        currentConversationId = Date.now().toString();
    }
    
    // Add user message to history
    const userMessage = {
        role: 'user',
        content: ` Generate image: ${prompt}`,
        timestamp: Date.now(),
        isImageGeneration: true,
        imagePrompt: prompt
    };
    
    currentMessages.push(userMessage);
    
    appendMessage(` Generate image: ${prompt}`, 'user-msg');
    
    input.value = '';
    input.style.height = '40px';
    document.getElementById('chatInputArea').style.minHeight = '95px';
    
    const responseDiv = document.getElementById('response');
    const homeGreeting = document.getElementById('homeGreeting');
    if (homeGreeting) homeGreeting.style.display = "none";
    
    const placeholderContainer = document.createElement('div');
    placeholderContainer.className = 'generated-image-container';
    
    const placeholderBox = document.createElement('div');
    placeholderBox.className = 'image-placeholder';
    placeholderBox.innerHTML = `
        <div class="placeholder-content">
       
        </div>
    `;
    
    const placeholderBubble = document.createElement('div');
    placeholderBubble.className = 'chat-bubble bot-msg';
    placeholderBubble.appendChild(placeholderBox);
    responseDiv.appendChild(placeholderBubble);
    responseDiv.scrollTop = responseDiv.scrollHeight;
    
    try {
        const result = await generateImageWithPollination(prompt);
        
        placeholderBubble.remove();
        
        const botMessage = {
            role: 'assistant',
            content: `Here's your generated image: "${prompt}"`,
            timestamp: Date.now(),
            isImageGeneration: true,
            generatedImage: {
                prompt: prompt,
                imageUrl: result.imageUrl,
                timestamp: Date.now()
            }
        };
        
        currentMessages.push(botMessage);
        
        await saveConversation();
        
    } catch (error) {
        console.error('Image generation error:', error);
        
        placeholderBubble.remove();
        
        const errorMessage = {
            role: 'assistant',
            content: ` Failed to generate image: ${error.message}`,
            timestamp: Date.now(),
            isError: true
        };
        
        currentMessages.push(errorMessage);
        appendMessage(` ${error.message}`, 'bot-msg error-message');
        showNotification("Failed to generate image. Please try again.");
        
        await saveConversation();
    } finally {
        sendBtn.disabled = false;
    }
}
async function uploadFileToAppwrite(file) {
    try {
        const response = await storage.createFile(
            APPWRITE_BUCKET_ID,
            'unique()',
            file
        );
        console.log("File uploaded successfully:", response);
        return response.$id; 
    } catch (error) {
        console.error("Error uploading file to Appwrite:", error);
        throw new Error(`Failed to upload file: ${error.message}`);
    }
}

function getAppwriteFileUrl(fileId) {
    try {
        if (!fileId) {
            console.error("No fileId provided to getAppwriteFileUrl");
            return null;
        }
        
        console.log("Getting URL for file ID:", fileId);
        console.log("Bucket ID:", APPWRITE_BUCKET_ID);
        
        const urlObject = storage.getFileView(APPWRITE_BUCKET_ID, fileId);
        console.log("Generated Appwrite URL object:", urlObject);
        
        const urlString = urlObject.toString();
        console.log("URL string:", urlString);
        
        return urlString;
    } catch (error) {
        console.error("Error getting Appwrite file URL:", error);
        return null;
    }
}
function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
            const base64Data = reader.result.split(',')[1];
            resolve(base64Data);
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}
async function saveConversationToAppwrite(conversationData) {
    
    if (!currentConversationId || currentMessages.length === 0) return;

const processedMessages = currentMessages.map(msg => {
    if (msg.role === 'user' && msg.files) {
        const processedFiles = msg.files.map(fileInfo => ({
            name: fileInfo.name,
            type: fileInfo.type,
            size: fileInfo.size,
            fileId: fileInfo.fileId 
        }));
        return {
            ...msg,
            files: processedFiles
        };
    }
    return msg;
});
    
    
    
    if (!currentUserId) {
        console.error("Cannot save conversation: User ID not set.");
        appendMessage(`Error saving conversation: User not authenticated.`, 'bot-msg error-message');
        return;
    }
    
    const dataToSave = {
        ...conversationData,
        userId: currentUserId
    };
    
    try {
        if (dataToSave.$id) {
            await databases.updateDocument(
                APPWRITE_DATABASE_ID,
                APPWRITE_COLLECTION_ID,
                dataToSave.$id,
                dataToSave 
            );
            console.log("Conversation updated in Appwrite DB:", dataToSave.$id);
        } else {
            const response = await databases.createDocument(
                APPWRITE_DATABASE_ID,
                APPWRITE_COLLECTION_ID,
                'unique()',
                dataToSave
            );
            console.log("Conversation created in Appwrite DB:", response.$id);
            conversationData.$id = response.$id;
        }
    } catch (error) {
        console.error("Error saving conversation to Appwrite DB:", error);
        appendMessage(`Error saving conversation: ${error.message}`, 'bot-msg error-message');
    }
}

async function loadConversationsFromAppwrite() {
    
  document.getElementById('sidebar-loading').classList.add('visible');
  
  if (!currentUserId) {
      console.warn("Cannot load conversations: User ID not set.");
      document.getElementById('sidebar-loading').classList.remove('visible');
      return;
  }
    
    try {
        let allConversations = [];
        let currentPage = 0;
        const limit = 100;
        
        while (true) {
            const response = await databases.listDocuments(
                APPWRITE_DATABASE_ID,
                APPWRITE_COLLECTION_ID,
                [
                    Appwrite.Query.equal('userId', currentUserId),
                    Appwrite.Query.orderDesc('$createdAt'),
                    Appwrite.Query.limit(limit),
                    Appwrite.Query.offset(currentPage * limit)
                ]
            );
            
            if (response.documents.length === 0) {
                break;
            }
            
            const pageConversations = response.documents.map(doc => {
                let messages = doc.messages || [];
                if (typeof messages === 'string') {
                    try {
                        messages = JSON.parse(messages);
                    } catch (e) {
                        console.error("Error parsing messages for conversation:", doc.$id, e);
                        messages = [];
                    }
                }
                return {
                    id: doc.conversationId,
                    title: doc.title,
                    preview: doc.preview,
                    messages: messages,
                    timestamp: doc.timestamp || doc.$createdAt,
                    $id: doc.$id
                };
            });
            
            allConversations = allConversations.concat(pageConversations);
            currentPage++;
            
            if (response.documents.length < limit) {
                break;
            }
        }
        
        conversations = allConversations;
        
        conversations.sort((a, b) => {
            const dateA = new Date(a.timestamp);
            const dateB = new Date(b.timestamp);
            return dateB - dateA;
        });
        console.log(`All conversations loaded from Appwrite for user ${currentUserId}:`, conversations.length);
        renderConversationList();
        
    } catch (error) {
        console.error("Error loading conversations from Appwrite DB:", error);
        appendMessage(`Error loading conversations: ${error.message}`, 'bot-msg error-message');
    } finally {
    // Optional safety: hide loader even if error occurs
    document.getElementById('sidebar-loading').classList.remove('visible');
}
}
function testFileInput() {
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        console.log("File input exists:", fileInput);
        console.log("File input attributes:");
        console.log("- multiple:", fileInput.multiple);
        console.log("- accept:", fileInput.accept);
        
        fileInput.onchange = function(e) {
            console.log("Direct onchange handler triggered");
            console.log("Files:", e.target.files.length);
            handleFileSelect(e);
        };
    } else {
      
        createFileInput();
    }
}

function createFileInput() {
    let fileInput = document.getElementById('fileInput');
    if (!fileInput) {
        fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.id = 'fileInput';
        fileInput.multiple = true;
        fileInput.accept = 'image/*,audio/*,.txt,.txt,.html,.css,.js,.py,.doc,.xls,.xlsx,.ppt,.pptx';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        console.log("File input created");
    }
    return fileInput;
}

document.addEventListener('DOMContentLoaded', async function() {
    hljs.highlightAll();
    
    console.log(" App initialization starting...");
    
    try {
        console.log("Step 0: Loading configuration...");
        const configLoaded = await loadConfig();
        if (!configLoaded) {
            throw new Error("Failed to load configuration");
        }
        
        SERPAPI_KEY = CONFIG.SERPAPI_KEY || "";
        APPWRITE_ENDPOINT = CONFIG.APPWRITE_ENDPOINT || "";
        APPWRITE_PROJECT_ID = CONFIG.APPWRITE_PROJECT_ID || "";
        APPWRITE_BUCKET_ID = CONFIG.APPWRITE_BUCKET_ID || "";
        APPWRITE_DATABASE_ID = CONFIG.APPWRITE_DATABASE_ID || "";
        APPWRITE_COLLECTION_ID = CONFIG.APPWRITE_COLLECTION_ID || "";
        API_KEY = CONFIG.GEMINI_API_KEY || "";
        
        client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT_ID);
        
        console.log("Step 1: Trying anonymous login...");
    
        console.log(" Anonymous login success. Current User ID:", currentUserId);
        
        console.log("Step 2: Loading conversations...");
        await loadConversationsFromAppwrite();
        console.log(" Conversations loaded:", conversations.length);
        
        console.log("Step 3: Rendering conversation list...");
        renderConversationList();
        console.log(" Conversation list rendered.");
        
        console.log("Step 4: Setting up UI...");
        document.getElementById('new-chat-btn').addEventListener('click', startNewConversation);
        startNewConversation();
        
        initializeCameraUI();
        initializeUI();
        setupFileInputListener();
        monitorFileInput();
        initializeAttachmentPopup();
initializeImageGeneration();
        setTimeout(testFileInput, 20000);

        console.log(" UI setup complete.");
        
    } catch (initError) {
        console.error(" Critical error during app initialization:", initError);
     //   document.getElementById('response').innerHTML =
       //     `<div class="error-message">
         //       Failed to initialize the application.<br>
           //     Error: ${initError.message}<br>
             //   <small>Check console for detailed logs.</small>
      //      </div>`;
    }
    
 setupFileInputListener();
 
 const fileInput = document.getElementById('fileInput');
 if (fileInput) {
     fileInput.addEventListener('click', function(e) {
         console.log("File input clicked");
     });
     
     fileInput.onchange = function(e) {
         console.log("File input onchange triggered");
         console.log("Files selected:", e.target.files.length);
         handleFileSelect(e);
     };
 }
});

function setupFileInputListener() {
    if (!fileInputInitialized) {
        document.addEventListener('change', function(e) {
            if (e.target && e.target.id === 'fileInput') {
                console.log("File input change detected");
                console.log("Files selected:", e.target.files.length);
                handleFileSelect(e);
            }
        });
        
        fileInputInitialized = true;
        console.log("Global file input listener setup completed");
    }
    
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.setAttribute('multiple', '');
        fileInput.setAttribute('accept', 'image/*,audio/*,.txt,.txt,.html,.css,.js,.py,.doc,.xls,.xlsx,.ppt,.pptx');
    }
}


function initializeButtonVisibility() {
    toggleSendButtonVisibility();
    
    setTimeout(() => {
        toggleSendButtonVisibility();
    }, 100);
}
function toggleSendButtonVisibility() {
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('mic-btn');
    
    if (!userInput || !sendBtn || !micBtn) return;
    
    const hasText = userInput.value.trim().length > 0 || selectedFiles.length > 0;
    
    if (hasText) {
        sendBtn.classList.remove('hidden');
        micBtn.classList.add('hidden');
    } else {
        sendBtn.classList.add('hidden');
        micBtn.classList.remove('hidden');
    }
}

function setupEventListeners() {
    const userInput = document.getElementById('userInput');
    if (userInput) {
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            
            toggleSendButtonVisibility();
        });
        
        userInput.addEventListener('paste', function() {
            setTimeout(() => {
                toggleSendButtonVisibility();
            }, 0);
        });
    }
    
        const attachButton = document.getElementById('attachButton');
    if (attachButton && !attachButtonInitialized) {
        attachButton.addEventListener('click', (e) => {
            e.preventDefault();
            console.log("Attach button clicked");
            
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.multiple = true;
            fileInput.accept = 'image/*,audio/*,.pdf,.txt,.html,.css,.js,.py,.doc,.xls,.xlsx,.ppt,.pptx';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function(e) {
                console.log("File input change event triggered");
                console.log("Files selected:", e.target.files.length);
                handleFileSelect(e);
                
                document.body.removeChild(fileInput);
            });
            
            setTimeout(() => {
                if (document.body.contains(fileInput)) {
                    document.body.removeChild(fileInput);
                    console.log("File input cleaned up (likely cancelled)");
                }
            }, 1000);
        });
        
        attachButtonInitialized = true;
        console.log("Attach button event listener setup completed");
    }
    
    
    const sendButton = document.getElementById('sendBtn');
    if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
    }
    
    const cameraBtn = document.getElementById('camera-btn');
    if (cameraBtn) {
        cameraBtn.addEventListener('click', openCamera);
    }
}
function showFileLimitPopup(message) {
    const popup = document.createElement('div');
    popup.className = 'file-limit-popup';
    popup.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        <span>${message}</span>
    `;
    document.body.appendChild(popup);
    setTimeout(() => {
        popup.remove();
    }, 3000);
}
function handleFileSelect(e) {
    console.log("handleFileSelect function called");
    
    const MAX_FILES = 5;
    const MAX_SIZE_MB = 4;
    const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;
    const files = Array.from(e.target.files);
    
    console.log("Processing files:", files.length);
    
    if (selectedFiles.length + files.length > MAX_FILES) {
        showFileLimitPopup(`Maximum ${MAX_FILES} files allowed per message`);
        return;
    }
    
    files.forEach(file => {
        console.log("Processing file:", file.name, file.size, file.type);
        if (file.size > MAX_SIZE_BYTES) {
            showFileLimitPopup(`File "${file.name}" exceeds ${MAX_SIZE_MB}MB limit`);
            return;
        }
        if (!selectedFiles.some(f => f.name === file.name && f.size === file.size)) {
            selectedFiles.push({
                file: file,
                id: `temp_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                name: file.name,
                type: file.type,
                size: file.size,
                fileId: null
            });
        }
    });
    
    console.log("Selected files count:", selectedFiles.length);
    updatePreview();
    toggleSendButtonVisibility();
}

function updatePreview() {
    const previewContainer = document.getElementById('previewContainer');
    previewContainer.innerHTML = '';
    if (selectedFiles.length === 0) {
        previewContainer.style.display = 'none';
        return;
    }
    previewContainer.style.display = 'flex';
    selectedFiles.forEach((fileInfo, index) => {
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        previewItem.dataset.fileId = fileInfo.id;
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-file';
        removeBtn.innerHTML = '';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeFile(index);
        };
        const fileType = getFileType(fileInfo);
        const fileIcon = document.createElement('div');
        fileIcon.className = `file-icon ${fileType.class}`;
        fileIcon.innerHTML = fileType.icon;
        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.textContent = fileInfo.name.length > 20 ?
            fileInfo.name.substring(0, 17) + '...' :
            fileInfo.name;
        const progressBarContainer = document.createElement('div');
        progressBarContainer.className = 'progress-bar-container';
        progressBarContainer.style.display = 'none';
        const progressBar = document.createElement('div');
        progressBar.className = 'progress-bar';
        progressBar.style.width = '0%';
        progressBarContainer.appendChild(progressBar);
        previewItem.appendChild(fileIcon);
        previewItem.appendChild(fileName);
        previewItem.appendChild(removeBtn);
        previewItem.appendChild(progressBarContainer); 
        if (fileInfo.type.match('image.*')) {
            fileIcon.className = 'file-icon';
            fileIcon.innerHTML = '<i style="color: #14B8A6;" class="fas fa-file-image"></i>';
            if (fileInfo.file) {
    previewItem.style.cursor = 'pointer';
    previewItem.onclick = () => {
        try {
            const localUrl = URL.createObjectURL(fileInfo.file);
            viewImageFromUrl({ href: localUrl });
            // Revoking the URL after a delay or when the overlay is closed
            // A robust way would be revoking it when the overlay's 'load' event fires on the image inside viewImageFromUrl
            // For simplicity, revoking it after a short delay assuming the image loads quickly.
            // A better approach would be to modify viewImageFromUrl to handle local URLs or add a callback.
            // setTimeout(() => URL.revokeObjectURL(localUrl), 10000); // Revoke after 10 seconds, adjust as needed
            // Or revokibg when the image loads inside viewImageFromUrl
        } catch (error) {
            console.error("Error creating local URL for preview image:", error);
            alert("Could not preview the image.");
        }
    };
} else {
    previewItem.style.cursor = 'default';
    previewItem.onclick = null;
}
        }
        previewContainer.appendChild(previewItem);
    });
}
function getFileType(fileInfo) {
    const extension = fileInfo.name.split('.').pop().toLowerCase();
    const mimeType = fileInfo.type;
    const types = {
        zip: {
            icon: '<i class="fas fa-file-archive"></i>',
            class: 'file-type-zip'
        },
        pdf: {
            icon: '<i class="fas fa-file-pdf"></i>',
            class: 'file-type-pdf'
        },
        doc: {
            icon: '<i class="fas fa-file-word"></i>',
            class: 'file-type-doc'
        },
        xls: {
            icon: '<i class="fas fa-file-excel"></i>',
            class: 'file-type-xls'
        },
        ppt: {
            icon: '<i class="fas fa-file-powerpoint"></i>',
            class: 'file-type-ppt'
        },
        txt: {
            icon: '<i class="fas fa-file-alt"></i>',
            class: 'file-type-txt'
        },
        audio: {
            icon: '<i class="fas fa-file-audio"></i>',
            class: 'file-type-audio'
        },
        video: {
            icon: '<i class="fas fa-file-video"></i>',
            class: 'file-type-video'
        },
        image: {
            icon: '<i class="fas fa-file-image"></i>',
            class: 'file-type-img'
        },
        default: {
            icon: '<i class="fas fa-file"></i>',
            class: 'file-type-default'
        }
    };
    if (['zip', 'rar', '7z', 'tar', 'gz'].includes(extension) ||
        mimeType.includes('application/zip') ||
        mimeType.includes('application/x-zip-compressed')) {
        return types.zip;
    }
    if (extension === 'pdf' || mimeType.includes('application/pdf')) {
        return types.txt;
    }
    if (['doc', 'docx'].includes(extension) ||
        mimeType.includes('application/msword') ||
        mimeType.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
        return types.doc;
    }
    if (['xls', 'xlsx'].includes(extension) ||
        mimeType.includes('application/vnd.ms-excel') ||
        mimeType.includes('application/vnd.openxmlformats-officedocument.spreadsheetml.sheet')) {
        return types.xls;
    }
    if (['ppt', 'pptx'].includes(extension) ||
        mimeType.includes('application/vnd.ms-powerpoint') ||
        mimeType.includes('application/vnd.openxmlformats-officedocument.presentationml.presentation')) {
        return types.ppt;
    }
    if (extension === 'txt' || mimeType.includes('text/plain')) {
        return types.txt;
    }
    if (mimeType.includes('audio/')) {
        return types.audio;
    }
    if (mimeType.includes('video/')) {
        return types.video;
    }
    if (mimeType.includes('image/')) {
        return types.image;
    }
    return types.default;
}
function viewImageFromUrl(url) {
    if (!url) return;
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100%';
    overlay.style.height = '100%';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.8)';
    overlay.style.display = 'flex';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.zIndex = '1000';
    overlay.style.cursor = 'pointer';
    
    const img = document.createElement('img');
    img.src = typeof url === 'string' ? url : url.href;
    img.style.maxWidth = '90%';
    img.style.maxHeight = '90%';
    img.style.objectFit = 'contain';
    img.style.borderRadius = '8px';
    
    overlay.appendChild(img);
    overlay.onclick = () => overlay.remove();
    document.body.appendChild(overlay);
}
function removeFile(index) {
    selectedFiles.splice(index, 1);
    updatePreview();
    toggleSendButtonVisibility();
}
function showThinkingAnimation() {
    if (isThinking || isSearching) return;
    isThinking = true;
    const thinkingDiv = document.createElement('div');
    thinkingDiv.className = 'chat-bubble bot-msg thinking-animation';
    thinkingDiv.innerHTML = `
        <div class="thinking-dot"></div>
        <div class="thinking-dot"></div>
        <div class="thinking-dot"></div>
    `;
    const responseDiv = document.getElementById('response');
    if (responseDiv) {
        responseDiv.appendChild(thinkingDiv);
        responseDiv.scrollTop = responseDiv.scrollHeight;
    }
}
function hideThinkingAnimation() {
    isThinking = false;
    const thinkingElements = document.querySelectorAll('.thinking-animation:not(.searching-animation)');
    thinkingElements.forEach(el => el.remove());
}
function showSearchingAnimation() {
    if (isSearching || isThinking) return;
    isSearching = true;
    const searchingDiv = document.createElement('div');
    searchingDiv.className = 'chat-bubble bot-msg thinking-animation searching-animation';
    searchingDiv.innerHTML = `
     <div class="company-name">Searching...</div>
        <div class="searching-spinner"></div>
    `;
    const responseDiv = document.getElementById('response');
    if (responseDiv) {
        responseDiv.appendChild(searchingDiv);
        responseDiv.scrollTop = responseDiv.scrollHeight;
    }
}

function hideSearchingAnimation() {
    isSearching = false;
    const searchingElements = document.querySelectorAll('.searching-animation');
    searchingElements.forEach(el => el.remove());
}


function startNewConversation() {
    currentConversationId = Date.now().toString();
    currentMessages = [];
    document.getElementById('response').innerHTML = `
        <div class="home-greeting" id="homeGreeting">

   <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 499" width="100" height="100">
     <path d="M0 0 C1.15749756 0.41390991 1.15749756 0.41390991 2.33837891 0.83618164 C6.9527187 2.63536985 10.15169143 4.60393477 13.3125 8.5625 C14.77638947 12.67265119 14.77112681 16.39045371 13.1875 20.4375 C10.95985225 22.96216745 9.45933047 24.30376781 6.3125 25.5625 C0.66778211 25.13659674 -4.33852547 23.91669752 -9.6875 22.125 C-21.81016321 18.1354126 -32.89068345 16.38383758 -45.6875 16.375 C-46.62078125 16.36275391 -47.5540625 16.35050781 -48.515625 16.33789062 C-59.97699258 16.31387938 -70.7036802 18.7376297 -79.4375 26.625 C-90.54288099 38.72802751 -91.32897458 53.9694515 -90.78808594 69.48828125 C-88.724703 112.03804208 -59.04691987 156.32690507 -32.35009766 187.60742188 C-30.78362856 189.44946072 -29.23857814 191.30716853 -27.69921875 193.171875 C-16.86457641 206.19976478 -4.98635435 218.05659003 8.3125 228.5625 C10.85341319 230.62236316 13.36802622 232.71152682 15.875 234.8125 C16.48359863 235.3084668 17.09219727 235.80443359 17.71923828 236.31542969 C21.02750657 239.10124109 23.21254174 241.22094288 24.3125 245.5625 C24.1091595 250.4426721 22.69872417 253.07952657 19.3125 256.5625 C16.50555056 258.69190992 15.35040391 258.5658249 11.75 258.25 C8.3125 257.5625 8.3125 257.5625 5.3125 256.5625 C5.3125 255.9025 5.3125 255.2425 5.3125 254.5625 C4.59707031 254.32917969 3.88164062 254.09585937 3.14453125 253.85546875 C-0.20710607 252.32527295 -2.32482449 250.40306021 -5 247.875 C-5.9590625 246.98039063 -6.918125 246.08578125 -7.90625 245.1640625 C-8.8240625 244.30554688 -9.741875 243.44703125 -10.6875 242.5625 C-12.11803768 241.28383447 -13.55465176 240.01190019 -15 238.75 C-15.62519531 238.2034375 -16.25039062 237.656875 -16.89453125 237.09375 C-18.63217493 235.60974929 -20.40490498 234.17940021 -22.1875 232.75 C-23.0125 232.028125 -23.8375 231.30625 -24.6875 230.5625 C-24.6875 229.9025 -24.6875 229.2425 -24.6875 228.5625 C-26.6675 227.5725 -26.6675 227.5725 -28.6875 226.5625 C-28.6875 225.9025 -28.6875 225.2425 -28.6875 224.5625 C-29.28175781 224.3046875 -29.87601562 224.046875 -30.48828125 223.78125 C-32.88052503 222.45553053 -34.13531639 221.15871136 -35.875 219.0625 C-38.54717935 215.90032614 -41.26946786 212.80624983 -44.0625 209.75 C-65.6875 185.7385399 -65.6875 185.7385399 -65.6875 180.5625 C-66.3475 180.5625 -67.0075 180.5625 -67.6875 180.5625 C-69.00927734 178.89208984 -69.00927734 178.89208984 -70.5234375 176.5234375 C-71.08716064 175.64413574 -71.65088379 174.76483398 -72.23168945 173.85888672 C-73.13794067 172.41280029 -73.13794067 172.41280029 -74.0625 170.9375 C-74.68664795 169.94637207 -75.3107959 168.95524414 -75.95385742 167.93408203 C-99.72264679 129.77741294 -121.58425597 84.19509549 -111.6640625 38.1171875 C-107.54518419 23.12447044 -98.11467473 9.81960967 -85.0625 1.25 C-59.8386679 -12.79871662 -26.15292724 -9.40102777 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(203.6875,96.4375)" />
     <path d="M0 0 C2.93378573 1.70348849 5.6006325 3.59425121 8 6 C8 6.66 8 7.32 8 8 C8.54398437 8.22558594 9.08796875 8.45117188 9.6484375 8.68359375 C12.73640119 10.41223787 15.04454974 12.64550144 17.625 15.0625 C21.04209753 18.41533647 21.04209753 18.41533647 25 21 C25 21.66 25 22.32 25 23 C25.66 23 26.32 23 27 23 C27 23.66 27 24.32 27 25 C27.99 25.33 28.98 25.66 30 26 C30 26.66 30 27.32 30 28 C30.66 28 31.32 28 32 28 C32 28.66 32 29.32 32 30 C32.66 30 33.32 30 34 30 C34 30.66 34 31.32 34 32 C34.66 32 35.32 32 36 32 C36 32.66 36 33.32 36 34 C36.66 34 37.32 34 38 34 C39.375 35.36328125 39.375 35.36328125 41 37.3125 C43.84002365 40.66302377 46.75815152 43.90923929 49.75 47.125 C55.53338955 53.47005409 60.79276306 60.17892598 66 67 C66.6175415 67.80751709 66.6175415 67.80751709 67.24755859 68.63134766 C69.86495931 72.06342897 72.4418193 75.52362393 75 79 C75.55816406 79.74765625 76.11632812 80.4953125 76.69140625 81.265625 C103.57144421 118.31473756 125.04750077 164.84504399 119.71142578 211.52441406 C117.72681948 223.1976286 111.46146523 237.56473125 103 246 C102.34 246 101.68 246 101 246 C101 246.66 101 247.32 101 248 C100.34 248 99.68 248 99 248 C99 248.66 99 249.32 99 250 C86.15807398 261.65810118 70.238841 265.44302797 53.375 265.4375 C52.34255157 265.43910126 52.34255157 265.43910126 51.28924561 265.44073486 C38.96205585 265.41320205 27.74979115 263.7730483 16 260 C15.19272461 259.75411133 14.38544922 259.50822266 13.55371094 259.25488281 C11.19243017 258.5308829 8.8446236 257.77612676 6.5 257 C5.81115723 256.77554199 5.12231445 256.55108398 4.41259766 256.31982422 C-0.10150208 254.70626885 -2.98938017 252.72957381 -6 249 C-7.49715667 244.79644474 -7.50241074 241.12444309 -5.6875 237.0625 C-2.77067818 233.49749556 -1.03160216 232.42421561 3.64160156 231.94677734 C8.15352296 232.04859917 12.18927511 233.74436973 16.375 235.3125 C33.86355688 241.69173237 56.01448552 246.17289486 73.8828125 238.8125 C85.85709625 232.80904439 91.46927704 223.25844956 96 211 C98.35105781 196.42344156 97.60047997 181.27370782 93.4375 167.125 C93.17211426 166.21862793 92.90672852 165.31225586 92.63330078 164.37841797 C85.4678218 140.58836773 74.40636609 118.23107344 60 98 C59.15658632 96.78843215 58.31414971 95.57618358 57.47265625 94.36328125 C52.30397237 86.96338915 46.84036864 79.88767222 41 73 C40.52771973 72.44280273 40.05543945 71.88560547 39.56884766 71.31152344 C27.00673871 55.93733195 27.00673871 55.93733195 12.6875 42.3125 C11.800625 41.549375 10.91375 40.78625 10 40 C10 39.34 10 38.68 10 38 C9.42765625 37.7421875 8.8553125 37.484375 8.265625 37.21875 C5.78871005 35.88634058 3.8658834 34.34943882 1.75 32.5 C1.04359375 31.8915625 0.3371875 31.283125 -0.390625 30.65625 C-2 29 -2 29 -2 27 C-2.56332031 26.7525 -3.12664062 26.505 -3.70703125 26.25 C-6.38361761 24.79087285 -8.42194823 23.03712424 -10.6875 21 C-11.47511719 20.29875 -12.26273437 19.5975 -13.07421875 18.875 C-15.80492922 16.21629609 -16.2107762 14.46398432 -16.375 10.75 C-16.34662549 7.23156041 -15.91021556 5.25002646 -13.6875 2.5 C-9.41142805 -1.47774135 -5.4553011 -1.60279643 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(289,146)" />
     <path d="M0 0 C3.4431146 2.09580889 5.7468218 4.1265401 7 8 C7.552036 12.23227598 7.00642709 14.80449823 4.44921875 18.25 C-1.31726422 25.21330019 -7.56217417 31.65940444 -14.03125 37.96875 C-16.04852969 39.84591953 -16.04852969 39.84591953 -17 42 C-17.66 42 -18.32 42 -19 42 C-19 42.66 -19 43.32 -19 44 C-19.66 44 -20.32 44 -21 44 C-21.2371875 44.56203125 -21.474375 45.1240625 -21.71875 45.703125 C-23.28947697 48.51894042 -25.21471464 50.47955416 -27.5 52.75 C-28.2940625 53.54921875 -29.088125 54.3484375 -29.90625 55.171875 C-32 57 -32 57 -34 57 C-34 57.66 -34 58.32 -34 59 C-34.66 59 -35.32 59 -36 59 C-36 59.66 -36 60.32 -36 61 C-37.29296875 62.33984375 -37.29296875 62.33984375 -39.1875 63.9375 C-39.91839844 64.55882812 -40.64929688 65.18015625 -41.40234375 65.8203125 C-42.25957031 66.53960937 -43.11679687 67.25890625 -44 68 C-45.53391929 69.30452954 -47.06783078 70.60906829 -48.6015625 71.91381836 C-50.28411812 73.34144886 -51.97152914 74.76315185 -53.66015625 76.18359375 C-55.74167134 77.93459598 -57.80987655 79.69748552 -59.87109375 81.47265625 C-94.5396944 111.04434751 -137.46464076 135.15797249 -184 135.1875 C-185.01578125 135.19974609 -186.0315625 135.21199219 -187.078125 135.22460938 C-204.77569817 135.25864317 -220.1122007 129.06332729 -233 117 C-248.22979425 101.17564921 -253.41165866 83.53034883 -253.29785156 62.04736328 C-253.03411261 48.97840412 -250.14929016 36.9404729 -246.6875 24.375 C-246.41607178 23.35494873 -246.14464355 22.33489746 -245.86499023 21.28393555 C-244.10245133 15.19447711 -242.12407112 10.00783323 -237 6 C-233.19373875 4.79107652 -229.87008251 5.08247284 -226 6 C-223.04016871 7.70222057 -222.64872376 8.75940503 -221 12 C-220.13289163 18.34216874 -221.56948935 23.63072287 -223.8125 29.5 C-230.70253948 48.92253927 -233.1883937 69.16434431 -225.15234375 88.6328125 C-223.47626362 92.07587879 -221.29413834 94.94114888 -219 98 C-219 98.66 -219 99.32 -219 100 C-218.34 100 -217.68 100 -217 100 C-217 100.66 -217 101.32 -217 102 C-216.360625 102.226875 -215.72125 102.45375 -215.0625 102.6875 C-212.47423944 103.79675453 -210.22956844 105.01468666 -207.8125 106.4375 C-192.4295889 114.90561719 -174.54065248 113.34453847 -158 109 C-157.32904297 108.82839355 -156.65808594 108.65678711 -155.96679688 108.47998047 C-131.94532877 102.2519863 -109.94586079 90.3271853 -90.05102539 75.60668945 C-85.17376283 72 -85.17376283 72 -83 72 C-83 71.34 -83 70.68 -83 70 C-81.07390405 68.4029706 -79.14121074 66.91296028 -77.125 65.4375 C-71.10922588 60.92997753 -65.53174315 56.09226096 -60 51 C-58.67092593 49.82848346 -57.33778972 48.66155394 -56 47.5 C-43.03174657 37.46486108 -43.03174657 37.46486108 -33 25 C-32.34 25 -31.68 25 -31 25 C-30.73646729 24.41428223 -30.47293457 23.82856445 -30.20141602 23.22509766 C-28.94897158 20.90549218 -27.59683426 19.29795369 -25.77734375 17.3984375 C-25.15666016 16.74359375 -24.53597656 16.08875 -23.89648438 15.4140625 C-23.25001953 14.74117188 -22.60355469 14.06828125 -21.9375 13.375 C-20.65291865 12.03058186 -19.37026898 10.68431453 -18.08984375 9.3359375 C-17.52128662 8.74345215 -16.95272949 8.1509668 -16.36694336 7.54052734 C-14.90616037 6.02826021 -14.90616037 6.02826021 -14 4 C-13.34 4 -12.68 4 -12 4 C-12 3.34 -12 2.68 -12 2 C-8.29462345 -0.47025103 -4.30311085 -0.70150117 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(344,277)" />
     <path d="M0 0 C14.14229977 12.29675039 20.35479805 30.16947418 21.91870117 48.47460938 C23.20528606 68.27359987 18.82393494 90.86489681 10.0625 108.6875 C5.80406775 111.68775909 2.20794035 112.42256291 -2.9375 111.6875 C-5.90548207 109.89073955 -8.36151242 107.83947515 -9.9375 104.6875 C-10.14456361 96.83387325 -7.85914026 89.82916436 -5.19140625 82.55859375 C-0.11691297 67.70229585 1.19374086 47.16815829 -4.5546875 32.375 C-9.26661139 23.21736261 -14.53957352 17.08750799 -23.9375 12.6875 C-24.68257812 12.33300781 -25.42765625 11.97851562 -26.1953125 11.61328125 C-46.15893141 4.873427 -67.70796564 10.42984996 -86.9375 16.6875 C-88.69513672 17.25791016 -88.69513672 17.25791016 -90.48828125 17.83984375 C-111.4679134 25.33066539 -131.31600091 38.24511776 -148.9375 51.6875 C-149.93523437 52.43128906 -150.93296875 53.17507812 -151.9609375 53.94140625 C-164.99381421 63.71855897 -176.92046702 74.48944333 -188.4375 86 C-189.36941162 86.93102539 -190.30132324 87.86205078 -191.26147461 88.82128906 C-198.9429351 96.56578616 -205.95960255 104.6215646 -212.7265625 113.171875 C-215.9659325 116.85765995 -218.60146961 119.32312808 -223.375 120.625 C-228.31869406 120.71173147 -231.17364288 119.27497141 -234.8125 116 C-236.56463686 112.39838535 -236.91521694 109.51474724 -235.9375 105.6875 C-231.65247963 97.93875484 -225.21110195 91.51771547 -219.16015625 85.12109375 C-216.93183037 82.90363619 -216.93183037 82.90363619 -215.9375 80.6875 C-215.2775 80.6875 -214.6175 80.6875 -213.9375 80.6875 C-213.9375 80.0275 -213.9375 79.3675 -213.9375 78.6875 C-213.2775 78.6875 -212.6175 78.6875 -211.9375 78.6875 C-211.57495117 77.83816895 -211.57495117 77.83816895 -211.20507812 76.97167969 C-209.68654183 74.2352726 -207.86598119 72.35680662 -205.65625 70.140625 C-204.81449219 69.29628906 -203.97273438 68.45195312 -203.10546875 67.58203125 C-202.22503906 66.70933594 -201.34460938 65.83664063 -200.4375 64.9375 C-199.55707031 64.04933594 -198.67664063 63.16117187 -197.76953125 62.24609375 C-196.92777344 61.40691406 -196.08601563 60.56773437 -195.21875 59.703125 C-194.44595703 58.93258789 -193.67316406 58.16205078 -192.87695312 57.36816406 C-190.9375 55.6875 -190.9375 55.6875 -188.9375 55.6875 C-188.9375 55.0275 -188.9375 54.3675 -188.9375 53.6875 C-187.0234375 51.91015625 -187.0234375 51.91015625 -184.3125 49.75 C-183.301875 48.94304687 -182.29125 48.13609375 -181.25 47.3046875 C-180.43595703 46.66225098 -180.43595703 46.66225098 -179.60546875 46.00683594 C-177.95840102 44.70403237 -176.32226126 43.38851028 -174.6875 42.0703125 C-161.72314137 31.67756944 -148.21332056 22.19142545 -133.9375 13.6875 C-133.12539062 13.17960937 -132.31328125 12.67171875 -131.4765625 12.1484375 C-120.61503406 5.40057764 -109.2554548 -0.17195561 -97.12109375 -4.20703125 C-93.86554715 -5.28797186 -93.86554715 -5.28797186 -90.5390625 -6.8203125 C-86.67915688 -8.41953587 -82.93825011 -9.45809677 -78.875 -10.375 C-78.12895508 -10.54418945 -77.38291016 -10.71337891 -76.61425781 -10.88769531 C-49.9109284 -16.79772856 -22.63796652 -17.44945578 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(388.9375,103.3125)" />
     <path d="M0 0 C0.99 0 1.98 0 3 0 C3.18175781 0.82242188 3.36351562 1.64484375 3.55078125 2.4921875 C4.34097061 6.00143871 5.16332983 9.50155123 6 13 C6.20496094 13.88042969 6.40992188 14.76085937 6.62109375 15.66796875 C11.1018009 32.7280525 23.97550014 47.65098129 38.5546875 57.078125 C47.97797615 62.33465336 58.55153755 65.47643068 69 68 C68.67 68.66 68.34 69.32 68 70 C65.10798258 70.80183661 62.23403677 71.51205343 59.3125 72.1875 C46.10035577 75.47225986 35.21098021 80.82117663 25 90 C24.38898438 90.51820313 23.77796875 91.03640625 23.1484375 91.5703125 C12.52689622 101.22185001 4.3447144 116.90506909 2 131 C2.66 131 3.32 131 4 131 C4 132.32 4 133.64 4 135 C2.02 135 0.04 135 -2 135 C-2.15855469 134.05640625 -2.31710938 133.1128125 -2.48046875 132.140625 C-4.51040345 120.9703766 -7.58396558 111.00061636 -14.08203125 101.5234375 C-15 100 -15 100 -15 98 C-15.66 98 -16.32 98 -17 98 C-17.98552542 96.74459223 -18.91198371 95.44271751 -19.8125 94.125 C-31.49360234 78.73599588 -48.94687996 72.53333903 -67 68 C-66.67 67.01 -66.34 66.02 -66 65 C-65.42894531 64.90203125 -64.85789063 64.8040625 -64.26953125 64.703125 C-43.91566914 60.94947157 -26.7679561 52.45964257 -13.94921875 35.86328125 C-6.81218983 25.37942915 -1.15800206 12.73802268 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(248,182)" />
     <path d="M0 0 C0 4.10635896 -1.9302505 6.96215932 -3.8125 10.5 C-7.10338533 16.84547241 -9.5672776 22.95578152 -11 30 C-10.34 30 -9.68 30 -9 30 C-9 31.32 -9 32.64 -9 34 C-10.98 34 -12.96 34 -15 34 C-15.19335938 32.99839844 -15.38671875 31.99679687 -15.5859375 30.96484375 C-15.84880049 29.62236492 -16.11183026 28.27991873 -16.375 26.9375 C-16.50132812 26.28072266 -16.62765625 25.62394531 -16.7578125 24.94726562 C-17.62384507 20.55215035 -18.71626553 16.29213829 -20 12 C-19.34 12 -18.68 12 -18 12 C-17.01 14.97 -16.02 17.94 -15 21 C-14.34 21 -13.68 21 -13 21 C-12.67 20.34 -12.34 19.68 -12 19 C-11.20833333 17.8125 -10.41666667 16.625 -9.625 15.4375 C-7.2511606 11.71689785 -5.94845006 8.14765748 -4.87109375 3.8828125 C-3.73574823 1.42883698 -2.46570577 0.95804518 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(261,283)" />
     <path d="M0 0 C0.93423645 3.01031744 1.04449911 3.86650268 0 7 C-0.66 7 -1.32 7 -2 7 C-1.79375 7.5775 -1.5875 8.155 -1.375 8.75 C-0.88846092 11.66923445 -1.36433695 12.54650543 -3 15 C-4.6222454 16.70993434 -6.29413425 18.37347684 -8 20 C-8.845625 20.845625 -9.69125 21.69125 -10.5625 22.5625 C-12.70833333 24.70833333 -14.85416667 26.85416667 -17 29 C-17.99 28.34 -18.98 27.68 -20 27 C-19.175 26.38125 -18.35 25.7625 -17.5 25.125 C-9.35188241 18.26443872 -4.3495088 9.58868985 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(242,203)" />
     <path d="M0 0 C-0.804375 0.61875 -1.60875 1.2375 -2.4375 1.875 C-5.03874519 3.74164041 -5.03874519 3.74164041 -6 6 C-5.34 6 -4.68 6 -4 6 C-3.67 5.34 -3.34 4.68 -3 4 C-2.01 5.65 -1.02 7.3 0 9 C-8.415 7.02 -8.415 7.02 -17 5 C-16.67 4.01 -16.34 3.02 -16 2 C-14.98679688 1.80083984 -14.98679688 1.80083984 -13.953125 1.59765625 C-12.61507812 1.33275391 -12.61507812 1.33275391 -11.25 1.0625 C-10.36828125 0.88847656 -9.4865625 0.71445313 -8.578125 0.53515625 C-6.04810488 0.04285221 -6.04810488 0.04285221 -3.796875 -0.62890625 C-2 -1 -2 -1 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(198,245)" />
     <path d="M0 0 C6.73862227 1.43609983 13.36629557 3.14008287 20 5 C19.67 5.66 19.34 6.32 19 7 C17.07421875 7.6328125 17.07421875 7.6328125 14.6875 8.125 C13.90761719 8.29257813 13.12773437 8.46015625 12.32421875 8.6328125 C10 9 10 9 6 9 C6.33 7.68 6.66 6.36 7 5 C5.5459375 4.319375 5.5459375 4.319375 4.0625 3.625 C1 2 1 2 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(297,245)" />
     <path d="M0 0 C0.66 0 1.32 0 2 0 C2.99 2.97 3.98 5.94 5 9 C5.66 9 6.32 9 7 9 C7.33 8.34 7.66 7.68 8 7 C9.26264601 11.29299643 8.62950412 13.87831311 7 18 C6.67 17.01 6.34 16.02 6 15 C5.34 15 4.68 15 4 15 C3.3299166 12.87607494 2.66403203 10.75082476 2 8.625 C1.62875 7.44164062 1.2575 6.25828125 0.875 5.0390625 C0 2 0 2 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(241,295)" />
     <path d="M0 0 C0.99 0 1.98 0 3 0 C3.33 3.63 3.66 7.26 4 11 C3.01 10.34 2.02 9.68 1 9 C0.34 10.65 -0.32 12.3 -1 14 C-2.13732426 10.59598052 -1.83989957 8.22543336 -1.0625 4.75 C-0.86785156 3.85796875 -0.67320312 2.9659375 -0.47265625 2.046875 C-0.31667969 1.37140625 -0.16070312 0.6959375 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(248,182)" />
     <path d="M0 0 C0 5.97201897 -4.30929681 9.54008011 -8.28125 13.546875 C-10 15 -10 15 -13 16 C-13 15.34 -13 14.68 -13 14 C-12.34 14 -11.68 14 -11 14 C-10.76539063 13.44828125 -10.53078125 12.8965625 -10.2890625 12.328125 C-8.67151842 9.40674236 -6.63549805 7.20425503 -4.375 4.75 C-3.55773437 3.85796875 -2.74046875 2.9659375 -1.8984375 2.046875 C-1.27195312 1.37140625 -0.64546875 0.6959375 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(324,288)" />
     <path d="M0 0 C0 1.66666667 0 3.33333333 0 5 C-1.64453125 6.62109375 -1.64453125 6.62109375 -3.8125 8.4375 C-6.82463265 10.97339332 -6.82463265 10.97339332 -9.63671875 13.72265625 C-11 15 -11 15 -13 15 C-13 14.34 -13 13.68 -13 13 C-12.34 13 -11.68 13 -11 13 C-10.76539063 12.43796875 -10.53078125 11.8759375 -10.2890625 11.296875 C-8.69337 8.45364109 -6.71075457 6.51901873 -4.375 4.25 C-3.55773437 3.45078125 -2.74046875 2.6515625 -1.8984375 1.828125 C-0.95871094 0.92320312 -0.95871094 0.92320312 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(188,169)" />
     <path d="M0 0 C0.66 0.33 1.32 0.66 2 1 C0.56974806 2.65213589 -0.86945545 4.29652589 -2.3125 5.9375 C-3.11300781 6.85402344 -3.91351563 7.77054687 -4.73828125 8.71484375 C-7 11 -7 11 -10 12 C-10 12.66 -10 13.32 -10 14 C-10.66 14 -11.32 14 -12 14 C-10.41332422 10.09714233 -7.86649519 7.66479018 -4.875 4.75 C-3.96492188 3.85796875 -3.05484375 2.9659375 -2.1171875 2.046875 C-1.41851562 1.37140625 -0.71984375 0.6959375 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(114,101)" />
     <path d="M0 0 C0.33 0.99 0.66 1.98 1 3 C-3.15984612 6.89985574 -6.55084591 7.89169747 -12 9 C-9.67350413 6.49280542 -7.17318479 4.67816399 -4.3125 2.8125 C-3.50425781 2.28269531 -2.69601563 1.75289062 -1.86328125 1.20703125 C-1.24839844 0.80871094 -0.63351563 0.41039062 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(221,231)" />
     <path d="M0 0 C-1.22053859 3.66161578 -2.36782304 4.16270474 -5.5625 6.1875 C-6.38878906 6.71730469 -7.21507812 7.24710938 -8.06640625 7.79296875 C-8.70449219 8.19128906 -9.34257812 8.58960938 -10 9 C-10.66 8.34 -11.32 7.68 -12 7 C-10.3790787 5.82767315 -8.75313167 4.6622923 -7.125 3.5 C-6.22007812 2.8503125 -5.31515625 2.200625 -4.3828125 1.53125 C-2 0 -2 0 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(244,125)" />
     <path d="M0 0 C0 4.24170573 -1.83750763 6.75139708 -4.6875 9.8125 C-5.120625 10.204375 -5.55375 10.59625 -6 11 C-6.99 10.34 -7.98 9.68 -9 9 C-7.6078125 7.88625 -7.6078125 7.88625 -6.1875 6.75 C-3.72873042 4.70974439 -1.78352451 2.67528677 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(231,221)" />
     <path d="M0 0 C0.33 0.99 0.66 1.98 1 3 C2.65 3 4.3 3 6 3 C6 4.32 6 5.64 6 7 C4.02 7 2.04 7 0 7 C0 4.69 0 2.38 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(246,310)" />
     <path d="M0 0 C0.66 0 1.32 0 2 0 C1.54857225 1.77260631 1.08859477 3.5430368 0.625 5.3125 C0.36976562 6.29863281 0.11453125 7.28476562 -0.1484375 8.30078125 C-1 11 -1 11 -3 14 C-4.125 8.25 -4.125 8.25 -3 6 C-2.34 6 -1.68 6 -1 6 C-0.67 4.02 -0.34 2.04 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(119,302)" />
     <path d="M0 0 C0.66 0 1.32 0 2 0 C2 0.66 2 1.32 2 2 C2.99 2.33 3.98 2.66 5 3 C6.04892238 4.63631892 7.04906703 6.30485863 8 8 C8.66 8.66 9.32 9.32 10 10 C9.01 10.66 8.02 11.32 7 12 C3 5.25 3 5.25 3 3 C2.34 3 1.68 3 1 3 C0.67 2.01 0.34 1.02 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(230,277)" />
     <path d="M0 0 C0 3.17370278 -0.30933342 4.3794668 -2 7 C-4.125 8.25 -4.125 8.25 -6 9 C-6 9.66 -6 10.32 -6 11 C-6.66 11 -7.32 11 -8 11 C-6.63629701 8.00779732 -5.05091917 5.70973471 -2.875 3.25 C-2.33617187 2.63640625 -1.79734375 2.0228125 -1.2421875 1.390625 C-0.62730469 0.70226562 -0.62730469 0.70226562 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(168,190)" />
     <path d="M0 0 C-1 1 -1 1 -3.5625 1.0625 C-4.7690625 1.0315625 -4.7690625 1.0315625 -6 1 C-5.67 1.99 -5.34 2.98 -5 4 C-7.97 3.505 -7.97 3.505 -11 3 C-10.67 2.01 -10.34 1.02 -10 0 C-2.25 -1.125 -2.25 -1.125 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(192,247)" />
     <path d="M0 0 C1.31534494 3.65857532 0.65468309 6.08026481 -0.4375 9.75 C-0.86869141 11.22726562 -0.86869141 11.22726562 -1.30859375 12.734375 C-1.53675781 13.48203125 -1.76492187 14.2296875 -2 15 C-2.66 14.67 -3.32 14.34 -4 14 C-3.71715982 12.22773547 -3.42339502 10.457212 -3.125 8.6875 C-2.96257812 7.70136719 -2.80015625 6.71523438 -2.6328125 5.69921875 C-2 3 -2 3 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(252,298)" />
     <path d="M0 0 C0.66 0 1.32 0 2 0 C3.91302307 3.26613695 4.35674661 5.99445248 4.625 9.75 C4.69976562 10.73484375 4.77453125 11.7196875 4.8515625 12.734375 C4.92503906 13.85585938 4.92503906 13.85585938 5 15 C3.26830404 11.8377726 2.2871024 8.73257278 1.375 5.25 C1.11460937 4.26515625 0.85421875 3.2803125 0.5859375 2.265625 C0.39257812 1.51796875 0.19921875 0.7703125 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(241,295)" />
     <path d="M0 0 C0.66 0.33 1.32 0.66 2 1 C-0.97 4.96 -0.97 4.96 -4 9 C-4.99 8.67 -5.98 8.34 -7 8 C-5.38405168 5.95880212 -3.7143618 3.95927063 -2 2 C-1.34 2 -0.68 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(332,279)" />
     <path d="M0 0 C1.55693206 2.33539809 2.90200646 4.57968756 4.1875 7.0625 C4.55230469 7.75472656 4.91710937 8.44695312 5.29296875 9.16015625 C5.52628906 9.76730469 5.75960938 10.37445313 6 11 C5.67 11.66 5.34 12.32 5 13 C2.53686261 11.17251097 1.16571382 9.77023784 0.51171875 6.73046875 C0.27481707 4.48520654 0.09638651 2.25544422 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(254,199)" />
     <path d="M0 0 C0.99 0.33 1.98 0.66 3 1 C2.525625 2.051875 2.05125 3.10375 1.5625 4.1875 C0.30676259 7.10175851 -0.52234381 9.84746914 -1 13 C-1.33 13 -1.66 13 -2 13 C-1.85915204 11.20793453 -1.71216299 9.41635083 -1.5625 7.625 C-1.48128906 6.62726563 -1.40007812 5.62953125 -1.31640625 4.6015625 C-1 2 -1 2 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(115,131)" />
     <path d="M0 0 C0.66 0.66 1.32 1.32 2 2 C1.625 4.125 1.625 4.125 1 6 C0.67 5.67 0.34 5.34 0 5 C-0.66 6.65 -1.32 8.3 -2 10 C-2.6875 8.375 -2.6875 8.375 -3 6 C-1.5625 2.75 -1.5625 2.75 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(249,186)" />
   </svg>
            <h3>Hi! How can I help you today?</h3>
        </div>
    `;
    
    const existingButton = document.getElementById('conversation-download-btn');
    if (existingButton) {
        existingButton.remove();
    }
}
async function saveConversation() {
    if (!currentConversationId || currentMessages.length === 0) return;
    
    const processedMessages = currentMessages.map(msg => {
        if (msg.role === 'user' && msg.files) {
            const processedFiles = msg.files.map(fileInfo => ({
                name: fileInfo.name,
                type: fileInfo.type,
                size: fileInfo.size,
                fileId: fileInfo.fileId
            }));
            return {
                ...msg,
                files: processedFiles
            };
        }
        
        if (msg.isImageGeneration && msg.generatedImage) {
            return {
                ...msg,
                generatedImage: {
                    prompt: msg.generatedImage.prompt,
                    imageUrl: msg.generatedImage.imageUrl,
                    timestamp: msg.generatedImage.timestamp
                }
            };
        }
        
        return msg;
    });
    
    const conversation = {
        id: currentConversationId,
        title: currentMessages[0].content.substring(0, 30) +
            (currentMessages[0].content.length > 30 ? '...' : ''),
        preview: currentMessages.length > 1 ?
            currentMessages[1].content.substring(0, 50) +
            (currentMessages[1].content.length > 50 ? '...' : '') : '',
        messages: processedMessages,
        timestamp: Date.now(),
    };
    
    const existingAppwriteDoc = conversations.find(c => c.id === currentConversationId);
    const appwriteDocId = existingAppwriteDoc ? existingAppwriteDoc.$id : null;
    
    const conversationDataForAppwrite = {
        conversationId: currentConversationId,
        title: conversation.title,
        preview: conversation.preview,
        messages: JSON.stringify(conversation.messages),
        timestamp: conversation.timestamp,
        $id: appwriteDocId
    };
    
    await saveConversationToAppwrite(conversationDataForAppwrite);
    
    const existingIndex = conversations.findIndex(c => c.id === currentConversationId);
    if (existingIndex >= 0) {
        conversations[existingIndex] = { ...conversation, $id: conversationDataForAppwrite.$id || conversations[existingIndex].$id };
    } else {
        conversations.unshift({ ...conversation, $id: conversationDataForAppwrite.$id });
    }
    
    conversations.sort((a, b) => b.timestamp - a.timestamp);
    
    renderConversationList();
}
let conversationToDeleteId = null;

function showDeletePopup(conversationId) {
    conversationToDeleteId = conversationId;
    document.getElementById("deleteModal").style.display = "flex";
}

document.getElementById("cancelDeleteBtn").addEventListener("click", () => {
    document.getElementById("deleteModal").style.display = "none";
    conversationToDeleteId = null;
});

document.getElementById("confirmDeleteBtn").addEventListener("click", async () => {
    if (conversationToDeleteId) {
        const conv = conversations.find(c => c.id === conversationToDeleteId);
        if (conv && conv.$id) {
            try {
                await databases.deleteDocument(APPWRITE_DATABASE_ID, APPWRITE_COLLECTION_ID, conv.$id);
                conversations = conversations.filter(c => c.id !== conversationToDeleteId);
                renderConversationList();
                console.log("Conversation deleted:", conversationToDeleteId);
            } catch (error) {
                console.error("Error deleting conversation:", error);
            }
        }
        conversationToDeleteId = null;
    }
    document.getElementById("deleteModal").style.display = "none";
});
let currentSearchTerm = '';

function renderConversationList() {
    const listContainer = document.getElementById('conversation-list');
    const sidebar = document.querySelector('.sidebar');
    
    let searchInput = document.getElementById('conversation-search-input');
    let sidebarHeader = document.querySelector('.sidebar-header');
    
    const oldInputsInList = listContainer.querySelectorAll('input.conversation-search-input, #conversation-search-input');
    oldInputsInList.forEach(input => {
        if (input.parentNode === listContainer) {
            input.remove();
        }
    });
    
    if (!searchInput) {
        searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.id = 'conversation-search-input';
        searchInput.className = 'conversation-search-input';
        searchInput.placeholder = 'Search conversations...';
        
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.trim().toLowerCase();
            renderConversationList();
        });
    }
    
    if (!sidebarHeader) {
        sidebarHeader = document.createElement('div');
        sidebarHeader.className = 'sidebar-header';
        sidebar.insertBefore(sidebarHeader, listContainer);
    }
    
    if (searchInput.parentNode !== sidebarHeader) {
        sidebarHeader.innerHTML = '';
        sidebarHeader.appendChild(searchInput);
    }
    
    let conversationsToShow = conversations;
    if (currentSearchTerm) {
        conversationsToShow = conversations.filter(convo => {
            const titleMatch = convo.title && convo.title.toLowerCase().includes(currentSearchTerm);
            const previewMatch = convo.preview && convo.preview.toLowerCase().includes(currentSearchTerm);
            return titleMatch || previewMatch;
        });
    }
    
    listContainer.innerHTML = '';
    
    if (conversationsToShow.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'conversation-item';
        emptyState.innerHTML = currentSearchTerm ?
            '<div class="conversation-title">No matching conversations</div>' :
            '<div class="conversation-title">No conversations yet</div>';
        listContainer.appendChild(emptyState);
        return;
    }
    
    const groupedConversations = groupConversationsByDate(conversationsToShow);
    
    const sectionOrder = ['today', 'yesterday', 'pastWeek', 'thisMonth', 'older'];
    
    sectionOrder.forEach(sectionKey => {
        const group = groupedConversations[sectionKey];
        
        if (group.conversations.length > 0) {
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'conversation-section';
            sectionHeader.innerHTML = `
                ${group.title}
                <span class="conversation-section-count">(${group.conversations.length})</span>
            `;
            listContainer.appendChild(sectionHeader);
            
            group.conversations.forEach(conversation => {
                const item = document.createElement('div');
                item.className = `conversation-item ${conversation.id === currentConversationId ? 'active' : ''}`;
                item.dataset.convoId = conversation.id;
                
item.innerHTML = `
    <div class="conversation-title">${conversation.title || 'New Chat'}</div>
    <div class="conversation-preview">${conversation.preview || ''}</div>
    <div class="conversation-date">${formatDate(conversation.timestamp)}</div>
    <div class="conversation-menu">
        <button class="conversation-menu-btn" title="Conversation options">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <circle cx="12" cy="6" r="1.5"/>
                <circle cx="12" cy="12" r="1.5"/>
                <circle cx="12" cy="18" r="1.5"/>
            </svg>
        </button>
    </div>
`;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.conversation-menu-btn')) {
                        loadConversation(conversation.id);
                    }
                });
                
                const menuBtn = item.querySelector('.conversation-menu-btn');
                
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    closeAllConversationMenus();
                    
                    showConversationMenuPopup(conversation, menuBtn);
                });
                
                listContainer.appendChild(item);
            });
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.conversation-menu-popup') && !e.target.closest('.conversation-menu-btn')) {
            closeAllConversationMenus();
        }
    });
const sidebarLoading = document.getElementById('sidebar-loading');
if (sidebarLoading) {
    sidebarLoading.classList.remove('visible');
}
}

function showConversationMenuPopup(conversation, menuBtn) {
    const existingPopup = document.querySelector('.conversation-menu-popup');
    if (existingPopup) {
        existingPopup.remove();
    }
    
    const popup = document.createElement('div');
    popup.className = 'conversation-menu-popup';
    
    const rect = menuBtn.getBoundingClientRect();
    
    popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
    popup.style.left = `${rect.right + window.scrollX - 180}px`;
    
    const downloadOption = document.createElement('button');
    downloadOption.className = 'conversation-menu-option download';
    downloadOption.innerHTML = `
<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
    <path d="M6.3414 6.15897C7.16507 3.73597 9.38755 2 12 2C15.3137 2 18 4.79305 18 8.23846C20.2091 8.23846 22 10.1005 22 12.3974C22 13.9368 21.1956 15.2809 20 16M6.32069 6.20644C3.8806 6.55106 2 8.72597 2 11.3576C2 13.0582 2.7854 14.5682 3.99965 15.5167" stroke="var(--basic-reverse-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
    <path d="M8 18L12 22M12 22L16 18M12 22V12" stroke="var(--basic-reverse-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
</svg>
        Download`;
    
    downloadOption.addEventListener('click', (e) => {
        e.stopPropagation();
        popup.remove();
        downloadConversation(conversation.id);
    });
    
    const deleteOption = document.createElement('button');
    deleteOption.className = 'conversation-menu-option delete';
    deleteOption.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -960 960 960">
            <path d="M280-120q-33 0-56.5-23.5T200-200v-520h-40v-80h200v-40h240v40h200v80h-40v520q0 33-23.5 56.5T680-120H280Zm400-600H280v520h400v-520ZM360-280h80v-360h-80v360Zm160 0h80v-360h-80v360ZM280-720v520-520Z"/>
        </svg>
        Delete Chat
    `;
    
    deleteOption.addEventListener('click', (e) => {
        e.stopPropagation();
        popup.remove();
        showDeletePopup(conversation.id);
    });
    
    popup.appendChild(downloadOption);
    popup.appendChild(deleteOption);
    
    document.body.appendChild(popup);
    
    setTimeout(() => {
        popup.classList.add('active');
    }, 10);
}

function closeAllConversationMenus() {
    const popups = document.querySelectorAll('.conversation-menu-popup');
    popups.forEach(popup => {
        popup.remove();
    });
}

function scrollToConversation(conversationId) {
    const conversationItem = document.querySelector(`.conversation-item[data-id="${conversationId}"]`);
    if (conversationItem) {
        conversationItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
}
function loadConversation(id) {
    const conversation = conversations.find(c => c.id === id);
    if (!conversation) return;
    
    currentConversationId = id;
    currentMessages = conversation.messages;
    const responseDiv = document.getElementById('response');
    responseDiv.innerHTML = '';
    
    const homeGreeting = document.getElementById('homeGreeting');
    if (homeGreeting) {
        homeGreeting.style.display = 'none';
    }
    
    // Process each message in the conversation
    conversation.messages.forEach((msg, index) => {
        const messageId = `msg_${msg.timestamp || Date.now()}_${index}`;
        const bubble = document.createElement('div');
        bubble.className = `chat-bubble ${msg.role === 'user' ? 'user-msg' : 'bot-msg'}`;
        bubble.id = messageId;
        
        if (msg.role === 'assistant' && msg.isImageGeneration && msg.generatedImage) {
            // Handle saved image generation messages
            displaySavedGeneratedImage(bubble, msg.generatedImage);
        } else if (msg.role === 'assistant') {
            // Regular bot message - parse markdown
            bubble.innerHTML = marked.parse(msg.content);
            addActionButtons(bubble, msg.content, messageId);
            
            // Add MathJax processing for past conversations
            setTimeout(() => {
                renderMathFast(bubble);
            }, 300);
        } else {
            // User message - plain text
            if (msg.content) {
                const textElement = document.createElement('div');
                textElement.textContent = msg.content;
                textElement.style.wordBreak = 'break-word';
                textElement.style.whiteSpace = 'pre-wrap';
                bubble.appendChild(textElement);
            }
            
// Handle files in user messages
if (msg.files && msg.files.length > 0) {
  const imageFiles = msg.files.filter(file =>
    file.type && (file.type.startsWith('image/') || file.type.startsWith('video/'))
  );
  const otherFiles = msg.files.filter(file =>
    !file.type || (!file.type.startsWith('image/') && !file.type.startsWith('video/'))
  );
  
  // Render media ABOVE the bubble
  if (imageFiles.length > 0) {
    const mediaContainer = document.createElement('div');
mediaContainer.className = 'user-media-container'; //  align right
    imageFiles.forEach(fileInfo => {
      const mediaWrapper = document.createElement('div');
      mediaWrapper.style.position = 'relative';
      mediaWrapper.style.maxWidth = '100%';
      mediaWrapper.style.marginBottom = '8px';
      if (fileInfo.fileId) {
        const fileUrl = getAppwriteFileUrl(fileInfo.fileId);
        if (fileInfo.type.startsWith('image/')) {
          const img = document.createElement('img');
          img.src = fileUrl;
          img.className = 'user-media';
          img.style.cursor = 'pointer';
          img.alt = fileInfo.name;
          img.onclick = () => viewImageFromUrl(fileUrl);
          mediaWrapper.appendChild(img);
        } else if (fileInfo.type.startsWith('video/')) {
          const video = document.createElement('video');
          video.src = fileUrl;
          video.className = 'user-media';
          video.controls = true;
          video.style.maxWidth = '100%';
          video.style.maxHeight = '200px';
          video.style.borderRadius = '8px';
          video.style.objectFit = 'contain';
          mediaWrapper.appendChild(video);
        }
      } else {
        const errorElement = document.createElement('div');
        errorElement.className = 'file-error';
        errorElement.textContent = `File not accessible: ${fileInfo.name}`;
        mediaWrapper.appendChild(errorElement);
      }
      mediaContainer.appendChild(mediaWrapper);
    });
    responseDiv.appendChild(mediaContainer);
  }
  
  // Render other files INSIDE the bubble
  if (otherFiles.length > 0) {
    const filesContainer = document.createElement('div');
    filesContainer.className = 'message-files-container';
    otherFiles.forEach(fileInfo => {
      const fileType = getFileType(fileInfo);
      const fileElement = document.createElement('div');
      fileElement.className = 'message-file';
      const iconElement = document.createElement('i');
      iconElement.className = `${fileType.icon.split(' ')[0]} ${fileType.icon.split(' ')[1]} ${fileType.class}`;
      const nameElement = document.createElement('span');
      nameElement.textContent = fileInfo.name.length > 20 ?
        fileInfo.name.substring(0, 17) + '...' : fileInfo.name;
      fileElement.appendChild(iconElement);
      fileElement.appendChild(nameElement);
      filesContainer.appendChild(fileElement);
    });
    bubble.appendChild(filesContainer);
  }
}
responseDiv.appendChild(bubble);
        }
        
        responseDiv.appendChild(bubble);
    });
    
    enhanceCodeBlocks();
    document.querySelectorAll('pre code').forEach(block => {
        if (block.textContent.trim()) {
            hljs.highlightElement(block);
        }
    });
    
    // Trigger MathJax rendering for all loaded content
    setTimeout(() => {
        renderMathFast(responseDiv);
    }, 500);
    
    renderConversationList();
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

function showHomeGreeting() {
    currentConversationId = null;
    currentMessages = [];
    const responseDiv = document.getElementById('response');
    responseDiv.innerHTML = `
        <div class="home-greeting" id="homeGreeting">
              <svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 499" width="100" height="100">
       <path d="M0 0 C1.15749756 0.41390991 1.15749756 0.41390991 2.33837891 0.83618164 C6.9527187 2.63536985 10.15169143 4.60393477 13.3125 8.5625 C14.77638947 12.67265119 14.77112681 16.39045371 13.1875 20.4375 C10.95985225 22.96216745 9.45933047 24.30376781 6.3125 25.5625 C0.66778211 25.13659674 -4.33852547 23.91669752 -9.6875 22.125 C-21.81016321 18.1354126 -32.89068345 16.38383758 -45.6875 16.375 C-46.62078125 16.36275391 -47.5540625 16.35050781 -48.515625 16.33789062 C-59.97699258 16.31387938 -70.7036802 18.7376297 -79.4375 26.625 C-90.54288099 38.72802751 -91.32897458 53.9694515 -90.78808594 69.48828125 C-88.724703 112.03804208 -59.04691987 156.32690507 -32.35009766 187.60742188 C-30.78362856 189.44946072 -29.23857814 191.30716853 -27.69921875 193.171875 C-16.86457641 206.19976478 -4.98635435 218.05659003 8.3125 228.5625 C10.85341319 230.62236316 13.36802622 232.71152682 15.875 234.8125 C16.48359863 235.3084668 17.09219727 235.80443359 17.71923828 236.31542969 C21.02750657 239.10124109 23.21254174 241.22094288 24.3125 245.5625 C24.1091595 250.4426721 22.69872417 253.07952657 19.3125 256.5625 C16.50555056 258.69190992 15.35040391 258.5658249 11.75 258.25 C8.3125 257.5625 8.3125 257.5625 5.3125 256.5625 C5.3125 255.9025 5.3125 255.2425 5.3125 254.5625 C4.59707031 254.32917969 3.88164062 254.09585937 3.14453125 253.85546875 C-0.20710607 252.32527295 -2.32482449 250.40306021 -5 247.875 C-5.9590625 246.98039063 -6.918125 246.08578125 -7.90625 245.1640625 C-8.8240625 244.30554688 -9.741875 243.44703125 -10.6875 242.5625 C-12.11803768 241.28383447 -13.55465176 240.01190019 -15 238.75 C-15.62519531 238.2034375 -16.25039062 237.656875 -16.89453125 237.09375 C-18.63217493 235.60974929 -20.40490498 234.17940021 -22.1875 232.75 C-23.0125 232.028125 -23.8375 231.30625 -24.6875 230.5625 C-24.6875 229.9025 -24.6875 229.2425 -24.6875 228.5625 C-26.6675 227.5725 -26.6675 227.5725 -28.6875 226.5625 C-28.6875 225.9025 -28.6875 225.2425 -28.6875 224.5625 C-29.28175781 224.3046875 -29.87601562 224.046875 -30.48828125 223.78125 C-32.88052503 222.45553053 -34.13531639 221.15871136 -35.875 219.0625 C-38.54717935 215.90032614 -41.26946786 212.80624983 -44.0625 209.75 C-65.6875 185.7385399 -65.6875 185.7385399 -65.6875 180.5625 C-66.3475 180.5625 -67.0075 180.5625 -67.6875 180.5625 C-69.00927734 178.89208984 -69.00927734 178.89208984 -70.5234375 176.5234375 C-71.08716064 175.64413574 -71.65088379 174.76483398 -72.23168945 173.85888672 C-73.13794067 172.41280029 -73.13794067 172.41280029 -74.0625 170.9375 C-74.68664795 169.94637207 -75.3107959 168.95524414 -75.95385742 167.93408203 C-99.72264679 129.77741294 -121.58425597 84.19509549 -111.6640625 38.1171875 C-107.54518419 23.12447044 -98.11467473 9.81960967 -85.0625 1.25 C-59.8386679 -12.79871662 -26.15292724 -9.40102777 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(203.6875,96.4375)" />
       <path d="M0 0 C2.93378573 1.70348849 5.6006325 3.59425121 8 6 C8 6.66 8 7.32 8 8 C8.54398437 8.22558594 9.08796875 8.45117188 9.6484375 8.68359375 C12.73640119 10.41223787 15.04454974 12.64550144 17.625 15.0625 C21.04209753 18.41533647 21.04209753 18.41533647 25 21 C25 21.66 25 22.32 25 23 C25.66 23 26.32 23 27 23 C27 23.66 27 24.32 27 25 C27.99 25.33 28.98 25.66 30 26 C30 26.66 30 27.32 30 28 C30.66 28 31.32 28 32 28 C32 28.66 32 29.32 32 30 C32.66 30 33.32 30 34 30 C34 30.66 34 31.32 34 32 C34.66 32 35.32 32 36 32 C36 32.66 36 33.32 36 34 C36.66 34 37.32 34 38 34 C39.375 35.36328125 39.375 35.36328125 41 37.3125 C43.84002365 40.66302377 46.75815152 43.90923929 49.75 47.125 C55.53338955 53.47005409 60.79276306 60.17892598 66 67 C66.6175415 67.80751709 66.6175415 67.80751709 67.24755859 68.63134766 C69.86495931 72.06342897 72.4418193 75.52362393 75 79 C75.55816406 79.74765625 76.11632812 80.4953125 76.69140625 81.265625 C103.57144421 118.31473756 125.04750077 164.84504399 119.71142578 211.52441406 C117.72681948 223.1976286 111.46146523 237.56473125 103 246 C102.34 246 101.68 246 101 246 C101 246.66 101 247.32 101 248 C100.34 248 99.68 248 99 248 C99 248.66 99 249.32 99 250 C86.15807398 261.65810118 70.238841 265.44302797 53.375 265.4375 C52.34255157 265.43910126 52.34255157 265.43910126 51.28924561 265.44073486 C38.96205585 265.41320205 27.74979115 263.7730483 16 260 C15.19272461 259.75411133 14.38544922 259.50822266 13.55371094 259.25488281 C11.19243017 258.5308829 8.8446236 257.77612676 6.5 257 C5.81115723 256.77554199 5.12231445 256.55108398 4.41259766 256.31982422 C-0.10150208 254.70626885 -2.98938017 252.72957381 -6 249 C-7.49715667 244.79644474 -7.50241074 241.12444309 -5.6875 237.0625 C-2.77067818 233.49749556 -1.03160216 232.42421561 3.64160156 231.94677734 C8.15352296 232.04859917 12.18927511 233.74436973 16.375 235.3125 C33.86355688 241.69173237 56.01448552 246.17289486 73.8828125 238.8125 C85.85709625 232.80904439 91.46927704 223.25844956 96 211 C98.35105781 196.42344156 97.60047997 181.27370782 93.4375 167.125 C93.17211426 166.21862793 92.90672852 165.31225586 92.63330078 164.37841797 C85.4678218 140.58836773 74.40636609 118.23107344 60 98 C59.15658632 96.78843215 58.31414971 95.57618358 57.47265625 94.36328125 C52.30397237 86.96338915 46.84036864 79.88767222 41 73 C40.52771973 72.44280273 40.05543945 71.88560547 39.56884766 71.31152344 C27.00673871 55.93733195 27.00673871 55.93733195 12.6875 42.3125 C11.800625 41.549375 10.91375 40.78625 10 40 C10 39.34 10 38.68 10 38 C9.42765625 37.7421875 8.8553125 37.484375 8.265625 37.21875 C5.78871005 35.88634058 3.8658834 34.34943882 1.75 32.5 C1.04359375 31.8915625 0.3371875 31.283125 -0.390625 30.65625 C-2 29 -2 29 -2 27 C-2.56332031 26.7525 -3.12664062 26.505 -3.70703125 26.25 C-6.38361761 24.79087285 -8.42194823 23.03712424 -10.6875 21 C-11.47511719 20.29875 -12.26273437 19.5975 -13.07421875 18.875 C-15.80492922 16.21629609 -16.2107762 14.46398432 -16.375 10.75 C-16.34662549 7.23156041 -15.91021556 5.25002646 -13.6875 2.5 C-9.41142805 -1.47774135 -5.4553011 -1.60279643 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(289,146)" />
       <path d="M0 0 C3.4431146 2.09580889 5.7468218 4.1265401 7 8 C7.552036 12.23227598 7.00642709 14.80449823 4.44921875 18.25 C-1.31726422 25.21330019 -7.56217417 31.65940444 -14.03125 37.96875 C-16.04852969 39.84591953 -16.04852969 39.84591953 -17 42 C-17.66 42 -18.32 42 -19 42 C-19 42.66 -19 43.32 -19 44 C-19.66 44 -20.32 44 -21 44 C-21.2371875 44.56203125 -21.474375 45.1240625 -21.71875 45.703125 C-23.28947697 48.51894042 -25.21471464 50.47955416 -27.5 52.75 C-28.2940625 53.54921875 -29.088125 54.3484375 -29.90625 55.171875 C-32 57 -32 57 -34 57 C-34 57.66 -34 58.32 -34 59 C-34.66 59 -35.32 59 -36 59 C-36 59.66 -36 60.32 -36 61 C-37.29296875 62.33984375 -37.29296875 62.33984375 -39.1875 63.9375 C-39.91839844 64.55882812 -40.64929688 65.18015625 -41.40234375 65.8203125 C-42.25957031 66.53960937 -43.11679687 67.25890625 -44 68 C-45.53391929 69.30452954 -47.06783078 70.60906829 -48.6015625 71.91381836 C-50.28411812 73.34144886 -51.97152914 74.76315185 -53.66015625 76.18359375 C-55.74167134 77.93459598 -57.80987655 79.69748552 -59.87109375 81.47265625 C-94.5396944 111.04434751 -137.46464076 135.15797249 -184 135.1875 C-185.01578125 135.19974609 -186.0315625 135.21199219 -187.078125 135.22460938 C-204.77569817 135.25864317 -220.1122007 129.06332729 -233 117 C-248.22979425 101.17564921 -253.41165866 83.53034883 -253.29785156 62.04736328 C-253.03411261 48.97840412 -250.14929016 36.9404729 -246.6875 24.375 C-246.41607178 23.35494873 -246.14464355 22.33489746 -245.86499023 21.28393555 C-244.10245133 15.19447711 -242.12407112 10.00783323 -237 6 C-233.19373875 4.79107652 -229.87008251 5.08247284 -226 6 C-223.04016871 7.70222057 -222.64872376 8.75940503 -221 12 C-220.13289163 18.34216874 -221.56948935 23.63072287 -223.8125 29.5 C-230.70253948 48.92253927 -233.1883937 69.16434431 -225.15234375 88.6328125 C-223.47626362 92.07587879 -221.29413834 94.94114888 -219 98 C-219 98.66 -219 99.32 -219 100 C-218.34 100 -217.68 100 -217 100 C-217 100.66 -217 101.32 -217 102 C-216.360625 102.226875 -215.72125 102.45375 -215.0625 102.6875 C-212.47423944 103.79675453 -210.22956844 105.01468666 -207.8125 106.4375 C-192.4295889 114.90561719 -174.54065248 113.34453847 -158 109 C-157.32904297 108.82839355 -156.65808594 108.65678711 -155.96679688 108.47998047 C-131.94532877 102.2519863 -109.94586079 90.3271853 -90.05102539 75.60668945 C-85.17376283 72 -85.17376283 72 -83 72 C-83 71.34 -83 70.68 -83 70 C-81.07390405 68.4029706 -79.14121074 66.91296028 -77.125 65.4375 C-71.10922588 60.92997753 -65.53174315 56.09226096 -60 51 C-58.67092593 49.82848346 -57.33778972 48.66155394 -56 47.5 C-43.03174657 37.46486108 -43.03174657 37.46486108 -33 25 C-32.34 25 -31.68 25 -31 25 C-30.73646729 24.41428223 -30.47293457 23.82856445 -30.20141602 23.22509766 C-28.94897158 20.90549218 -27.59683426 19.29795369 -25.77734375 17.3984375 C-25.15666016 16.74359375 -24.53597656 16.08875 -23.89648438 15.4140625 C-23.25001953 14.74117188 -22.60355469 14.06828125 -21.9375 13.375 C-20.65291865 12.03058186 -19.37026898 10.68431453 -18.08984375 9.3359375 C-17.52128662 8.74345215 -16.95272949 8.1509668 -16.36694336 7.54052734 C-14.90616037 6.02826021 -14.90616037 6.02826021 -14 4 C-13.34 4 -12.68 4 -12 4 C-12 3.34 -12 2.68 -12 2 C-8.29462345 -0.47025103 -4.30311085 -0.70150117 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(344,277)" />
       <path d="M0 0 C14.14229977 12.29675039 20.35479805 30.16947418 21.91870117 48.47460938 C23.20528606 68.27359987 18.82393494 90.86489681 10.0625 108.6875 C5.80406775 111.68775909 2.20794035 112.42256291 -2.9375 111.6875 C-5.90548207 109.89073955 -8.36151242 107.83947515 -9.9375 104.6875 C-10.14456361 96.83387325 -7.85914026 89.82916436 -5.19140625 82.55859375 C-0.11691297 67.70229585 1.19374086 47.16815829 -4.5546875 32.375 C-9.26661139 23.21736261 -14.53957352 17.08750799 -23.9375 12.6875 C-24.68257812 12.33300781 -25.42765625 11.97851562 -26.1953125 11.61328125 C-46.15893141 4.873427 -67.70796564 10.42984996 -86.9375 16.6875 C-88.69513672 17.25791016 -88.69513672 17.25791016 -90.48828125 17.83984375 C-111.4679134 25.33066539 -131.31600091 38.24511776 -148.9375 51.6875 C-149.93523437 52.43128906 -150.93296875 53.17507812 -151.9609375 53.94140625 C-164.99381421 63.71855897 -176.92046702 74.48944333 -188.4375 86 C-189.36941162 86.93102539 -190.30132324 87.86205078 -191.26147461 88.82128906 C-198.9429351 96.56578616 -205.95960255 104.6215646 -212.7265625 113.171875 C-215.9659325 116.85765995 -218.60146961 119.32312808 -223.375 120.625 C-228.31869406 120.71173147 -231.17364288 119.27497141 -234.8125 116 C-236.56463686 112.39838535 -236.91521694 109.51474724 -235.9375 105.6875 C-231.65247963 97.93875484 -225.21110195 91.51771547 -219.16015625 85.12109375 C-216.93183037 82.90363619 -216.93183037 82.90363619 -215.9375 80.6875 C-215.2775 80.6875 -214.6175 80.6875 -213.9375 80.6875 C-213.9375 80.0275 -213.9375 79.3675 -213.9375 78.6875 C-213.2775 78.6875 -212.6175 78.6875 -211.9375 78.6875 C-211.57495117 77.83816895 -211.57495117 77.83816895 -211.20507812 76.97167969 C-209.68654183 74.2352726 -207.86598119 72.35680662 -205.65625 70.140625 C-204.81449219 69.29628906 -203.97273438 68.45195312 -203.10546875 67.58203125 C-202.22503906 66.70933594 -201.34460938 65.83664063 -200.4375 64.9375 C-199.55707031 64.04933594 -198.67664063 63.16117187 -197.76953125 62.24609375 C-196.92777344 61.40691406 -196.08601563 60.56773437 -195.21875 59.703125 C-194.44595703 58.93258789 -193.67316406 58.16205078 -192.87695312 57.36816406 C-190.9375 55.6875 -190.9375 55.6875 -188.9375 55.6875 C-188.9375 55.0275 -188.9375 54.3675 -188.9375 53.6875 C-187.0234375 51.91015625 -187.0234375 51.91015625 -184.3125 49.75 C-183.301875 48.94304687 -182.29125 48.13609375 -181.25 47.3046875 C-180.43595703 46.66225098 -180.43595703 46.66225098 -179.60546875 46.00683594 C-177.95840102 44.70403237 -176.32226126 43.38851028 -174.6875 42.0703125 C-161.72314137 31.67756944 -148.21332056 22.19142545 -133.9375 13.6875 C-133.12539062 13.17960937 -132.31328125 12.67171875 -131.4765625 12.1484375 C-120.61503406 5.40057764 -109.2554548 -0.17195561 -97.12109375 -4.20703125 C-93.86554715 -5.28797186 -93.86554715 -5.28797186 -90.5390625 -6.8203125 C-86.67915688 -8.41953587 -82.93825011 -9.45809677 -78.875 -10.375 C-78.12895508 -10.54418945 -77.38291016 -10.71337891 -76.61425781 -10.88769531 C-49.9109284 -16.79772856 -22.63796652 -17.44945578 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(388.9375,103.3125)" />
       <path d="M0 0 C0.99 0 1.98 0 3 0 C3.18175781 0.82242188 3.36351562 1.64484375 3.55078125 2.4921875 C4.34097061 6.00143871 5.16332983 9.50155123 6 13 C6.20496094 13.88042969 6.40992188 14.76085937 6.62109375 15.66796875 C11.1018009 32.7280525 23.97550014 47.65098129 38.5546875 57.078125 C47.97797615 62.33465336 58.55153755 65.47643068 69 68 C68.67 68.66 68.34 69.32 68 70 C65.10798258 70.80183661 62.23403677 71.51205343 59.3125 72.1875 C46.10035577 75.47225986 35.21098021 80.82117663 25 90 C24.38898438 90.51820313 23.77796875 91.03640625 23.1484375 91.5703125 C12.52689622 101.22185001 4.3447144 116.90506909 2 131 C2.66 131 3.32 131 4 131 C4 132.32 4 133.64 4 135 C2.02 135 0.04 135 -2 135 C-2.15855469 134.05640625 -2.31710938 133.1128125 -2.48046875 132.140625 C-4.51040345 120.9703766 -7.58396558 111.00061636 -14.08203125 101.5234375 C-15 100 -15 100 -15 98 C-15.66 98 -16.32 98 -17 98 C-17.98552542 96.74459223 -18.91198371 95.44271751 -19.8125 94.125 C-31.49360234 78.73599588 -48.94687996 72.53333903 -67 68 C-66.67 67.01 -66.34 66.02 -66 65 C-65.42894531 64.90203125 -64.85789063 64.8040625 -64.26953125 64.703125 C-43.91566914 60.94947157 -26.7679561 52.45964257 -13.94921875 35.86328125 C-6.81218983 25.37942915 -1.15800206 12.73802268 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(248,182)" />
       <path d="M0 0 C0 4.10635896 -1.9302505 6.96215932 -3.8125 10.5 C-7.10338533 16.84547241 -9.5672776 22.95578152 -11 30 C-10.34 30 -9.68 30 -9 30 C-9 31.32 -9 32.64 -9 34 C-10.98 34 -12.96 34 -15 34 C-15.19335938 32.99839844 -15.38671875 31.99679687 -15.5859375 30.96484375 C-15.84880049 29.62236492 -16.11183026 28.27991873 -16.375 26.9375 C-16.50132812 26.28072266 -16.62765625 25.62394531 -16.7578125 24.94726562 C-17.62384507 20.55215035 -18.71626553 16.29213829 -20 12 C-19.34 12 -18.68 12 -18 12 C-17.01 14.97 -16.02 17.94 -15 21 C-14.34 21 -13.68 21 -13 21 C-12.67 20.34 -12.34 19.68 -12 19 C-11.20833333 17.8125 -10.41666667 16.625 -9.625 15.4375 C-7.2511606 11.71689785 -5.94845006 8.14765748 -4.87109375 3.8828125 C-3.73574823 1.42883698 -2.46570577 0.95804518 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(261,283)" />
       <path d="M0 0 C0.93423645 3.01031744 1.04449911 3.86650268 0 7 C-0.66 7 -1.32 7 -2 7 C-1.79375 7.5775 -1.5875 8.155 -1.375 8.75 C-0.88846092 11.66923445 -1.36433695 12.54650543 -3 15 C-4.6222454 16.70993434 -6.29413425 18.37347684 -8 20 C-8.845625 20.845625 -9.69125 21.69125 -10.5625 22.5625 C-12.70833333 24.70833333 -14.85416667 26.85416667 -17 29 C-17.99 28.34 -18.98 27.68 -20 27 C-19.175 26.38125 -18.35 25.7625 -17.5 25.125 C-9.35188241 18.26443872 -4.3495088 9.58868985 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(242,203)" />
       <path d="M0 0 C-0.804375 0.61875 -1.60875 1.2375 -2.4375 1.875 C-5.03874519 3.74164041 -5.03874519 3.74164041 -6 6 C-5.34 6 -4.68 6 -4 6 C-3.67 5.34 -3.34 4.68 -3 4 C-2.01 5.65 -1.02 7.3 0 9 C-8.415 7.02 -8.415 7.02 -17 5 C-16.67 4.01 -16.34 3.02 -16 2 C-14.98679688 1.80083984 -14.98679688 1.80083984 -13.953125 1.59765625 C-12.61507812 1.33275391 -12.61507812 1.33275391 -11.25 1.0625 C-10.36828125 0.88847656 -9.4865625 0.71445313 -8.578125 0.53515625 C-6.04810488 0.04285221 -6.04810488 0.04285221 -3.796875 -0.62890625 C-2 -1 -2 -1 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(198,245)" />
       <path d="M0 0 C6.73862227 1.43609983 13.36629557 3.14008287 20 5 C19.67 5.66 19.34 6.32 19 7 C17.07421875 7.6328125 17.07421875 7.6328125 14.6875 8.125 C13.90761719 8.29257813 13.12773437 8.46015625 12.32421875 8.6328125 C10 9 10 9 6 9 C6.33 7.68 6.66 6.36 7 5 C5.5459375 4.319375 5.5459375 4.319375 4.0625 3.625 C1 2 1 2 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(297,245)" />
       <path d="M0 0 C0.66 0 1.32 0 2 0 C2.99 2.97 3.98 5.94 5 9 C5.66 9 6.32 9 7 9 C7.33 8.34 7.66 7.68 8 7 C9.26264601 11.29299643 8.62950412 13.87831311 7 18 C6.67 17.01 6.34 16.02 6 15 C5.34 15 4.68 15 4 15 C3.3299166 12.87607494 2.66403203 10.75082476 2 8.625 C1.62875 7.44164062 1.2575 6.25828125 0.875 5.0390625 C0 2 0 2 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(241,295)" />
       <path d="M0 0 C0.99 0 1.98 0 3 0 C3.33 3.63 3.66 7.26 4 11 C3.01 10.34 2.02 9.68 1 9 C0.34 10.65 -0.32 12.3 -1 14 C-2.13732426 10.59598052 -1.83989957 8.22543336 -1.0625 4.75 C-0.86785156 3.85796875 -0.67320312 2.9659375 -0.47265625 2.046875 C-0.31667969 1.37140625 -0.16070312 0.6959375 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(248,182)" />
       <path d="M0 0 C0 5.97201897 -4.30929681 9.54008011 -8.28125 13.546875 C-10 15 -10 15 -13 16 C-13 15.34 -13 14.68 -13 14 C-12.34 14 -11.68 14 -11 14 C-10.76539063 13.44828125 -10.53078125 12.8965625 -10.2890625 12.328125 C-8.67151842 9.40674236 -6.63549805 7.20425503 -4.375 4.75 C-3.55773437 3.85796875 -2.74046875 2.9659375 -1.8984375 2.046875 C-1.27195312 1.37140625 -0.64546875 0.6959375 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(324,288)" />
       <path d="M0 0 C0 1.66666667 0 3.33333333 0 5 C-1.64453125 6.62109375 -1.64453125 6.62109375 -3.8125 8.4375 C-6.82463265 10.97339332 -6.82463265 10.97339332 -9.63671875 13.72265625 C-11 15 -11 15 -13 15 C-13 14.34 -13 13.68 -13 13 C-12.34 13 -11.68 13 -11 13 C-10.76539063 12.43796875 -10.53078125 11.8759375 -10.2890625 11.296875 C-8.69337 8.45364109 -6.71075457 6.51901873 -4.375 4.25 C-3.55773437 3.45078125 -2.74046875 2.6515625 -1.8984375 1.828125 C-0.95871094 0.92320312 -0.95871094 0.92320312 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(188,169)" />
       <path d="M0 0 C0.66 0.33 1.32 0.66 2 1 C0.56974806 2.65213589 -0.86945545 4.29652589 -2.3125 5.9375 C-3.11300781 6.85402344 -3.91351563 7.77054687 -4.73828125 8.71484375 C-7 11 -7 11 -10 12 C-10 12.66 -10 13.32 -10 14 C-10.66 14 -11.32 14 -12 14 C-10.41332422 10.09714233 -7.86649519 7.66479018 -4.875 4.75 C-3.96492188 3.85796875 -3.05484375 2.9659375 -2.1171875 2.046875 C-1.41851562 1.37140625 -0.71984375 0.6959375 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(114,101)" />
       <path d="M0 0 C0.33 0.99 0.66 1.98 1 3 C-3.15984612 6.89985574 -6.55084591 7.89169747 -12 9 C-9.67350413 6.49280542 -7.17318479 4.67816399 -4.3125 2.8125 C-3.50425781 2.28269531 -2.69601563 1.75289062 -1.86328125 1.20703125 C-1.24839844 0.80871094 -0.63351563 0.41039062 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(221,231)" />
       <path d="M0 0 C-1.22053859 3.66161578 -2.36782304 4.16270474 -5.5625 6.1875 C-6.38878906 6.71730469 -7.21507812 7.24710938 -8.06640625 7.79296875 C-8.70449219 8.19128906 -9.34257812 8.58960938 -10 9 C-10.66 8.34 -11.32 7.68 -12 7 C-10.3790787 5.82767315 -8.75313167 4.6622923 -7.125 3.5 C-6.22007812 2.8503125 -5.31515625 2.200625 -4.3828125 1.53125 C-2 0 -2 0 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(244,125)" />
       <path d="M0 0 C0 4.24170573 -1.83750763 6.75139708 -4.6875 9.8125 C-5.120625 10.204375 -5.55375 10.59625 -6 11 C-6.99 10.34 -7.98 9.68 -9 9 C-7.6078125 7.88625 -7.6078125 7.88625 -6.1875 6.75 C-3.72873042 4.70974439 -1.78352451 2.67528677 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(231,221)" />
       <path d="M0 0 C0.33 0.99 0.66 1.98 1 3 C2.65 3 4.3 3 6 3 C6 4.32 6 5.64 6 7 C4.02 7 2.04 7 0 7 C0 4.69 0 2.38 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(246,310)" />
       <path d="M0 0 C0.66 0 1.32 0 2 0 C1.54857225 1.77260631 1.08859477 3.5430368 0.625 5.3125 C0.36976562 6.29863281 0.11453125 7.28476562 -0.1484375 8.30078125 C-1 11 -1 11 -3 14 C-4.125 8.25 -4.125 8.25 -3 6 C-2.34 6 -1.68 6 -1 6 C-0.67 4.02 -0.34 2.04 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(119,302)" />
       <path d="M0 0 C0.66 0 1.32 0 2 0 C2 0.66 2 1.32 2 2 C2.99 2.33 3.98 2.66 5 3 C6.04892238 4.63631892 7.04906703 6.30485863 8 8 C8.66 8.66 9.32 9.32 10 10 C9.01 10.66 8.02 11.32 7 12 C3 5.25 3 5.25 3 3 C2.34 3 1.68 3 1 3 C0.67 2.01 0.34 1.02 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(230,277)" />
       <path d="M0 0 C0 3.17370278 -0.30933342 4.3794668 -2 7 C-4.125 8.25 -4.125 8.25 -6 9 C-6 9.66 -6 10.32 -6 11 C-6.66 11 -7.32 11 -8 11 C-6.63629701 8.00779732 -5.05091917 5.70973471 -2.875 3.25 C-2.33617187 2.63640625 -1.79734375 2.0228125 -1.2421875 1.390625 C-0.62730469 0.70226562 -0.62730469 0.70226562 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(168,190)" />
       <path d="M0 0 C-1 1 -1 1 -3.5625 1.0625 C-4.7690625 1.0315625 -4.7690625 1.0315625 -6 1 C-5.67 1.99 -5.34 2.98 -5 4 C-7.97 3.505 -7.97 3.505 -11 3 C-10.67 2.01 -10.34 1.02 -10 0 C-2.25 -1.125 -2.25 -1.125 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(192,247)" />
       <path d="M0 0 C1.31534494 3.65857532 0.65468309 6.08026481 -0.4375 9.75 C-0.86869141 11.22726562 -0.86869141 11.22726562 -1.30859375 12.734375 C-1.53675781 13.48203125 -1.76492187 14.2296875 -2 15 C-2.66 14.67 -3.32 14.34 -4 14 C-3.71715982 12.22773547 -3.42339502 10.457212 -3.125 8.6875 C-2.96257812 7.70136719 -2.80015625 6.71523438 -2.6328125 5.69921875 C-2 3 -2 3 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(252,298)" />
       <path d="M0 0 C0.66 0 1.32 0 2 0 C3.91302307 3.26613695 4.35674661 5.99445248 4.625 9.75 C4.69976562 10.73484375 4.77453125 11.7196875 4.8515625 12.734375 C4.92503906 13.85585938 4.92503906 13.85585938 5 15 C3.26830404 11.8377726 2.2871024 8.73257278 1.375 5.25 C1.11460937 4.26515625 0.85421875 3.2803125 0.5859375 2.265625 C0.39257812 1.51796875 0.19921875 0.7703125 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(241,295)" />
       <path d="M0 0 C0.66 0.33 1.32 0.66 2 1 C-0.97 4.96 -0.97 4.96 -4 9 C-4.99 8.67 -5.98 8.34 -7 8 C-5.38405168 5.95880212 -3.7143618 3.95927063 -2 2 C-1.34 2 -0.68 2 0 2 C0 1.34 0 0.68 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(332,279)" />
       <path d="M0 0 C1.55693206 2.33539809 2.90200646 4.57968756 4.1875 7.0625 C4.55230469 7.75472656 4.91710937 8.44695312 5.29296875 9.16015625 C5.52628906 9.76730469 5.75960938 10.37445313 6 11 C5.67 11.66 5.34 12.32 5 13 C2.53686261 11.17251097 1.16571382 9.77023784 0.51171875 6.73046875 C0.27481707 4.48520654 0.09638651 2.25544422 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(254,199)" />
       <path d="M0 0 C0.99 0.33 1.98 0.66 3 1 C2.525625 2.051875 2.05125 3.10375 1.5625 4.1875 C0.30676259 7.10175851 -0.52234381 9.84746914 -1 13 C-1.33 13 -1.66 13 -2 13 C-1.85915204 11.20793453 -1.71216299 9.41635083 -1.5625 7.625 C-1.48128906 6.62726563 -1.40007812 5.62953125 -1.31640625 4.6015625 C-1 2 -1 2 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(115,131)" />
       <path d="M0 0 C0.66 0.66 1.32 1.32 2 2 C1.625 4.125 1.625 4.125 1 6 C0.67 5.67 0.34 5.34 0 5 C-0.66 6.65 -1.32 8.3 -2 10 C-2.6875 8.375 -2.6875 8.375 -3 6 C-1.5625 2.75 -1.5625 2.75 0 0 Z " fill="var(--basic-reverse-color)" transform="translate(249,186)" />
   </svg>
   <h3>Hi! How can I help you today?</h3>
        </div>
    `;
}

function groupConversationsByDate(conversations) {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterdayStart = new Date(todayStart);
    yesterdayStart.setDate(yesterdayStart.getDate() - 1);
    const sevenDaysAgo = new Date(today);
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    
    const groups = {
    today: { title: "Today", conversations: [] },
    yesterday: { title: "Yesterday", conversations: [] }, 
    pastWeek: { title: "Past 7 Days", conversations: [] },
    thisMonth: { title: "This Month", conversations: [] },
    older: { title: "Older", conversations: [] }
};
    
    conversations.forEach(conversation => {
        
        const convDate = new Date(conversation.timestamp);
        if (isNaN(convDate.getTime())) {
            console.error("Invalid timestamp for conversation:", conversation);
            return;
        }
        
        if (convDate >= todayStart) {
    groups.today.conversations.push(conversation);
} else if (convDate >= yesterdayStart) {
    groups.yesterday.conversations.push(conversation); 
} else if (convDate >= sevenDaysAgo) {
    groups.pastWeek.conversations.push(conversation);
} else if (convDate >= thisMonthStart) {
    groups.thisMonth.conversations.push(conversation);
} else {
    groups.older.conversations.push(conversation);
}
    });
    
    return groups;
}
function groupConversationsByDate(conversations) {
    const now = new Date();
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const yesterdayStart = new Date(todayStart);
    yesterdayStart.setDate(yesterdayStart.getDate() - 1);
    const sevenDaysAgo = new Date(todayStart);
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    const thisMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    
    const groups = {
        today: { title: "Today", conversations: [] },
        yesterday: { title: "Yesterday", conversations: [] },
        pastWeek: { title: "Past 7 Days", conversations: [] },
        thisMonth: { title: "This Month", conversations: [] },
        older: { title: "Older", conversations: [] }
    };
    
    conversations.forEach(conversation => {
        let convDate;
        if (typeof conversation.timestamp === 'string') {
            convDate = new Date(conversation.timestamp);
        } else if (typeof conversation.timestamp === 'object' && conversation.timestamp !== null) {
            convDate = conversation.timestamp.toDate ?
                conversation.timestamp.toDate() :
                new Date(conversation.timestamp.seconds * 1000);
        } else {
            convDate = new Date(conversation.timestamp);
        }
        
        if (isNaN(convDate.getTime())) {
            console.error("Invalid timestamp for conversation:", conversation);
            return;
        }
        
        if (convDate >= todayStart) {
            groups.today.conversations.push(conversation);
        } else if (convDate >= yesterdayStart) {
            groups.yesterday.conversations.push(conversation);
        } else if (convDate >= sevenDaysAgo) {
            groups.pastWeek.conversations.push(conversation);
        } else if (convDate >= thisMonthStart) {
            groups.thisMonth.conversations.push(conversation);
        } else {
            groups.older.conversations.push(conversation);
        }
    });
    
    return groups;
}

function formatDate(timestamp) {
    let date;
    if (typeof timestamp === 'string') {
        date = new Date(timestamp);
    } else if (typeof timestamp === 'object' && timestamp !== null) {
        date = timestamp.toDate ?
            timestamp.toDate() :
            new Date(timestamp.seconds * 1000);
    } else {
        date = new Date(timestamp);
    }
    
    if (isNaN(date.getTime())) {
        return 'Unknown date';
    }
    
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 1) {
        return 'Just now';
    } else if (diffMins < 60) {
        return `${diffMins} min ago`;
    } else if (diffHours < 24) {
        return `${diffHours} hr ago`;
    } else if (diffDays < 7) {
        return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    } else {
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
}
function renderConversationList() {
    const listContainer = document.getElementById('conversation-list');
    const sidebar = document.querySelector('.sidebar');
    let searchInput = document.getElementById('conversation-search-input');
    let sidebarHeader = document.querySelector('.sidebar-header');
    
    const oldInputsInList = listContainer.querySelectorAll('input.conversation-search-input, #conversation-search-input');
    oldInputsInList.forEach(input => {
        if (input.parentNode === listContainer) {
            input.remove();
        }
    });
    if (!searchInput) {
        searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.id = 'conversation-search-input';
        searchInput.className = 'conversation-search-input';
        searchInput.placeholder = 'Search conversations...';
        
        searchInput.addEventListener('input', (e) => {
            currentSearchTerm = e.target.value.trim().toLowerCase();
            renderConversationList();
        });
    }
    if (!sidebarHeader) {
        sidebarHeader = document.createElement('div');
        sidebarHeader.className = 'sidebar-header';
        sidebar.insertBefore(sidebarHeader, listContainer);
    }
    if (searchInput.parentNode !== sidebarHeader) {
        sidebarHeader.innerHTML = '';
        sidebarHeader.appendChild(searchInput);
    }
    let conversationsToShow = conversations;
    if (currentSearchTerm) {
        conversationsToShow = conversations.filter(convo => {
            const titleMatch = convo.title && convo.title.toLowerCase().includes(currentSearchTerm);
            const previewMatch = convo.preview && convo.preview.toLowerCase().includes(currentSearchTerm);
            return titleMatch || previewMatch;
        });
    }
    
    
    listContainer.innerHTML = '';
    if (conversationsToShow.length === 0) {
        const emptyState = document.createElement('div');
        emptyState.className = 'conversation-item';
        emptyState.innerHTML = currentSearchTerm ?
            '<div class="conversation-title">No matching conversations</div>' :
            '<div class="conversation-title">No conversations yet</div>';
        listContainer.appendChild(emptyState);
        return;
    }
    const groupedConversations = groupConversationsByDate(conversationsToShow);
    const sectionOrder = ['today', 'yesterday', 'pastWeek', 'thisMonth', 'older'];
    sectionOrder.forEach(sectionKey => {
        const group = groupedConversations[sectionKey];
        
        if (group.conversations.length > 0) {
            const sectionHeader = document.createElement('div');
            sectionHeader.className = 'conversation-section';
            sectionHeader.innerHTML = `
                ${group.title}
                <span class="conversation-section-count">(${group.conversations.length})</span>
            `;
            listContainer.appendChild(sectionHeader);
            group.conversations.forEach(conversation => {
                const item = document.createElement('div');
                item.className = `conversation-item ${conversation.id === currentConversationId ? 'active' : ''}`;
                item.dataset.convoId = conversation.id;
item.innerHTML = `
    <div class="conversation-title">${conversation.title || 'New Chat'}</div>
    <div class="conversation-preview">${conversation.preview || ''}</div>
    <div class="conversation-date">${formatDate(conversation.timestamp)}</div>
    <div class="conversation-menu">
        <button class="conversation-menu-btn" title="Conversation options">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <circle cx="12" cy="6" r="1.5"/>
                <circle cx="12" cy="12" r="1.5"/>
                <circle cx="12" cy="18" r="1.5"/>
            </svg>
        </button>
    </div>
`;
                
                item.addEventListener('click', (e) => {
                    if (!e.target.closest('.conversation-menu-btn')) {
                        loadConversation(conversation.id);
                    }
                });
                const menuBtn = item.querySelector('.conversation-menu-btn');
                
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeAllConversationMenus();
                    showConversationMenuPopup(conversation, menuBtn);
                });
                
                listContainer.appendChild(item);
            });
        }
    });
    
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.conversation-menu-popup') && !e.target.closest('.conversation-menu-btn')) {
            closeAllConversationMenus();
        }
    });
}

marked.setOptions({
    highlight: function (code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(lang, code).value;
        }
        return hljs.highlightAuto(code).value;
    },
    langPrefix: 'hljs language-',
});
function copyToClipboard(codeElement, button) {
    const text = codeElement.innerText;
    navigator.clipboard.writeText(text).then(() => {
        button.innerHTML = 'Copied!<svg width="18px" height="18px" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"> <rect width="48" height="48" fill="transparent" fill-opacity="0.01" /><path d="M10 24L20 34L40 14" stroke="#4CAF50" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" /></svg>';
        setTimeout(() => {
            button.innerHTML = '<svg fill="none" height="18px" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" stroke="none"/><rect height="12" rx="2" width="12" x="8" y="4"/><path d="M16 16v2a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2v-8a2 2 0 0 1 2 -2h2"/></svg> Copy';
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy:', err);
        button.innerHTML = '<i class="fas fa-times"></i> Failed';
        setTimeout(() => {
            button.innerHTML = '<svg fill="none" height="18px" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" stroke="none"/><rect height="12" rx="2" width="12" x="8" y="4"/><path d="M16 16v2a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2v-8a2 2 0 0 1 2 -2h2"/></svg> Copy';
        }, 2000);
    });
}
function enhanceCodeBlocks() {
    document.querySelectorAll('pre code').forEach(block => {
        if (block.closest('.code-container')) return;
        const container = document.createElement('div');
        container.className = 'code-container';
        const header = document.createElement('div');
        header.className = 'code-header';
        const lang = block.className.split('language-')[1] ||
            hljs.getLanguage(block.className)?.name ||
            (block.textContent.trim() ? hljs.highlightAuto(block.textContent).language : 'code');
        
        const languageSpan = document.createElement('span');
        languageSpan.className = 'code-language';
        languageSpan.textContent = lang || 'code';
        
        const copyButton = document.createElement('button');
        copyButton.className = 'copy-btn';
        copyButton.innerHTML = '<svg fill="none" height="18px" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none" stroke="none"/><rect height="12" rx="2" width="12" x="8" y="4"/><path d="M16 16v2a2 2 0 0 1 -2 2h-8a2 2 0 0 1 -2 -2v-8a2 2 0 0 1 2 -2h2"/></svg> Copy';
        copyButton.onclick = () => copyToClipboard(block, copyButton);
        
        header.appendChild(languageSpan);
        header.appendChild(copyButton);
        container.appendChild(header);
        const preClone = block.parentElement.cloneNode(true);
        container.appendChild(preClone);
        block.parentElement.replaceWith(container);
        if (block.textContent.trim()) {
            hljs.highlightElement(block);
        }
    });
}
function renderMathSimple() {
    if (window.MathJax && window.MathJax.typeset) {
        try {
            MathJax.typeset();
        } catch (error) {
            console.log('MathJax rendering...');
        }
    } else {
        console.log('MathJax not ready yet');
    }
}
function renderMathInElement(element) {
    if (window.MathJax && window.MathJax.typeset) {
        try {
            MathJax.typeset([element]);
        } catch (error) {
            console.log('MathJax element rendering...');
        }
    }
}
function renderMathFast(element) {
    if (!window.MathJax) {
        console.log('MathJax not loaded yet');
        return;
    }
    if (element && !mathJaxQueue.includes(element)) {
        mathJaxQueue.push(element);
    }
    if (!isMathJaxProcessing) {
        processMathQueue();
    }
}

function processMathQueue() {
    if (mathJaxQueue.length === 0 || !window.MathJax || !window.MathJax.typeset) {
        isMathJaxProcessing = false;
        return;
    }
    
    isMathJaxProcessing = true;
    const elements = [...mathJaxQueue];
    mathJaxQueue = [];
    
    try {
        MathJax.typesetPromise(elements).then(() => {
            isMathJaxProcessing = false;
            
            setTimeout(processMathQueue, 100);
        }).catch(error => {
            console.log('MathJax typeset error:', error);
            isMathJaxProcessing = false;
            setTimeout(processMathQueue, 100);
        });
    } catch (error) {
        console.log('MathJax processing error:', error);
        isMathJaxProcessing = false;
        setTimeout(processMathQueue, 100);
    }
}


function isMathJaxReady() {
    return window.MathJax && window.MathJax.typesetPromise;
}

function checkMathJaxLoading() {
    console.log("Checking MathJax...");
    console.log("Window.MathJax:", window.MathJax);
    console.log("MathJax typeset:", window.MathJax && window.MathJax.typeset);
    
    if (window.MathJax) {
        console.log(" MathJax is loaded!");
    } else {
        console.log(" MathJax not loaded yet");
        setTimeout(checkMathJaxLoading, 1000);
    }
}
document.addEventListener('DOMContentLoaded', function() {
    const checkMathJax = setInterval(() => {
        if (window.MathJax && window.MathJax.typesetPromise) {
            console.log('MathJax is ready!');
            clearInterval(checkMathJax);
        }
    }, 500);
    setTimeout(() => {
        clearInterval(checkMathJax);
        if (!window.MathJax) {
            console.warn('MathJax failed to load');
        }
    }, 10000);
});
function appendMessage(content, className, files = []) {
    const responseDiv = document.getElementById('response');
    const homeGreeting = document.getElementById('homeGreeting');
    if (homeGreeting && className.includes('user-msg')) {
        homeGreeting.style.display = "none";
    }
    
    const imageFiles = files.filter(file =>
        file.type.startsWith('image/') || file.type.startsWith('video/')
    );
    const otherFiles = files.filter(file =>
        !file.type.startsWith('image/') && !file.type.startsWith('video/')
    );
    
    // --- Render media ABOVE the message bubble ---
    if (imageFiles.length > 0) {
        const mediaContainer = document.createElement('div');
mediaContainer.className = 'user-media-container'; //  changed class
        imageFiles.forEach(fileInfo => {
            const mediaWrapper = document.createElement('div');
            mediaWrapper.style.position = 'relative';
            mediaWrapper.style.maxWidth = '100%';
            mediaWrapper.style.marginBottom = '8px';
            const localUrl = URL.createObjectURL(fileInfo.file);
            if (fileInfo.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = localUrl;
                img.className = 'user-media';
                img.style.cursor = 'pointer';
                img.onload = () => URL.revokeObjectURL(localUrl);
                img.onclick = () => viewImageFromUrl({ href: localUrl });
                mediaWrapper.appendChild(img);
            } else if (fileInfo.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = localUrl;
                video.className = 'user-media';
                video.controls = true;
                video.style.maxHeight = '200px';
                video.style.borderRadius = '8px';
                video.style.objectFit = 'contain';
                video.onload = () => URL.revokeObjectURL(localUrl);
                mediaWrapper.appendChild(video);
            }
            mediaContainer.appendChild(mediaWrapper);
        });
        responseDiv.appendChild(mediaContainer);
    }
    
    // --- Now render the actual message bubble (without images/videos inside) ---
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble ${className}`;
    
    if (content) {
        const textElement = document.createElement('div');
        textElement.textContent = content;
        textElement.style.wordBreak = 'break-word';
        textElement.style.whiteSpace = 'pre-wrap';
        bubble.appendChild(textElement);
    }
    
    // Attach non-image/video files inside the bubble
    if (otherFiles.length > 0) {
        const filesContainer = document.createElement('div');
        filesContainer.className = 'message-files-container';
        otherFiles.forEach(fileInfo => {
            const fileType = getFileType(fileInfo);
            const fileElement = document.createElement('div');
            fileElement.className = 'message-file';
            const iconElement = document.createElement('i');
            iconElement.className = `${fileType.icon.split(' ')[0]} ${fileType.icon.split(' ')[1]} ${fileType.class}`;
            const nameElement = document.createElement('span');
            nameElement.textContent = fileInfo.name.length > 20 ?
                fileInfo.name.substring(0, 17) + '...' : fileInfo.name;
            fileElement.appendChild(iconElement);
            fileElement.appendChild(nameElement);
            filesContainer.appendChild(fileElement);
        });
        bubble.appendChild(filesContainer);
    }
    
    responseDiv.appendChild(bubble);
    
    if (className === 'bot-msg') {
        setTimeout(() => {
            enhanceCodeBlocks();
            bubble.querySelectorAll('pre code').forEach(block => {
                if (block.textContent.trim()) {
                    hljs.highlightElement(block);
                }
            });
        }, 100);
    }
    
    setTimeout(() => {
        renderMathFast(bubble);
    }, 300);
    
    responseDiv.scrollTop = responseDiv.scrollHeight;
}

function typeEffect(markdown, className, messageId = null) {
    const responseDiv = document.getElementById('response');
    const homeGreeting = document.getElementById('homeGreeting');
    const sendBtn = document.getElementById('sendBtn');
    
    if (homeGreeting) homeGreeting.style.display = "none";
    if (sendBtn) sendBtn.disabled = true;
    
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble ${className}`;
    
    if (!messageId) {
        messageId = `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    bubble.id = messageId;
    
    responseDiv.appendChild(bubble);
    
    let currentPosition = 0;
    const chunkSize = 90;
    const speed = 80;
    
    const typingInstance = {
        bubble: bubble,
        markdown: markdown,
        isComplete: false,
        messageId: messageId
    };
    
    currentTypingInstance = typingInstance;
    
    function typeWriter() {
        if (currentTypingInstance !== typingInstance) return;
        
        if (currentPosition < markdown.length) {
            const partialMarkdown = markdown.substring(0, currentPosition + chunkSize);
            bubble.innerHTML = marked.parse(partialMarkdown);
            // Enhance code blocks in real-time
            enhanceCodeBlocks();
            bubble.querySelectorAll('pre code').forEach(block => {
                if (block.textContent.trim()) {
                    hljs.highlightElement(block);
                }
            });
            currentPosition += chunkSize;
            responseDiv.scrollTop = responseDiv.scrollHeight;
            setTimeout(typeWriter, speed);

        } else {
            enhanceCodeBlocks();
bubble.querySelectorAll('pre code').forEach(block => {
    if (block.textContent.trim()) {
        hljs.highlightElement(block);
    }
});
            
            finishTyping();
        }
    }
    
    function finishTyping() {
        bubble.innerHTML = marked.parse(markdown);
        
        enhanceCodeBlocks();
        bubble.querySelectorAll('pre code').forEach(block => {
            if (block.textContent.trim()) {
                hljs.highlightElement(block);
            }
        });
        
        setTimeout(() => {
            if (currentTypingInstance === typingInstance) {
                renderMathInElement(bubble);
            }
        }, 500);
        
        if (className === 'bot-msg') {
            addActionButtons(bubble, markdown, messageId);
        }
        
        if (sendBtn) sendBtn.disabled = false;
        responseDiv.scrollTop = responseDiv.scrollHeight;
        typingInstance.isComplete = true;
    }
    
    bubble.innerHTML = '';
    typeWriter();
}


function addActionButtons(bubble, content, messageId) {
    // Create a container for the action buttons
    const actionButtonsContainer = document.createElement('div');
    actionButtonsContainer.className = 'action-buttons-container';
    actionButtonsContainer.style.marginTop = '13px';
    actionButtonsContainer.style.marginLeft = '7px';
    actionButtonsContainer.style.textAlign = 'left';
    actionButtonsContainer.style.display = 'flex';
    actionButtonsContainer.style.justifyContent = 'flex-start';
    actionButtonsContainer.style.gap = '0px';
    
    const copyButton = document.createElement('button');
    copyButton.className = 'action-btn copy-btn';
    copyButton.innerHTML = '<svg xmlns:xlink="http://www.w3.org/1999/xlink" width="22" height="22" viewBox="0 0 20 20" fill="var(--basic-reverse-color)" xmlns="http://www.w3.org/2000/svg"><path d="M12.668 10.667C12.668 9.95614 12.668 9.46258 12.6367 9.0791C12.6137 8.79732 12.5758 8.60761 12.5244 8.46387L12.4688 8.33399C12.3148 8.03193 12.0803 7.77885 11.793 7.60254L11.666 7.53125C11.508 7.45087 11.2963 7.39395 10.9209 7.36328C10.5374 7.33197 10.0439 7.33203 9.33301 7.33203H6.5C5.78896 7.33203 5.29563 7.33195 4.91211 7.36328C4.63016 7.38632 4.44065 7.42413 4.29688 7.47559L4.16699 7.53125C3.86488 7.68518 3.61186 7.9196 3.43555 8.20703L3.36524 8.33399C3.28478 8.49198 3.22795 8.70352 3.19727 9.0791C3.16595 9.46259 3.16504 9.95611 3.16504 10.667V13.5C3.16504 14.211 3.16593 14.7044 3.19727 15.0879C3.22797 15.4636 3.28473 15.675 3.36524 15.833L3.43555 15.959C3.61186 16.2466 3.86474 16.4807 4.16699 16.6348L4.29688 16.6914C4.44063 16.7428 4.63025 16.7797 4.91211 16.8027C5.29563 16.8341 5.78896 16.835 6.5 16.835H9.33301C10.0439 16.835 10.5374 16.8341 10.9209 16.8027C11.2965 16.772 11.508 16.7152 11.666 16.6348L11.793 16.5645C12.0804 16.3881 12.3148 16.1351 12.4688 15.833L12.5244 15.7031C12.5759 15.5594 12.6137 15.3698 12.6367 15.0879C12.6681 14.7044 12.668 14.211 12.668 13.5V10.667ZM13.998 12.665C14.4528 12.6634 14.8011 12.6602 15.0879 12.6367C15.4635 12.606 15.675 12.5492 15.833 12.4688L15.959 12.3975C16.2466 12.2211 16.4808 11.9682 16.6348 11.666L16.6914 11.5361C16.7428 11.3924 16.7797 11.2026 16.8027 10.9209C16.8341 10.5374 16.835 10.0439 16.835 9.33301V6.5C16.835 5.78896 16.8341 5.29563 16.8027 4.91211C16.7797 4.63025 16.7428 4.44063 16.6914 4.29688L16.6348 4.16699C16.4807 3.86474 16.2466 3.61186 15.959 3.43555L15.833 3.36524C15.675 3.28473 15.4636 3.22797 15.0879 3.19727C14.7044 3.16593 14.211 3.16504 13.5 3.16504H10.667C9.9561 3.16504 9.46259 3.16595 9.0791 3.19727C8.79739 3.22028 8.6076 3.2572 8.46387 3.30859L8.33399 3.36524C8.03176 3.51923 7.77886 3.75343 7.60254 4.04102L7.53125 4.16699C7.4508 4.32498 7.39397 4.53655 7.36328 4.91211C7.33985 5.19893 7.33562 5.54719 7.33399 6.00195H9.33301C10.022 6.00195 10.5791 6.00131 11.0293 6.03809C11.4873 6.07551 11.8937 6.15471 12.2705 6.34668L12.4883 6.46875C12.984 6.7728 13.3878 7.20854 13.6533 7.72949L13.7197 7.87207C13.8642 8.20859 13.9292 8.56974 13.9619 8.9707C13.9987 9.42092 13.998 9.97799 13.998 10.667V12.665ZM18.165 9.33301C18.165 10.022 18.1657 10.5791 18.1289 11.0293C18.0961 11.4302 18.0311 11.7914 17.8867 12.1279L17.8203 12.2705C17.5549 12.7914 17.1509 13.2272 16.6553 13.5313L16.4365 13.6533C16.0599 13.8452 15.6541 13.9245 15.1963 13.9619C14.8593 13.9895 14.4624 13.9935 13.9951 13.9951C13.9935 14.4624 13.9895 14.8593 13.9619 15.1963C13.9292 15.597 13.864 15.9576 13.7197 16.2939L13.6533 16.4365C13.3878 16.9576 12.9841 17.3941 12.4883 17.6982L12.2705 17.8203C11.8937 18.0123 11.4873 18.0915 11.0293 18.1289C10.5791 18.1657 10.022 18.165 9.33301 18.165H6.5C5.81091 18.165 5.25395 18.1657 4.80371 18.1289C4.40306 18.0962 4.04235 18.031 3.70606 17.8867L3.56348 17.8203C3.04244 17.5548 2.60585 17.151 2.30176 16.6553L2.17969 16.4365C1.98788 16.0599 1.90851 15.6541 1.87109 15.1963C1.83431 14.746 1.83496 14.1891 1.83496 13.5V10.667C1.83496 9.978 1.83432 9.42091 1.87109 8.9707C1.90851 8.5127 1.98772 8.10625 2.17969 7.72949L2.30176 7.51172C2.60586 7.0159 3.04236 6.6122 3.56348 6.34668L3.70606 6.28027C4.04237 6.136 4.40303 6.07083 4.80371 6.03809C5.14051 6.01057 5.53708 6.00551 6.00391 6.00391C6.00551 5.53708 6.01057 5.14051 6.03809 4.80371C6.0755 4.34588 6.15483 3.94012 6.34668 3.56348L6.46875 3.34473C6.77282 2.84912 7.20856 2.44514 7.72949 2.17969L7.87207 2.11328C8.20855 1.96886 8.56979 1.90385 8.9707 1.87109C9.42091 1.83432 9.978 1.83496 10.667 1.83496H13.5C14.1891 1.83496 14.746 1.83431 15.1963 1.87109C15.6541 1.90851 16.0599 1.98788 16.4365 2.17969L16.6553 2.30176C17.151 2.60585 17.5548 3.04244 17.8203 3.56348L17.8867 3.70606C18.031 4.04235 18.0962 4.40306 18.1289 4.80371C18.1657 5.25395 18.165 5.81091 18.165 6.5V9.33301Z" fill="var(--basic-reverse-color)"></path></svg>';
    copyButton.title = 'Copy this response';
    
    copyButton.addEventListener('click', function() {
        const textToCopy = bubble.textContent || bubble.innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            const originalHTML = copyButton.innerHTML;
            copyButton.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            copyButton.style.color = '#4CAF50';
            
            setTimeout(() => {
                copyButton.innerHTML = originalHTML;
                copyButton.style.color = 'var(--basic-reverse-color)';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            copyButton.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M6 18L18 6M6 6l12 12" stroke="#ff4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Failed';
            copyButton.style.color = '#ff4444';
            
            setTimeout(() => {
                copyButton.innerHTML = originalHTML;
                copyButton.style.color = 'var(--basic-reverse-color)';
            }, 2000);
        });
    });
    
    const downloadButton = document.createElement('button');
    downloadButton.className = 'action-btn download-btn';
    downloadButton.innerHTML = '<svg xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M12 3a1 1 0 0 1 1 1v9.586l2.293-2.293a1 1 0 0 1 1.414 1.414l-4 4a1 1 0 0 1-1.414 0l-4-4a1 1 0 1 1 1.414-1.414L11 13.586V4a1 1 0 0 1 1-1Z" fill="var(--basic-reverse-color)"/><path d="M6 17a1 1 0 1 0-2 0v.6C4 19.482 5.518 21 7.4 21h9.2c1.882 0 3.4-1.518 3.4-3.4V17a1 1 0 1 0-2 0v.6c0 .778-.622 1.4-1.4 1.4H7.4c-.778 0-1.4-.622-1.4-1.4V17Z" fill="var(--basic-reverse-color)"/></svg>';
    downloadButton.title = 'Download this response';
    
downloadButton.addEventListener('click', function() {
    const textToDownload = bubble.textContent || bubble.innerText;
    const blob = new Blob([textToDownload], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `response_${messageId}.txt`;
    document.body.appendChild(a);
a.click();
document.body.removeChild(a);
setTimeout(() => {
    URL.revokeObjectURL(url);
}, 2000);
    
    const originalHTML = downloadButton.innerHTML;
    downloadButton.innerHTML = '<svg width="22" height="22" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
    downloadButton.style.color = '#4CAF50';
    
    setTimeout(() => {
        downloadButton.innerHTML = originalHTML;
        downloadButton.style.color = 'var(--basic-reverse-color)';
        URL.revokeObjectURL(url);
    }, 2000);
});

actionButtonsContainer.appendChild(copyButton);
actionButtonsContainer.appendChild(downloadButton);
bubble.appendChild(actionButtonsContainer);
}
function downloadConversation(conversationId) {
    const conversation = conversations.find(c => c.id === conversationId);
    if (!conversation) {
        console.error("Conversation not found:", conversationId);
        return;
    }
    let conversationText = `Nurvle Conversation\n`;
    conversationText += `Title: ${conversation.title || 'Untitled'}\n`;
    conversationText += `Date: ${new Date(conversation.timestamp).toLocaleDateString()}\n`;
    conversationText += `Time: ${new Date(conversation.timestamp).toLocaleTimeString()}\n`;
    conversationText += '='.repeat(50) + '\n\n';
    
    conversation.messages.forEach((message, index) => {
        const isUser = message.role === 'user';
        const sender = isUser ? 'USER' : 'ASSISTANT';
        const content = message.content || '';
                if (index > 0) {
            conversationText += '\n' + '-'.repeat(50) + '\n\n';
        }
        
        conversationText += `${sender}:\n`;
        conversationText += content + '\n';
        
        if (isUser && message.files && message.files.length > 0) {
            conversationText += '\nAttachments:\n';
            message.files.forEach(file => {
                conversationText += `- ${file.name} (${file.type}, ${(file.size / 1024).toFixed(2)} KB)\n`;
            });
        }
    });
    
    conversationText += '\n' + '='.repeat(50) + '\n';
    conversationText += 'End of conversation\n';
    
    const blob = new Blob([conversationText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `nurvle_conversation_${conversationId}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => {
        URL.revokeObjectURL(url);
    }, 2000);
}

function showNotification(message) {
  const notification = document.createElement('div');
  notification.classList.add('notification');
  notification.innerText = message;
  document.body.appendChild(notification);
  setTimeout(() => {
    notification.classList.add('hide');
  }, 1500);
  setTimeout(() => {
    notification.remove();
  },3000);
}
function formatConversationForDownload() {
    const messages = document.querySelectorAll('.chat-bubble');
    let conversationText = `Nurvle Conversation\n`;
    conversationText += `Date: ${new Date().toLocaleDateString()}\n`;
    conversationText += `Time: ${new Date().toLocaleTimeString()}\n`;
    conversationText += '='.repeat(50) + '\n\n';
    
    messages.forEach((message, index) => {
        const isUser = message.classList.contains('user-msg');
        const sender = isUser ? 'USER' : 'ASSISTANT';
        const content = message.textContent || message.innerText;
        
        if (index > 0) {
            conversationText += '\n' + '-'.repeat(50) + '\n\n';
        }
        
        conversationText += `${sender}:\n`;
        conversationText += content + '\n';
    });
    
    conversationText += '\n' + '='.repeat(50) + '\n';
    conversationText += 'End of conversation\n';
    
    return conversationText;
}
function saveMessageToStorage(messageId, content, className) {
    try {
        const messages = JSON.parse(localStorage.getItem('nurvle_messages') || '{}');
        messages[messageId] = {
            content: content,
            type: className,
            timestamp: Date.now()
        };
        localStorage.setItem('nurvle_messages', JSON.stringify(messages));
    } catch (error) {
        console.error('Error saving message to storage:', error);
    }
}

function getMessageFromStorage(messageId) {
    try {
        const messages = JSON.parse(localStorage.getItem('nurvle_messages') || '{}');
        return messages[messageId] || null;
    } catch (error) {
        console.error('Error retrieving message from storage:', error);
        return null;
    }
}

function clearMessageStorage() {
    try {
        localStorage.removeItem('nurvle_messages');
    } catch (error) {
        console.error('Error clearing message storage:', error);
    }
}
function getCurrentDateTimeInfo() {
    const now = new Date();
    const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return {
        time: now.toLocaleTimeString(),
        date: now.toLocaleDateString(),
        dayName: days[now.getDay()],
        day: now.getDate(),
        monthName: months[now.getMonth()],
        month: now.getMonth() + 1,
        year: now.getFullYear(),
        hours: now.getHours(),
        minutes: now.getMinutes(),
        seconds: now.getSeconds(),
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        fullDateTime: now.toString()
    };
}

async function performWebSearch(query, useAIMode = true) {
    if (!SERPAPI_KEY) {
        console.error("SerpAPI key is not configured.");
        throw new Error("Web search is not configured correctly.");
    }
    
    const encodedQuery = encodeURIComponent(query);
    let serpApiUrl;
    
    let contextualQuery = query;
    if (searchConversationHistory.length > 0) {
        const recentHistory = searchConversationHistory.slice(-3); // Last 3 exchanges
        const context = recentHistory.map(entry =>
            `${entry.role === 'user' ? 'User: ' : 'Assistant: '}${entry.content}`
        ).join('\n');
        
        contextualQuery = `Context: ${context}\n\nCurrent query: ${query}`;
    }
    
    const encodedContextualQuery = encodeURIComponent(contextualQuery);
    
    if (useAIMode) {
        serpApiUrl = `https://corsproxy.io/?${encodeURIComponent(
            `https://serpapi.com/search.json?engine=google_ai_mode&q=${encodedContextualQuery}&api_key=${SERPAPI_KEY}&hl=en&gl=us&no_cache=true`
        )}`;
    } else {
        serpApiUrl = `https://corsproxy.io/?${encodeURIComponent(
            `https://serpapi.com/search.json?engine=google&q=${encodedContextualQuery}&api_key=${SERPAPI_KEY}&hl=en&gl=us&no_cache=true`
        )}`;
    }
    
    try {
        console.log(`Performing ${useAIMode ? 'AI Mode' : 'regular'} search for: ${query}`);
        console.log(`Contextual query: ${contextualQuery}`);
        
        const response = await fetch(serpApiUrl);
        
        if (!response.ok) {
            throw new Error(`SerpAPI request failed with status ${response.status}`);
        }
        
        const data = await response.json();
        searchConversationHistory.push({
            role: 'user',
            content: query,
            timestamp: Date.now()
        });
        
        if (useAIMode && data.error) {
            console.warn("AI Mode search failed, falling back to regular search:", data.error);
            return await performWebSearch(query, false);
        }
        
        return data;
    } catch (error) {
        console.error("Error performing web search:", error);
        if (useAIMode) {
            console.warn("AI Mode search failed, falling back to regular search");
            return await performWebSearch(query, false);
        }
        
        throw error;
    }
}
function extractAIResults(searchData) {
    if (!searchData) {
        console.warn("Invalid search data");
        return { textBlocks: [], references: [], quickResults: [], shoppingResults: [] };
    }
    
    const results = {
        textBlocks: searchData.text_blocks || [],
        references: searchData.references || [],
        quickResults: searchData.quick_results || [],
        shoppingResults: searchData.shopping_results || [],
        inlineImages: searchData.inline_images || [],
        inlineProducts: searchData.inline_products || [],
        organicResults: searchData.organic_results || [],
        conversationContext: searchData.conversation_context || null
    };
    
    return results;
}
function formatAIResultsForPrompt(aiResults, maxTextBlocks = 3, maxReferences = 5) {
    let formattedText = "Google AI Mode provides these insights:\n\n";
        if (aiResults.conversationContext) {
        formattedText += "## Continuing Conversation\n";
        formattedText += aiResults.conversationContext + "\n\n";
    }
    if (aiResults.textBlocks && aiResults.textBlocks.length > 0) {
        formattedText += "## AI-Generated Summary\n";
        
        const limitedTextBlocks = aiResults.textBlocks.slice(0, maxTextBlocks);
        limitedTextBlocks.forEach((block, index) => {
            if (block.type === "paragraph" && block.snippet) {
                formattedText += `${block.snippet}\n\n`;
            } else if (block.type === "list" && block.list) {
                formattedText += " " + block.list.map(item => item.snippet || item.title).join("\n ") + "\n\n";
            }
        });
    }
    if (aiResults.references && aiResults.references.length > 0) {
        formattedText += "## Cited Sources\n";
        
        const limitedReferences = aiResults.references.slice(0, maxReferences);
        limitedReferences.forEach((ref, index) => {
            formattedText += `${index + 1}. ${ref.title || 'Unknown source'}`;
            if (ref.link) {
                formattedText += ` (${ref.link})`;
            }
            formattedText += "\n";
        });
        formattedText += "\n";
    }
    
    if (aiResults.quickResults && aiResults.quickResults.length > 0) {
        formattedText += "## Quick Answers\n";
        
        aiResults.quickResults.forEach((result, index) => {
            formattedText += `${index + 1}. ${result.title}\n`;
            if (result.snippet) {
                formattedText += `   ${result.snippet}\n`;
            }
            if (result.link) {
                formattedText += `   Source: ${result.link}\n`;
            }
            formattedText += "\n";
        });
    }
    
    if (aiResults.organicResults && aiResults.organicResults.length > 0 &&
        (!aiResults.textBlocks || aiResults.textBlocks.length === 0)) {
        formattedText += "## Top Search Results\n";
        
        aiResults.organicResults.slice(0, 5).forEach((result, index) => {
            formattedText += `${index + 1}. ${result.title}\n`;
            if (result.snippet) {
                formattedText += `   ${result.snippet}\n`;
            }
            if (result.link) {
                formattedText += `   ${result.link}\n`;
            }
            formattedText += "\n";
        });
    }
    
    return formattedText;
}

function clearSearchHistory() {
    searchConversationHistory = [];
    console.log("Search conversation history cleared");
}

function extractTopResults(searchData, topN = 10) {
    if (!searchData || !Array.isArray(searchData.organic_results)) {
        console.warn("Invalid search data format or no results found.");
        return [];
    }
    return searchData.organic_results.slice(0, topN);
}

function formatSearchResultsForPrompt(results) {
    if (!results || results.length === 0) {
        return "No relevant search results were found.";
    }
    
    let formattedText = "Here are the top search results:\n\n";
    results.forEach((result, index) => {
        formattedText += `${index + 1}. Title: ${result.title || 'N/A'}\n`;
        formattedText += `   Snippet: ${result.snippet || 'N/A'}\n`;
        formattedText += `   Link: ${result.link || 'N/A'}\n\n`;
    });
    return formattedText;
}
function clearSearchPersistence() {
    localStorage.removeItem('searchPersistent');
    const searchBtn = document.getElementById('search-btn');
    if (searchBtn) {
        searchBtn.classList.remove('active');
        searchBtn.title = "Enable Web Search";
        searchBtn.style.backgroundColor = "var(--chatinputareabtnbg)";
        searchBtn.style.color = "var(--basic-reverse-color)";
    }
    console.log("Search persistence cleared");
}


function forceRerenderCodeBlocks() {
    document.querySelectorAll('.code-container').forEach(container => {
        const codeBlock = container.querySelector('pre code');
        if (codeBlock) {
            const parent = container.parentNode;
            parent.replaceChild(codeBlock, container);
        }
    });
    
    enhanceCodeBlocks();
    document.querySelectorAll('pre code').forEach(block => {
        if (block.textContent.trim()) {
            hljs.highlightElement(block);
        }
    });
}


const actionButtonsStyles = `
.action-buttons-container {
    margin-top: 10px;
    margin-left: 10px
    display: flex;
    gap: 2px;
    opacity: 1;
    transition: opacity 0.3s ease;
}

.action-btn {
    padding: 6px 12px;
    border-radius: 4px;
    border: none;
    background: transparent;
    color: var(--basic-reverse-color);
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    gap: 1px;
    transition: all 0.2s ease;
}

.action-btn:focus{
    outline: none;
}

.action-btn:active {
    transform: scale(0.95);
}

.action-btn.copy-btn:hover{
    background: transparent;
}
.dark-theme .action-btn {
    border-color: var(--conversation-item-border);
}

`;
const styleElement = document.querySelector('style');
if (styleElement) {
    styleElement.textContent = styleElement.textContent.replace(/\.action-buttons-container\{[^}]*\}/g, '');
    styleElement.textContent = styleElement.textContent.replace(/\.action-btn\{[^}]*\}/g, '');
    styleElement.textContent += actionButtonsStyles;
} else {
    const newStyleElement = document.createElement('style');
    newStyleElement.textContent = actionButtonsStyles;
    document.head.appendChild(newStyleElement);
}
document.addEventListener('DOMContentLoaded', function() {
    try {
        const messages = JSON.parse(localStorage.getItem('nurvle_messages') || '{}');
        if (Object.keys(messages).length > 0) {
            console.log('Loaded persistent messages:', Object.keys(messages).length);
        }
    } catch (error) {
        console.error('Error loading persistent messages:', error);
        clearMessageStorage();
    }
});
if (currentTypingInstance) {
    currentTypingInstance = null;
}
async function sendMessage() {
    let aiResults = null;
    
    if (isImageGenerationMode) {
        await handleImageGeneration();
        return;
    }
    
    if (!currentModel) {
        console.error("Model not loaded yet");
        appendMessage("Configuration not loaded. Please try again.", 'bot-msg error-message');
        return;
    }
    const input = document.getElementById('userInput');
    const message = input.value.trim();
    const sendBtn = document.getElementById('sendBtn');
    if (!message && selectedFiles.length === 0) return;
    sendBtn.disabled = true;
    if (!currentConversationId) {
        currentConversationId = Date.now().toString();
    }
    let userMessageContent = message || "Describe these files";
    
    const fileInfoForMessage = selectedFiles.map(f => ({
        name: f.name,
        type: f.type,
        size: f.size,
        fileId: null
    }));
    currentMessages.push({
        role: 'user',
        content: message || "Describe these files",
        files: fileInfoForMessage,
        timestamp: Date.now()
    });
    
    appendMessage(message || "Describe these files", 'user-msg', selectedFiles);
    
    input.value = '';
    const filesToUpload = [...selectedFiles];
    selectedFiles = [];
    updatePreview();
    input.style.height = '40px';
    document.getElementById('chatInputArea').style.minHeight = '95px';
    
    toggleSendButtonVisibility();
    const searchBtn = document.getElementById('search-btn');
    let isSearchRequested = false;

    if (searchBtn) {
        const isCurrentlyActive = searchBtn.classList.contains('active');
        const isPersistentActive = localStorage.getItem('searchPersistent') === 'true';
        
        isSearchRequested = isCurrentlyActive || isPersistentActive;
        
        if (isPersistentActive && !isCurrentlyActive) {
            searchBtn.classList.add('active');
            searchBtn.title = "Web Search Enabled - Click to disable";
        }
        
        console.log("Search detection - Button active:", isCurrentlyActive, "Persistent:", isPersistentActive, "Final decision:", isSearchRequested);
    } else {
        console.error("Search button not found!");
        isSearchRequested = localStorage.getItem('searchPersistent') === 'true';
    }

    console.log("Search requested:", isSearchRequested, "Query:", userMessageContent);
    let searchResultsForPrompt = "";
    let searchPerformed = false;

    try {
        const fileInfoToUpdateInHistory = currentMessages[currentMessages.length - 1].files;
        for (let i = 0; i < filesToUpload.length; i++) {
            const fileInfo = filesToUpload[i];
            if (fileInfo.file) {
                try {
                    const previewItem = document.querySelector(`.preview-item[data-file-id="${fileInfo.id}"]`);
                    if (previewItem) {
                        const progressBarContainer = previewItem.querySelector('.progress-bar-container');
                        const progressBar = previewItem.querySelector('.progress-bar');
                        if (progressBarContainer && progressBar) {
                            progressBarContainer.style.display = 'block';
                            progressBar.style.width = '0%';
                        }
                    }
                    
                    const response = await storage.createFile(
                        APPWRITE_BUCKET_ID,
                        'unique()',
                        fileInfo.file,
                        [],
                        [],
                        (chunk) => {
                            if (previewItem) {
                                const progressBar = previewItem.querySelector('.progress-bar');
                                if (progressBar && chunk.total > 0) {
                                    const percent = (chunk.loaded / chunk.total) * 100;
                                    progressBar.style.width = `${percent}%`;
                                }
                            }
                        }
                    );
                    
                    const fileId = response.$id;
                    if (fileInfoToUpdateInHistory[i]) {
                        fileInfoToUpdateInHistory[i].fileId = fileId;
                    }
                    console.log(`File \( {fileInfo.name} uploaded with ID: \){fileId}`);
                    
                    if (previewItem) {
                        const progressBarContainer = previewItem.querySelector('.progress-bar-container');
                        if (progressBarContainer) {
                            progressBarContainer.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error(`Error uploading file ${fileInfo.name}:`, error);
                    const previewItem = document.querySelector(`.preview-item[data-file-id="${fileInfo.id}"]`);
                    if (previewItem) {
                        const progressBarContainer = previewItem.querySelector('.progress-bar-container');
                        if (progressBarContainer) {
                            progressBarContainer.style.display = 'none';
                        }
                    }
                    appendMessage(`Error uploading file ${fileInfo.name}.`, 'bot-msg error-message');
                    if (fileInfoToUpdateInHistory[i]) {
                        fileInfoToUpdateInHistory[i].fileId = null;
                    }
                }
            } else {
                console.warn(`File object not found for ${fileInfo.name}`);
                if (fileInfoToUpdateInHistory[i]) {
                    fileInfoToUpdateInHistory[i].fileId = null;
                }
            }
        }
        
        let aiResults = null;
        
        if (isSearchRequested) {
            showSearchingAnimation();
            try {
                console.log("Initiating Google AI Mode search for query:", userMessageContent);
                
                const searchData = await performWebSearch(userMessageContent, true);
                aiResults = extractAIResults(searchData); 
                searchResultsForPrompt = formatAIResultsForPrompt(aiResults);
                
                searchPerformed = true;
                console.log("Google AI Mode search results prepared for prompt.");
            } catch (searchError) {
                console.error('Google AI Mode Search Error:', searchError);
                hideSearchingAnimation();
                appendMessage(`Error during Google AI Mode search: ${searchError.message}. Proceeding without search results.`, 'bot-msg error-message');
            }
        } else {
            showThinkingAnimation();
        }
        const contents = [];
        for (const msg of currentMessages) {
            if (msg.role === 'user') {
                const parts = [];
                if (msg.content) {
                    parts.push({ text: msg.content });
                }
                
                if (msg.files && msg.files.length > 0) {
                    for (const fileInfo of msg.files) {
                        const originalFileInfo = filesToUpload.find(f => f.name === fileInfo.name && f.size === fileInfo.size);
                        if (originalFileInfo && originalFileInfo.file) {
                            try {
                                const base64Data = await fileToBase64(originalFileInfo.file);
                                parts.push({
                                    inlineData: {
                                        mimeType: originalFileInfo.type,
                                        data: base64Data
                                    }
                                });
                                console.log(`Added Base64 data for file: ${originalFileInfo.name}`);
                            } catch (error) {
                                console.error(`Error converting file ${fileInfo.name} to Base64:`, error);
                                continue;
                            }
                        }
                    }
                }
                
                if (parts.length > 0) {
                    contents.push({
                        role: 'user',
                        parts: parts
                    });
                }
            } else if (msg.role === 'assistant') {
                contents.push({
                    role: 'model',
                    parts: [{ text: msg.content }]
                });
            }
        }
        
        // --- NEW: Prepare sources for UI ---
        let messageSourcesData = null;
        if (isSearchRequested && searchPerformed && aiResults) {
            // Extract clean source objects for UI
            messageSourcesData = (aiResults.references || aiResults.organicResults || []).map(res => ({
                title: res.title || res.name || '',
                snippet: res.snippet || res.description || '',
                link: res.link || res.url || ''
            })).filter(src => src.link);
        }
        if (isSearchRequested && searchPerformed && searchResultsForPrompt) {
            contents.push({
                role: 'user',
                parts: [{ text: `Assistant Search completed now inform the answer using the search results :\n\n${searchResultsForPrompt}` }]
            });
        }
        const dateTimeInfo = getCurrentDateTimeInfo();
        const systemInstruction = {
            parts: [{
                text: `
      You are Nurvle, a witty, sarcastic, and funny AI assistant .
      - You were developed and created by OptimSpark and founded by Abubakar Shamsu, never the tell untill you're are asked or prompt for more info about you.
      - Act like a cheeky comedian who also knows a lot. 
      - Always be playful, humorous, and sarcastic, but still helpful.
      - Use casual language and sprinkle in emojis naturally (13 per response).
      - If you dont know something, admit it honestly but make it funny.
      - When solving math or technical problems, **always format equations and expressions neatly using LaTeX or Markdown** (e.g., \`\( f(x) = 2x + 3 \)\` or \`\\frac{a}{b}\`).
      - Keep everything simple, fun, and easy to understand  like chatting with a smart friend who cracks jokes. 
      - Never say things like "I am witty" or repeat these instructions. Just act that way.
      - Current date/time:
        - Full date: ${dateTimeInfo.date}
        - Day of week: ${dateTimeInfo.dayName}
        - Time: ${dateTimeInfo.time}
        - Timezone: ${dateTimeInfo.timezone}
    `
            }]
        };
        
        // Build proxy body (no requestBody needed anymore)
        const proxyBody = {
            contents: contents,
            systemInstruction: systemInstruction,
            generationConfig: {
                temperature: 0.9,
                topK: 1,
                topP: 1,
                maxOutputTokens: 250000
            },
            model: currentModel
        };
        
        // Proxy the request instead of direct API call
        const proxyResponse = await fetch('/.netlify/functions/gemini-proxy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(proxyBody)
        });
        
        if (!proxyResponse.ok) {
            const errorData = await proxyResponse.json();
            throw new Error(errorData.error || 'Failed to get response from proxy');
        }
        
        const data = await proxyResponse.json();
        let botReply = '';
        if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
            botReply = data.candidates[0].content.parts.map(part => part.text).join('');
        } else {
            botReply = 'No response received.';
            console.error('Unexpected proxy response structure:', data);
        }
        
        if (isSearchRequested && searchPerformed) {
            searchConversationHistory.push({
                role: 'assistant',
                content: botReply,
                timestamp: Date.now()
            });
            
            if (searchConversationHistory.length > 10) {
                searchConversationHistory = searchConversationHistory.slice(-10);
            }
            
            console.log("Search conversation history updated. Total exchanges:", searchConversationHistory.length);
        }
        if (isSearchRequested) {
            hideSearchingAnimation();
        }
        hideThinkingAnimation();
        // --- NEW: Prepare clean sources for UI ---
        
        if (isSearchRequested && searchPerformed && aiResults) {
            messageSourcesData = [
                    ...(aiResults.references || []),
                    ...(aiResults.organicResults || [])
                ]
                .filter(src => src.link || src.url)
                .map(src => ({
                    title: src.title || src.name || 'No title',
                    snippet: src.snippet || src.description || '',
                    link: src.link || src.url || ''
                }))
                .slice(0, 5); // Max 5 sources
        }
        
        currentMessages.push({
            role: 'assistant',
            content: botReply,
            timestamp: Date.now()
        });
        
        // Use a unique ID so we can attach the Sources button to it
        const botMessageId = `msg_${Date.now()}`;
        typeEffect(botReply, 'bot-msg', botMessageId);
        
        // Attach Sources button after message appears
        if (messageSourcesData && messageSourcesData.length > 0) {
            setTimeout(() => {
                const lastBotBubble = document.getElementById(botMessageId);
                if (lastBotBubble) {
                    addSourcesButton(lastBotBubble, messageSourcesData, botMessageId);
                }
            }, 600);
        }
        setTimeout(() => {
            const lastBotMessage = document.querySelector('.chat-bubble.bot-msg:last-of-type');
            if (lastBotMessage && messageSourcesData) {
                const msgId = lastBotMessage.id || `msg_${Date.now()}`;
                lastBotMessage.id = msgId; // ensure it has an ID
                addSourcesButton(lastBotMessage, messageSourcesData, msgId);
            }
        }, 600);
        setTimeout(() => {
            enhanceCodeBlocks();
            document.querySelectorAll('pre code').forEach(block => {
                if (block.textContent.trim()) {
                    hljs.highlightElement(block);
                }
            });
        }, 500);
        await saveConversation();
    } catch (err) {
        if (isSearchRequested) {
            hideSearchingAnimation();
        } else {
            hideThinkingAnimation();
        }
        console.error('Full Error:', err);
        appendMessage(`Error: ${err.message}`, 'bot-msg error-message');
    } finally {
        if (sendBtn) sendBtn.disabled = false;
        // Reset search button state
       // const searchBtn = document.getElementById('search-btn');
      //  if (searchBtn) {
       //     searchBtn.classList.remove('active');
         //   searchBtn.title = "Enable Web Search";
       // }
    }
}

function initializeUI() {
    const cameraBtn = document.getElementById('camera-btn');
    const micBtn = document.getElementById('mic-btn');
const searchBtn = document.getElementById('search-btn');

const isSearchPersistent = localStorage.getItem('searchPersistent') === 'true';
if (isSearchPersistent) {
    searchBtn.classList.add('active');
    searchBtn.title = "Web Search Enabled - Click to disable";
}

searchBtn.addEventListener('click', function() {
    const isNowActive = !this.classList.contains('active');
    this.classList.toggle('active');
    
    if (isNowActive) {
        this.title = "Web Search Enabled - Click to disable";
        localStorage.setItem('searchPersistent', 'true');
    } else {
        this.title = "Enable Web Search";
        localStorage.setItem('searchPersistent', 'false');
        clearSearchHistory();
    }
    
    console.log("Search button toggled. Active:", isNowActive, "Persistent:", localStorage.getItem('searchPersistent'));
});
    
    if (cameraBtn) {
        cameraBtn.addEventListener('click', openCamera);
    }
    
    if (micBtn) {
        micBtn.addEventListener('click', function() {
            
        });
    }
    
    const sendButton = document.getElementById('sendBtn');
    if (sendButton) {
        sendButton.addEventListener('click', sendMessage);
    }
    
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }
    
    initializeCameraUI();
    setupEventListeners();
}
const userInput = document.getElementById('userInput');
const chatInputArea = document.getElementById('chatInputArea');
function adjustInputHeight() {
    userInput.style.height = 'auto';
    const newHeight = Math.min(Math.max(userInput.scrollHeight, 40), 200);
    userInput.style.height = newHeight + 'px';
    chatInputArea.style.minHeight = (newHeight + 55) + 'px';
    void userInput.offsetHeight;
}
userInput.addEventListener('input', function() {
    adjustInputHeight();
    if (this.value === '') {
        userInput.style.height = '40px';
        chatInputArea.style.minHeight = '95px';
    }
});
userInput.addEventListener('paste', adjustInputHeight);
adjustInputHeight();
userInput.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        const sendBtn = document.getElementById('sendBtn');
        if (!sendBtn.disabled) {
        }
    }
});
function startRotatingInputArea() {
    let angle = 0;
    inputAreaRotationInterval = setInterval(() => {
        angle = (angle + 2) % 360;
        document.getElementById('chatInputArea').style.setProperty('--angle', `${angle}deg`);
    }, 30);
}
function stopRotatingInputArea() {
    if (inputAreaRotationInterval) {
        clearInterval(inputAreaRotationInterval);
        inputAreaRotationInterval = null;
        document.getElementById('chatInputArea').style.removeProperty('--angle');
    }
}


const micBtn = document.getElementById('mic-btn');
let recognition;
try {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
} catch (e) {
    console.error('Speech recognition not supported', e);
    micBtn.style.display = 'none';
}
if (recognition) {
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.lang = 'en-US';
    recognition.onstart = function() {
        micBtn.classList.add('recording');
        userInput.placeholder = "Listening...";
document.getElementById('chatInputArea').classList.add('recording-mode');
startRotatingInputArea();

    recognition.onerror = function(event) {
        console.error('Speech recognition error', event.error);
        micBtn.classList.remove('recording');
        userInput.placeholder = "Ask anything";
        appendMessage('Voice recognition error: ' + event.error, 'bot-msg error-message');
    };
    recognition.onend = function() {
        micBtn.classList.remove('recording');
        userInput.placeholder = "Ask anything";
       document.getElementById('chatInputArea').classList.remove('recording-mode');
      stopRotatingInputArea();
};
    };
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        userInput.value = transcript;
        sendMessage();
    };
    micBtn.addEventListener('click', function() {
        if (micBtn.classList.contains('recording')) {
            recognition.stop();
            return;
        }
        try {
            recognition.start();
        } catch (error) {
            console.error('Error starting recognition:', error);
            appendMessage('Error starting voice recognition. Please ensure microphone permissions are granted.', 'bot-msg error-message');
        }
    });
} else {
    micBtn.style.display = 'none';
}
document.addEventListener('DOMContentLoaded', function() {
    
    initializeAuthPopup();
    setupFileInputListener();
 monitorFileInput();

    const sidebar = document.querySelector('.sidebar');
    const dragHandle = document.querySelector('.drag-handle');
    const overlay = document.querySelector('.overlay');
    const menuBtn = document.getElementById('menu-btn');
    let isDragging = false;
    let startX = 0;
    let currentX = 0;
    let isOpen = false;
    let startTime = 0;
    let velocity = 0;
    menuBtn.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', closeSidebar);
    document.addEventListener('mousedown', (e) => {
        if (isOpen) return;
        if (e.clientX < 50) {
            startDrag(e.clientX);
            e.preventDefault();
        }
    });
    document.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        handleDrag(e.clientX);
        e.preventDefault();
    });
    document.addEventListener('mouseup', (e) => {
        if (!isDragging) return;
        endDrag();
        e.preventDefault();
    });
    document.addEventListener('touchstart', (e) => {
        if (isOpen) {
            startDrag(e.touches[0].clientX);
            return;
        }
        if (e.touches[0].clientX < 25) {
            startDrag(e.touches[0].clientX);
        }
    }, { passive: true });
    document.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        handleDrag(e.touches[0].clientX);
        e.preventDefault();
    }, { passive: false });
    document.addEventListener('touchend', (e) => {
        if (!isDragging) return;
        endDrag();
    }, { passive: true });
    function startDrag(clientX) {
        isDragging = true;
        startX = clientX;
        currentX = startX;
        startTime = Date.now();
        sidebar.style.transition = 'none';
        overlay.style.transition = 'none';
        if (isOpen) {
            sidebar.style.transform = 'translateX(80vw)';
        } else {
            sidebar.style.transform = 'translateX(0)';
        }
    }
    function handleDrag(clientX) {
        const now = Date.now();
        const timeDelta = now - startTime;
        if (timeDelta > 0) {
            velocity = (clientX - currentX) / timeDelta;
            startTime = now;
        }
        currentX = clientX;
        const diff = currentX - startX;
        if (isOpen) {
            const translateX = Math.min(80, Math.max(0, 80 - (diff * -0.15)));
            sidebar.style.transform = `translateX(${translateX}vw)`;
            overlay.style.opacity = translateX / 80;
        } else {
            const translateX = Math.min(80, Math.max(0, diff / window.innerWidth * 80));
            sidebar.style.transform = `translateX(${translateX}vw)`;
            overlay.style.opacity = translateX / 80;
            overlay.style.visibility = 'visible';
        }
    }
    function endDrag() {
        isDragging = false;
        const diff = currentX - startX;
        const threshold = window.innerWidth * 0.3;
        sidebar.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
        overlay.style.transition = 'opacity 0.3s, visibility 0.3s';
        const velocityThreshold = 0.3;
        const isFastSwipe = Math.abs(velocity) > velocityThreshold;
        if (isOpen) {
            const shouldClose = (diff < -threshold) || (isFastSwipe && velocity < 0);
            if (shouldClose) {
                closeSidebar();
            } else {
                sidebar.style.transform = 'translateX(80vw)';
                overlay.style.opacity = 1;
            }
        } else {
            const shouldOpen = (diff > threshold) || (isFastSwipe && velocity > 0);
            if (shouldOpen) {
                openSidebar();
            } else {
                sidebar.style.transform = 'translateX(0)';
                overlay.style.opacity = 0;
                overlay.style.visibility = 'hidden';
            }
        }
    }
    dragHandle.addEventListener('mousedown', startDrag);
    dragHandle.addEventListener('touchstart', startDrag, { passive: true });
    function toggleSidebar() {
        if (isOpen) {
            closeSidebar();
        } else {
            openSidebar();
        }
    }
    function openSidebar() {
        sidebar.style.transform = 'translateX(80vw)';
        sidebar.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1)';
        overlay.style.opacity = 1;
        overlay.style.visibility = 'visible';
        overlay.style.transition = 'opacity 0.5s, visibility 0.3s';
        isOpen = true;
    }
    function closeSidebar() {
        sidebar.style.transform = 'translateX(0)';
        sidebar.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.8, 0.25, 1)';
        overlay.style.opacity = 0;
        overlay.style.visibility = 'hidden';
        overlay.style.transition = 'opacity 0.5s, visibility 0.5s';
        isOpen = false;
    }
    overlay.addEventListener('touchstart', (e) => {
        if (!isOpen) return;
        startX = e.touches[0].clientX;
        currentX = startX;
        isDragging = true;
        sidebar.style.transition = 'none';
        overlay.style.transition = 'none';
    }, { passive: true });
    overlay.addEventListener('touchmove', (e) => {
        if (!isDragging || !isOpen) return;
        currentX = e.touches[0].clientX;
        const diff = currentX - startX;
        if (diff < 0) {
            const translateX = Math.max(0, 80 + (diff / window.innerWidth * 80));
            sidebar.style.transform = `translateX(${translateX}vw)`;
            overlay.style.opacity = translateX / 80;
        }
        e.preventDefault();
    }, { passive: false });
    overlay.addEventListener('touchend', () => {
        if (!isDragging || !isOpen) return;
        isDragging = false;
        const diff = currentX - startX;
        const threshold = window.innerWidth * 0.2;
        sidebar.style.transition = 'transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)';
        overlay.style.transition = 'opacity 0.3s';
        if (diff < -threshold) {
            closeSidebar();
        } else {
            sidebar.style.transform = 'translateX(80vw)';
            overlay.style.opacity = 1;
        }
    }, { passive: true });
    sidebar.addEventListener('touchstart', (e) => {
        e.stopPropagation();
    }, { passive: true });
    sidebar.addEventListener('touchmove', (e) => {
        e.stopPropagation();
    }, { passive: false });
});
const themeButton = document.getElementById('theme-button')
const darkTheme = 'dark-theme'
const iconTheme = 'bx-sun'

const selectedTheme = localStorage.getItem('selected-theme')
const selectedIcon = localStorage.getItem('selected-icon')

const getCurrentTheme = () => document.body.classList.contains(darkTheme) ? 'dark' : 'light'
const getCurrentIcon = () => themeButton.classList.contains(iconTheme) ? 'bx-moon' : 'bx-sun'

function switchHighlightJSTheme(isDark) {
    const existingLink = document.querySelector('link[href*="highlight.js"]');
    const newTheme = isDark ?
        'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css' :
        'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-light.min.css';
    
    if (existingLink) {
        existingLink.href = newTheme;
    } else {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = newTheme;
        document.head.appendChild(link);
    }
    
    setTimeout(() => {
        document.querySelectorAll('pre code').forEach(block => {
            if (block.textContent.trim()) {
                hljs.highlightElement(block);
            }
        });
    }, 100);
}

if (selectedTheme) {
    document.body.classList[selectedTheme === 'dark' ? 'add' : 'remove'](darkTheme)
    themeButton.classList[selectedIcon === 'bx-moon' ? 'add' : 'remove'](iconTheme)
    
    switchHighlightJSTheme(selectedTheme === 'dark');
}

themeButton.addEventListener('click', () => {
    document.body.classList.toggle(darkTheme)
    themeButton.classList.toggle(iconTheme)
    
    const isDark = getCurrentTheme() === 'dark';
    
    switchHighlightJSTheme(isDark);
    
    localStorage.setItem('selected-theme', getCurrentTheme())
    localStorage.setItem('selected-icon', getCurrentIcon())
})

document.addEventListener('DOMContentLoaded', function() {
    const isDark = getCurrentTheme() === 'dark';
    switchHighlightJSTheme(isDark);
});

function showNotification(message) {
  const notification = document.createElement('div');
  notification.classList.add('notification');
  notification.innerText = message;
  document.body.appendChild(notification);
  setTimeout(() => {
    notification.classList.add('hide');
  }, 1500);
  setTimeout(() => {
    notification.remove();
  }, 2500);
}

function initializeCameraUI() {
    cameraModal = document.createElement('div');
    cameraModal.className = 'camera-modal';
    cameraModal.style.display = 'none';
    document.body.appendChild(cameraModal);
    
    viewfinder = document.createElement('div');
    viewfinder.className = 'camera-viewfinder';
    videoElement = document.createElement('video');
    videoElement.autoplay = true;
    
    captureSpinner = document.createElement('div');
    captureSpinner.className = 'capture-spinner';
    captureSpinner.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    viewfinder.appendChild(videoElement);
    viewfinder.appendChild(captureSpinner);
    
    const controlsWrapper = document.createElement('div');
    controlsWrapper.className = 'controls-wrapper';
    
    cancelBtn = document.createElement('button');
    cancelBtn.className = 'camera-btn camera-cancel-btn';
    cancelBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" height="30px" viewBox="0 -960 960 960" width="30px" fill="var(--basic-reverse-color)"><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg>';
    
    const toggleBtn = document.createElement('button');
    toggleBtn.className = 'camera-toggle-btn';
    toggleBtn.id = 'camera-toggle-btn';
    toggleBtn.innerHTML = '<svg width="23px" height="23px" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"> <path fill="var(--basic-reverse-color)" d="M14.9547098,7.98576084 L15.0711,7.99552 C15.6179,8.07328 15.9981,8.57957 15.9204,9.12636 C15.6826,10.7983 14.9218,12.3522 13.747,13.5654 C12.5721,14.7785 11.0435,15.5888 9.37999,15.8801 C7.7165,16.1714 6.00349,15.9288 4.48631,15.187 C3.77335,14.8385 3.12082,14.3881 2.5472,13.8537 L1.70711,14.6938 C1.07714,15.3238 3.55271368e-15,14.8776 3.55271368e-15,13.9867 L3.55271368e-15,9.99998 L3.98673,9.99998 C4.87763,9.99998 5.3238,11.0771 4.69383,11.7071 L3.9626,12.4383 C4.38006,12.8181 4.85153,13.1394 5.36475,13.3903 C6.50264,13.9466 7.78739,14.1285 9.03501,13.9101 C10.2826,13.6916 11.4291,13.0839 12.3102,12.174 C13.1914,11.2641 13.762,10.0988 13.9403,8.84476 C14.0181,8.29798 14.5244,7.91776 15.0711,7.99552 L14.9547098,7.98576084 Z M11.5137,0.812976 C12.2279,1.16215 12.8814,1.61349 13.4558,2.14905 L14.2929,1.31193 C14.9229,0.681961 16,1.12813 16,2.01904 L16,6.00001 L12.019,6.00001 C11.1281,6.00001 10.6819,4.92287 11.3119,4.29291 L12.0404,3.56441 C11.6222,3.18346 11.1497,2.86125 10.6353,2.60973 C9.49736,2.05342 8.21261,1.87146 6.96499,2.08994 C5.71737,2.30841 4.57089,2.91611 3.68976,3.82599 C2.80862,4.73586 2.23802,5.90125 2.05969,7.15524 C1.98193,7.70202 1.47564,8.08224 0.928858,8.00448 C0.382075,7.92672 0.00185585,7.42043 0.0796146,6.87364 C0.31739,5.20166 1.07818,3.64782 2.25303,2.43465 C3.42788,1.22148 4.95652,0.411217 6.62001,0.119916 C8.2835,-0.171384 9.99651,0.0712178 11.5137,0.812976 Z" /></svg>';
    toggleBtn.title = 'Switch Camera';
    
    captureBtn = document.createElement('button');
    captureBtn.className = 'camera-btn camera-capture-btn';
    captureBtn.innerHTML = '<i class="fas fa-camera"></i>';
    captureBtn.disabled = true;
    
    controlsWrapper.appendChild(cancelBtn);
    controlsWrapper.appendChild(toggleBtn);
    
    cameraModal.appendChild(viewfinder);
    cameraModal.appendChild(controlsWrapper);
    cameraModal.appendChild(captureBtn);
    
    toggleBtn.addEventListener('click', toggleCamera);
    cancelBtn.addEventListener('click', closeCamera);
    captureBtn.addEventListener('click', captureImage);
}


async function toggleCamera() {
    const currentMode = localStorage.getItem('nurvleCameraPreference') || 'environment';
    const newMode = currentMode === 'environment' ? 'user' : 'environment';
    
    localStorage.setItem('nurvleCameraPreference', newMode);
    
    const toggleBtn = document.getElementById('camera-toggle-btn');
    if (toggleBtn) {
        if (newMode === 'environment') {
            toggleBtn.innerHTML = '<i class="fas fa-camera-retro"></i>';
            toggleBtn.title = 'Switch to Front Camera';
        } else {
            toggleBtn.innerHTML = '<i class="fas fa-user"></i>';
            toggleBtn.title = 'Switch to Back Camera';
        }
    }
    
    await restartCameraWithPreference(newMode);
}

async function restartCameraWithPreference(facingMode) {
    if (cameraStream) {
        const tracks = cameraStream.getTracks();
        tracks.forEach(track => track.stop());
    }
    cameraStream = null;
    videoElement.srcObject = null;
    captureBtn.disabled = true;
    captureSpinner.style.display = 'block';
    
    await openCameraWithMode(facingMode);
}
function updateCameraButtonStates(frontBtn, rearBtn, activeMode) {
    if (activeMode === 'user') {
        frontBtn.style.backgroundColor = '#4CAF50';
        frontBtn.style.color = 'white';
        rearBtn.style.backgroundColor = 'transparent';
        rearBtn.style.color = 'white';
    } else {
        rearBtn.style.backgroundColor = '#4CAF50';
        rearBtn.style.color = 'white';
        frontBtn.style.backgroundColor = 'transparent';
        frontBtn.style.color = 'white';
    }
}

async function restartCameraWithPreference(facingMode) {
    if (cameraStream) {
        const tracks = cameraStream.getTracks();
        tracks.forEach(track => track.stop());
    }
    cameraStream = null;
    videoElement.srcObject = null;
    captureBtn.disabled = true;
    captureSpinner.style.display = 'block';
    await openCameraWithMode(facingMode);
}

async function openCamera() {
    const preferredMode = localStorage.getItem('nurvleCameraPreference') || 'environment';
    await openCameraWithMode(preferredMode);
}
async function openCameraWithMode(facingMode) {
    const baseConstraints = {
        video: {
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            facingMode: { ideal: facingMode }
        }
    };
    
    const fallbackConstraints = {
        video: {
            width: { ideal: 1280 },
            height: { ideal: 720 }
        }
    };
    
    try {
        console.log(`Attempting to access camera with facingMode: ${facingMode}`);
        cameraStream = await navigator.mediaDevices.getUserMedia(baseConstraints);
        console.log("Camera accessed successfully.");
    } catch (primaryError) {
        console.warn(`Could not access camera with facingMode '${facingMode}':`, primaryError);
        try {
            console.log("Attempting to access any available camera...");
            cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
            console.log("Fallback camera accessed successfully.");
        } catch (fallbackError) {
            console.error("Error accessing any camera:", fallbackError);
            closeCamera();
            alert("Could not access the camera. Please ensure permissions are granted.");
            return;
        }
    }
    
    if (cameraStream) {
        videoElement.srcObject = cameraStream;
        videoElement.onloadedmetadata = () => {
            captureBtn.disabled = false;
            captureSpinner.style.display = 'none';
        };
        cameraModal.style.display = 'flex';
        capturedBlob = null;
        
        const toggleBtn = document.getElementById('camera-toggle-btn');
        if (toggleBtn) {
            if (facingMode === 'environment') {
                toggleBtn.innerHTML = '<i class="fas fa-camera-retro"></i>';
                toggleBtn.title = 'Switch to Front Camera';
            } else {
                toggleBtn.innerHTML = '<i class="fas fa-user"></i>';
                toggleBtn.title = 'Switch to Back Camera';
            }
        }
    }
}

function closeCamera() {
    cameraModal.style.display = 'none';
    if (cameraStream) {
        const tracks = cameraStream.getTracks();
        tracks.forEach(track => track.stop());
        cameraStream = null;
    }
    videoElement.srcObject = null;
    capturedBlob = null;
}

async function captureImage() {
    if (cameraStream) {
        captureSpinner.style.display = 'block';
        const canvas = document.createElement('canvas');
        const videoTrack = cameraStream.getVideoTracks()[0];
        const settings = videoTrack.getSettings();
        canvas.width = settings.width;
        canvas.height = settings.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        canvas.toBlob(async (blob) => {
            captureSpinner.style.display = 'none';
            if (blob) {
                try {
                    const fileName = `camera_capture_${Date.now()}.jpg`;
                    const capturedFile = new File([blob], fileName, { type: 'image/jpeg' });

                    const fileInfo = {
                        file: capturedFile,
                        id: `temp_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                        name: capturedFile.name,
                        type: capturedFile.type,
                        size: capturedFile.size,
                        fileId: null 
                    };
                    
                    selectedFiles.push(fileInfo);
                  
                    updatePreview();
                    closeCamera();
                    
                    const sendBtn = document.getElementById('sendBtn');
                    const userInput = document.getElementById('userInput');
                    if (sendBtn) {
                        sendBtn.disabled = userInput.value.trim() === '' && selectedFiles.length === 0;
                    }
                    
                    
                } catch (error) {
                    console.error("Error processing captured image:", error);
                    alert("Failed to process the captured image. Please try again.");
                    closeCamera();
                }
            } else {
                console.error("Failed to capture image blob.");
                alert("Failed to capture the image. Please try again.");
                closeCamera();
            }
        }, 'image/jpeg', 0.9);
    }
}

function showConfirmationPreview(blob) {
    viewfinder.innerHTML = '';
    const imgPreview = document.createElement('img');
    imgPreview.src = URL.createObjectURL(blob);
    imgPreview.className = 'confirmation-preview';
    viewfinder.appendChild(imgPreview);

    controls.innerHTML = '';
    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'camera-btn camera-capture-btn';
    confirmBtn.innerHTML = '<i class="fas fa-check"></i> Send';

    const retakeBtn = document.createElement('button');
    retakeBtn.className = 'camera-btn camera-cancel-btn';
    retakeBtn.innerHTML = '<i class="fas fa-redo"></i> Retake';

    confirmBtn.addEventListener('click', () => {
        if (capturedBlob) {
            const fileName = `camera_capture_${Date.now()}.jpg`;
            const capturedFile = new File([capturedBlob], fileName, { type: 'image/jpeg' });

            const fileInfo = {
                file: capturedFile,
                id: `temp_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`, 
                name: capturedFile.name,
                type: capturedFile.type,
                size: capturedFile.size,
                fileId: null
            };

            selectedFiles.push(fileInfo);

            updatePreview();

            closeCamera();

            const sendBtn = document.getElementById('sendBtn');
            const userInput = document.getElementById('userInput');
            sendBtn.disabled = userInput.value.trim() === '' && selectedFiles.length === 0;
             if (selectedFiles.length > 0) {
                  sendMessage();
             }
        }
    });
    retakeBtn.addEventListener('click', () => {
        openCamera();
    });
    controls.appendChild(confirmBtn);
    controls.appendChild(retakeBtn);
}

function handlePasteEvent(e) {
    if (e.clipboardData && e.clipboardData.items) {
        const items = e.clipboardData.items;
        
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const blob = items[i].getAsFile();
                const fileName = `pasted_image_${Date.now()}.png`;
                
                const pastedFile = new File([blob], fileName, { type: 'image/png' });
                
                const fileInfo = {
                    file: pastedFile,
                    id: `temp_${Date.now()}_${Math.random().toString(36).substring(2, 9)}`,
                    name: pastedFile.name,
                    type: pastedFile.type,
                    size: pastedFile.size,
                    fileId: null
                };
                
                selectedFiles.push(fileInfo);
                
                updatePreview();
                
                const sendBtn = document.getElementById('sendBtn');
                const userInput = document.getElementById('userInput');
                if (sendBtn) {
                    sendBtn.disabled = userInput.value.trim() === '' && selectedFiles.length === 0;
                }
                
                e.preventDefault();
                break;
            }
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    const donateBtn = document.getElementById('donate-btn');
    const paymentModal = document.getElementById('paymentModal');
    const closePaymentModal = document.getElementById('closePaymentModal');
    const copyAddressBtns = document.querySelectorAll('.copy-address-btn');
    
    if (donateBtn) {
        donateBtn.addEventListener('click', function() {
            paymentModal.style.display = 'flex';
        });
    }
    
    if (closePaymentModal) {
        closePaymentModal.addEventListener('click', function() {
            paymentModal.style.display = 'none';
        });
    }
    
    if (paymentModal) {
        paymentModal.addEventListener('click', function(e) {
            if (e.target === paymentModal) {
                paymentModal.style.display = 'none';
            }
        });
    }
    
    if (copyAddressBtns) {
        copyAddressBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const address = this.getAttribute('data-address');
                navigator.clipboard.writeText(address).then(() => {
                    const originalHTML = this.innerHTML;
                    this.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                    this.classList.add('copied');
                    
                    setTimeout(() => {
                        this.innerHTML = originalHTML;
                        this.classList.remove('copied');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('Failed to copy address. Please try again.');
                });
            });
        });
    }
});

</script>
</body>
</html>
